<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEED EVENT+ | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js" defer></script>
    <script>
        window.onerror = function (msg, url, line) {
            // Filter out generic script errors (CORS/CDN/Network issues)
            if (String(msg).indexOf('Script error') > -1 || (line === 0)) {
                console.warn("Ext. Script Error:", url);
                return true; // Suppress
            }
            console.error("ç³»çµ±éŒ¯èª¤:", msg, url, line);
            // Only alert if it's not a known benign error
            if (String(msg).includes('ResizeObserver')) return true;

            // alert("ç³»çµ±éŒ¯èª¤: " + msg); // Optional: keep enabled for dev, disabled for prod if annoying
            return false;
        };
    </script>
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- Animations -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Outfit', sans-serif;
            background: #f8fafc;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .active-tab {
            border-bottom: 2px solid #0f172a;
            color: #0f172a;
            font-weight: 600;
        }

        .tab-btn {
            transition: all 0.3s ease;
        }

        .card-hover {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body class="bg-gray-100 font-sans h-screen flex flex-col">
    <!-- Global Loading Overlay -->
    <div id="main-loading-overlay"
        class="fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center z-[100] hidden">
        <div class="bg-white p-8 rounded-2xl flex flex-col items-center animate__animated animate__fadeIn">
            <i class="fas fa-circle-notch fa-spin text-4xl text-blue-600 mb-4"></i>
            <h3 class="text-lg font-bold text-slate-700">è¼‰å…¥ä¸­... Please wait</h3>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen"
        class="fixed inset-0 bg-slate-900 flex items-center justify-center z-50 animate__animated animate__fadeIn">
        <div
            class="bg-white p-10 rounded-2xl shadow-2xl w-96 transform transition-all animate__animated animate__zoomIn">
            <h2 class="text-3xl font-bold mb-2 text-center text-slate-800 tracking-tight">SEED EVENT+</h2>
            <p class="text-center text-gray-500 mb-8 text-sm">Admin Access</p>
            <form id="login-form" class="space-y-4" onsubmit="handleLogin(event)">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">å¸³è™Ÿ Username</label>
                    <input type="text" id="username" required placeholder="admin"
                        class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">å¯†ç¢¼ Password</label>
                    <input type="password" id="password" required placeholder="admin123"
                        class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>

                <!-- Debug / API Config -->
                <div class="pt-2">
                    <button type="button" onclick="document.getElementById('api-config-box').classList.toggle('hidden')"
                        class="text-xs text-slate-400 hover:text-blue-500 underline">
                        é€²éšé€£ç·šè¨­å®š (API Config)
                    </button>
                    <div id="api-config-box" class="hidden mt-2 p-3 bg-slate-100 rounded text-xs">
                        <label class="block text-slate-500 mb-1">Backend API URL:</label>
                        <input type="text" id="custom-api-url"
                            class="w-full p-2 border rounded text-slate-600 font-mono text-xs"
                            placeholder="Paste API URL here (https://script.google.com/...)"
                            onchange="if(this.value) window.API_URL = this.value; console.log('API URL Updated:', window.API_URL)">
                        <div class="mt-2 text-slate-400">è‹¥ config.js è¼‰å…¥å¤±æ•—ï¼Œæˆ–æ˜¯çœ‹åˆ° Script Errorï¼Œè«‹æ‰‹å‹•è²¼ä¸Šç¶²å€ã€‚</div>
                    </div>
                </div>

                <button type="submit"
                    class="w-full bg-slate-900 text-white py-3 rounded-lg font-bold hover:bg-black transition-all transform active:scale-95 shadow-lg hover:shadow-xl">
                    ç™»å…¥ç³»çµ± Login
                </button>
            </form>
            <p class="mt-4 text-xs text-center text-gray-400">é è¨­: admin / admin123</p>
            <p class="mt-2 text-xs text-center text-slate-300 font-mono opacity-50">v1.2.0</p>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="dashboard" class="flex-1 flex flex-col hidden">
        <!-- Top Navigation -->
        <header class="bg-white/90 backdrop-blur shadow-sm z-10 sticky top-0 animate__animated animate__slideInDown">
            <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight">SEED EVENT+ <span id="user-role-display"
                        class="text-blue-600 text-sm bg-blue-50 px-2 py-1 rounded-full ml-2 font-normal align-middle"></span>
                </h1>
                <div class="flex items-center space-x-6">
                    <span id="user-name-display" class="text-sm font-medium text-slate-600"></span>
                    <button onclick="logout()"
                        class="text-sm text-red-500 hover:text-red-700 font-medium transition-colors">ç™»å‡º Logout</button>
                </div>
            </div>
            <div class="max-w-7xl mx-auto px-6 flex justify-end pb-4">
                <button onclick="repairDatabase()" class="text-xs text-blue-600 hover:text-blue-800 underline">ä¿®å¾©è³‡æ–™åº«æ¬„ä½
                    (Repair DB)</button>
            </div>
            <!-- Tabs -->
            <div class="max-w-7xl mx-auto px-6 flex space-x-8 border-t border-gray-100">
                <button onclick="switchTab('events')" id="tab-events"
                    class="tab-btn py-4 text-sm font-medium text-gray-400 hover:text-slate-800 active-tab">æ´»å‹•åˆ—è¡¨</button>
                <button onclick="switchTab('create-event')" id="tab-create-event"
                    class="tab-btn py-4 text-sm font-medium text-gray-400 hover:text-slate-800">å»ºç«‹æ´»å‹•</button>
                <button onclick="switchTab('users')" id="tab-users"
                    class="tab-btn py-4 text-sm font-medium text-gray-400 hover:text-slate-800">å¸³è™Ÿ Users</button>
                <button onclick="switchTab('scanner')" id="tab-scanner"
                    class="tab-btn py-4 text-sm font-medium text-gray-400 hover:text-slate-800">QR æƒæ</button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-auto bg-gray-100 p-6">

            <!-- Overview View Removed -->
            <div id="view-overview" class="hidden"></div>

            <!-- Create Event View -->
            <div id="view-create-event" class="max-w-7xl mx-auto space-y-8 hidden animate__animated animate__fadeIn">
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-xl font-bold mb-6 text-slate-800">å»ºç«‹æ–°æ´»å‹•</h3>
                    <form id="create-event-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-400 uppercase">æ´»å‹•åç¨±</label>
                            <input type="text" id="evt-name" required
                                class="w-full p-3 bg-slate-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-400 uppercase">æ—¥æœŸ</label>
                            <input type="date" id="evt-date" required
                                class="w-full p-3 bg-slate-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-400 uppercase">åœ°é»</label>
                            <input type="text" id="evt-loc" required
                                class="w-full p-3 bg-slate-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-400 uppercase">åƒ¹æ ¼</label>
                            <input type="number" id="evt-price" required
                                class="w-full p-3 bg-slate-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>
                        <div class="md:col-span-2 space-y-1">
                            <label class="text-xs font-bold text-slate-400 uppercase">æ´»å‹•åœ–ç‰‡ (Image URL)</label>
                            <input type="url" id="evt-image-url" placeholder="https://example.com/banner.jpg"
                                class="w-full p-3 bg-slate-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>
                        <div class="md:col-span-2 space-y-1">
                            <label class="text-xs font-bold text-slate-400 uppercase">æè¿° (æ”¯æ´ HTML)</label>
                            <textarea id="evt-desc"
                                class="w-full p-3 bg-slate-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all font-mono text-sm"
                                rows="5" placeholder="å¯è¼¸å…¥ HTML æ¨™ç±¤æˆ–æ˜¯ç´”æ–‡å­—"></textarea>
                        </div>
                        <div class="md:col-span-2 flex space-x-6 pt-2">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="evt-enable-qr" class="sr-only peer" checked>
                                <div
                                    class="relative w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                </div>
                                <span class="ms-3 text-sm font-medium text-slate-700">é¡¯ç¤º QR Code</span>
                            </label>

                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="evt-enable-checkin" class="sr-only peer">
                                <div
                                    class="relative w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600">
                                </div>
                                <span class="ms-3 text-sm font-medium text-slate-700">é–‹æ”¾å ±åˆ° (Check-in)</span>
                            </label>
                        </div>

                        <!-- Custom Fields Builder (Professional) -->
                        <div class="md:col-span-2 p-6 rounded-xl bg-slate-50 border border-slate-200">
                            <h4 class="font-bold mb-4 text-slate-800 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4">
                                    </path>
                                </svg>
                                è‡ªè¨‚å ±åè¡¨å–®æ¬„ä½ (Custom Form Fields)
                            </h4>

                            <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm mb-4">
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 mb-3">
                                    <div class="md:col-span-3">
                                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">æ¬„ä½åç¨±
                                            Label</label>
                                        <input type="text" id="new-field-label" placeholder="ä¾‹å¦‚: ç”¨é¤ç¿’æ…£"
                                            class="w-full p-2 bg-slate-50 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    </div>
                                    <div class="md:col-span-3">
                                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">é¡å‹
                                            Type</label>
                                        <select id="new-field-type" onchange="toggleFieldOptions()"
                                            class="w-full p-2 bg-slate-50 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                            <option value="text">å–®è¡Œæ–‡å­— (Text)</option>
                                            <option value="textarea">å¤šè¡Œæ–‡å­— (Textarea)</option>
                                            <option value="select">ä¸‹æ‹‰é¸å–® (Select)</option>
                                            <option value="date">æ—¥æœŸ (Date)</option>
                                            <option value="email">Email</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-4">
                                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">é¸é … Options
                                            (ä»¥é€—è™Ÿåˆ†éš”)</label>
                                        <input type="text" id="new-field-options" placeholder="è‘·, ç´ , ä¸åƒç‰›" disabled
                                            class="w-full p-2 bg-slate-100 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none disabled:text-slate-300">
                                    </div>
                                    <div class="md:col-span-2 flex items-end">
                                        <div class="flex items-center h-10 pt-4">
                                            <label class="inline-flex items-center cursor-pointer">
                                                <input type="checkbox" id="new-field-required" class="sr-only peer">
                                                <div
                                                    class="relative w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-500">
                                                </div>
                                                <span class="ms-3 text-sm font-medium text-slate-600">å¿…å¡«
                                                    (Required)</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" onclick="addCustomField()"
                                    class="w-full py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition-colors text-sm font-bold flex items-center justify-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    æ–°å¢æ¬„ä½ Add Field
                                </button>
                            </div>

                            <div class="space-y-2">
                                <label class="block text-xs font-bold text-slate-400 uppercase">ç›®å‰æ¬„ä½é è¦½</label>
                                <ul id="custom-fields-list" class="space-y-2">
                                    <!-- Dynamic Fields -->
                                    <li
                                        class="empty-state text-sm text-slate-400 text-center py-4 bg-slate-100 rounded-lg border border-dashed border-slate-300">
                                        å°šæœªæ–°å¢ä»»ä½•è‡ªè¨‚æ¬„ä½
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <button type="submit"
                            class="bg-blue-600 text-white py-4 px-6 rounded-xl md:col-span-2 hover:bg-blue-700 font-bold tracking-wide shadow-lg shadow-blue-200 transition-all transform hover:-translate-y-1">
                            å»ºç«‹æ´»å‹• Create Event
                        </button>
                    </form>
                </div>
            </div>

            <!-- Event List View -->
            <div id="view-events" class="max-w-7xl mx-auto space-y-8 hidden animate__animated animate__fadeIn">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-6 border-b border-slate-100">
                        <h3 class="text-xl font-bold text-slate-800">æ´»å‹•åˆ—è¡¨</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-100">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                        åç¨±</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                        æ—¥æœŸ</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                        ç‹€æ…‹</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                        æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="events-list-body" class="bg-white divide-y divide-gray-200">
                                <!-- Events Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="view-users" class="max-w-7xl mx-auto space-y-6 hidden">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-bold mb-4">æ–°å¢å¸³è™Ÿ</h3>
                    <form id="create-user-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="new-u-username" placeholder="å¸³è™Ÿ (Username)" required
                            class="p-2 border rounded">
                        <input type="text" id="new-u-password" placeholder="å¯†ç¢¼ (Password)" required
                            class="p-2 border rounded">
                        <input type="text" id="new-u-name" placeholder="å§“å (Name)" required class="p-2 border rounded">
                        <select id="new-u-role" class="p-2 border rounded" required>
                            <option value="System Admin">ç³»çµ±ç®¡ç†å“¡ (System Admin)</option>
                            <option value="Finance Officer">è²¡å‹™äººå“¡ (Finance Officer)</option>
                        </select>
                        <button type="submit"
                            class="bg-blue-600 text-white py-2 px-4 rounded md:col-span-2 hover:bg-blue-700">å»ºç«‹å¸³è™Ÿ</button>
                    </form>
                </div>
            </div>

            <!-- Scanner View -->
            <div id="view-scanner" class="max-w-md mx-auto hidden animate__animated animate__fadeIn">
                <div
                    class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 text-center relative overflow-hidden">
                    <h3 class="text-xl font-bold mb-6 text-slate-800">QR Code æƒæå™¨</h3>

                    <div id="main-scanner-overlay"
                        class="absolute inset-0 flex flex-col items-center justify-center bg-white/90 z-20">
                        <i class="fas fa-camera text-slate-400 text-5xl mb-4"></i>
                        <button onclick="startScanner()"
                            class="bg-blue-600 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:bg-blue-700 transition transform hover:scale-105 active:scale-95 flex items-center">
                            <i class="fas fa-power-off mr-2"></i> å•Ÿå‹•ç›¸æ©Ÿ
                        </button>
                    </div>

                    <button onclick="stopScanner()" id="btn-stop-main-scanner"
                        class="absolute top-4 right-4 bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs hidden z-30 hover:bg-red-200">
                        é—œé–‰
                    </button>

                    <div id="reader"
                        class="mx-auto border-2 border-slate-100 rounded-lg overflow-hidden mb-6 min-h-[300px] bg-black">
                    </div>
                    <p id="scan-result" class="text-sm font-medium text-slate-500 min-h-[20px]"></p>
                </div>
            </div>

        </main>
    </div>

    <!-- Create User Modal -->
    <div id="create-user-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl p-8 max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold mb-4 text-slate-800">æ–°å¢å¸³è™Ÿ</h3>
            <form id="create-user-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">ä½¿ç”¨è€…åç¨±</label>
                    <input type="text" id="new-u-username" required
                        class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">å¯†ç¢¼</label>
                    <input type="password" id="new-u-password" required
                        class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">å§“å (é¡¯ç¤ºç”¨)</label>
                    <input type="text" id="new-u-name" required
                        class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">æ¬Šé™è§’è‰²</label>
                    <select id="new-u-role" class="w-full p-2 border border-slate-200 rounded-lg outline-none">
                        <option value="Admin">ç³»çµ±ç®¡ç†å“¡ (Admin)</option>
                        <option value="Staff">å·¥ä½œäººå“¡ (Staff)</option>
                    </select>
                </div>
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('create-user-modal').classList.add('hidden')"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-50 rounded-lg">å–æ¶ˆ</button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm btn-loading">å»ºç«‹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Event Manager Modal -->
    <div id="event-manager-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-7xl h-[95vh] flex flex-col m-4 overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-gray-100 px-6 py-4 flex justify-between items-center border-b">
                <h3 class="text-xl font-bold text-gray-800" id="modal-event-title">æ´»å‹•ç®¡ç†</h3>
                <button onclick="closeEventManager()"
                    class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>

            <!-- Modal Tabs -->
            <div class="bg-white border-b px-6 flex space-x-6">
                <button onclick="switchModalTab('info')" id="mtab-info"
                    class="py-3 text-sm font-medium border-b-2 border-blue-600 text-blue-600 transition-colors">åŸºæœ¬è³‡è¨Š</button>
                <button onclick="switchModalTab('regs')" id="mtab-regs"
                    class="py-3 text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors">å ±ååå–®</button>
                <button onclick="switchModalTab('checkin')" id="mtab-checkin"
                    class="py-3 text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors flex items-center">
                    <span>å ±åˆ°ç®¡ç† (Console)</span>
                    <span class="ml-2 bg-slate-100 text-slate-600 text-xs px-2 py-0.5 rounded-full"
                        id="tab-checkin-badge">Live</span>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="flex-1 overflow-auto p-6 bg-gray-50">

                <!-- Info Tab -->
                <div id="mview-info">
                    <form id="edit-event-form" class="space-y-4 max-w-7xl mx-auto bg-white p-6 rounded shadow">
                        <input type="hidden" id="edit-evt-id">
                        <h4 class="font-bold text-gray-700 text-lg mb-4">ç·¨è¼¯æ´»å‹•è³‡è¨Š</h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">åç¨±</label>
                            <input type="text" id="edit-evt-name" required class="w-full mt-1 p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">æ—¥æœŸ</label>
                            <input type="date" id="edit-evt-date" required class="w-full mt-1 p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">åœ°é»</label>
                            <input type="text" id="edit-evt-loc" required class="w-full mt-1 p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">åƒ¹æ ¼</label>
                            <input type="number" id="edit-evt-price" required class="w-full mt-1 p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">æ´»å‹•åœ–ç‰‡ (Image URL)</label>
                            <input type="url" id="edit-evt-image-url" class="w-full mt-1 p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">æè¿° (HTML)</label>
                            <textarea id="edit-evt-desc" class="w-full mt-1 p-2 border rounded font-mono text-sm"
                                rows="5"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ç‹€æ…‹</label>
                            <select id="edit-evt-status" class="w-full mt-1 p-2 border rounded">
                                <option value="Closed">åœæ­¢å ±å (Closed)</option>
                            </select>
                        </div>
                        <div class="flex space-x-6 pt-2">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="edit-evt-enable-qr" class="sr-only peer">
                                <div
                                    class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                </div>
                                <span class="ms-3 text-sm font-medium text-gray-700">é¡¯ç¤º QR Code</span>
                            </label>

                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="edit-evt-enable-checkin" class="sr-only peer">
                                <div
                                    class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600">
                                </div>
                                <span class="ms-3 text-sm font-medium text-gray-700">é–‹æ”¾å ±åˆ° (Check-in)</span>
                            </label>
                        </div>
                        <div class="pt-4 flex justify-end">
                            <button type="submit"
                                class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">å„²å­˜è®Šæ›´</button>
                        </div>
                    </form>
                </div>

                <!-- Registrations Tab -->
                <div id="mview-regs" class="hidden space-y-4">
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-600">
                            å·²å ±å: <span id="reg-count-total" class="font-bold text-gray-900">-</span> |
                            å·²ä»˜æ¬¾: <span id="reg-count-paid" class="font-bold text-green-600">-</span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="loadModalRegistrations()"
                                class="bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-300">é‡æ–°æ•´ç†</button>
                            <button onclick="downloadCSV()"
                                class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">åŒ¯å‡º CSV
                                (Export)</button>
                        </div>
                    </div>

                    <!-- Registration Management List -->
                    <div id="event-registrations-section">
                        <div class="overflow-x-auto rounded-lg border border-slate-100">
                            <table class="min-w-full divide-y divide-slate-100" id="registrations-table">
                                <thead class="bg-slate-50" id="registrations-table-head">
                                    <!-- Dynamic Header injected here -->
                                </thead>
                                <tbody id="registrations-list-body" class="bg-white divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Check-in Console Tab (New) -->
            <div id="mview-checkin" class="hidden h-full flex flex-col">
                <!-- Stats Dashboard (Live) -->
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <div class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1">ç¸½å ±å</div>
                        <div class="text-3xl font-black text-slate-800" id="console-total">-</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-green-100 bg-green-50 shadow-sm">
                        <div class="text-xs text-green-600 uppercase font-bold tracking-wider mb-1">å·²å ±åˆ°</div>
                        <div class="text-3xl font-black text-green-600" id="console-checked-in">-</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-orange-100 bg-orange-50 shadow-sm">
                        <div class="text-xs text-orange-600 uppercase font-bold tracking-wider mb-1">æœªå ±åˆ°</div>
                        <div class="text-3xl font-black text-orange-600" id="console-unchecked">-</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-blue-100 bg-blue-50 shadow-sm">
                        <div class="text-xs text-blue-600 uppercase font-bold tracking-wider mb-1">å ±åˆ°ç‡</div>
                        <div class="text-3xl font-black text-blue-600" id="console-rate">0%</div>
                    </div>
                </div>

                <!-- Scanner & Manual Check-in Area -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1 min-h-0">
                    <!-- Left: Scanner -->
                    <div
                        class="bg-black rounded-2xl overflow-hidden relative shadow-lg flex flex-col items-center justify-center p-4 min-h-[400px]">

                        <!-- Manual Start Overlay -->
                        <div id="scanner-blocked-overlay"
                            class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 z-20">
                            <i class="fas fa-camera text-slate-700 text-6xl mb-4"></i>
                            <button onclick="startConsoleScanner()"
                                class="bg-blue-600 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:bg-blue-700 transition transform hover:scale-105 active:scale-95 flex items-center">
                                <i class="fas fa-power-off mr-2"></i> å•Ÿå‹•æƒæé¡é ­
                            </button>
                            <p class="text-slate-500 text-xs mt-4">è«‹å…è¨±ç€è¦½å™¨å­˜å–ç›¸æ©Ÿæ¬Šé™</p>
                        </div>

                        <button onclick="stopConsoleScanner()" id="btn-stop-scanner"
                            class="absolute top-4 right-4 bg-red-600/80 text-white px-3 py-1.5 rounded-full text-xs backdrop-blur-md hidden z-30 hover:bg-red-700 transition">
                            <i class="fas fa-stop mr-1"></i> é—œé–‰é¡é ­
                        </button>

                        <div id="console-reader" class="w-full h-full max-h-[500px] bg-black"></div>
                        <div
                            class="absolute top-4 left-4 bg-black/50 text-white px-3 py-1 rounded-full text-xs backdrop-blur-md pointer-events-none">
                            ğŸ“· é¡é ­é‹ä½œä¸­
                        </div>
                        <!-- Scanner Status Overlay -->
                        <div id="console-scan-status"
                            class="absolute inset-0 flex items-center justify-center bg-black/80 hidden z-10">
                            <span class="text-white font-medium animate-pulse">è™•ç†ä¸­...</span>
                        </div>
                    </div>

                    <!-- Right: Recent Activity / Manual -->
                    <div class="flex flex-col space-y-4">
                        <!-- Manual Check-in Box -->
                        <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                            <h4 class="font-bold text-slate-700 mb-2">æ‰‹å‹•å ±åˆ° (Manual Check-in)</h4>
                            <div class="flex space-x-2">
                                <input type="tel" id="manual-checkin-phone" placeholder="è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ (Phone)"
                                    class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                <button onclick="manualCheckIn()"
                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700">
                                    å ±åˆ°
                                </button>
                            </div>
                        </div>

                        <div
                            class="bg-white rounded-2xl border border-slate-200 shadow-sm flex flex-col overflow-hidden flex-1">
                            <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                                <h4 class="font-bold text-slate-700">æœ€è¿‘å‹•æ…‹</h4>
                                <span class="text-xs text-slate-400">å¯¦æ™‚æ›´æ–°</span>
                            </div>
                            <div id="console-activity-log" class="flex-1 overflow-y-auto p-4 space-y-3">
                                <div class="text-center text-slate-400 py-10 text-sm">æš«ç„¡å ±åˆ°ç´€éŒ„</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    </div>

<script>
    let currentUser = null;
    let currentEventId = null;
    let currentEditingEventId = null;
    let currentEventRegistrations = [];
    let allEventsData = [];
    let customFields = [];

    // --- GLOBAL HELPERS ---
    function setLoading(btn, isLoading, loadingText = "è™•ç†ä¸­...") {
        if (isLoading) {
            if (btn) {
                btn.dataset.originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>${loadingText}`;
                btn.classList.add('opacity-75', 'cursor-not-allowed');
            }
        } else {
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = btn.dataset.originalText || 'é€å‡º';
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }
    }

    function showPopup(title, message, type) {
        alert(`${title}: ${message}`);
    }

    function playAudio(type) {
        console.log("Audio:", type);
    }

    // --- LOGIN SYSTEM ---
    async function handleLogin(e) {
        e.preventDefault();
        console.log("handleLogin triggered");

        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const btn = e.target.querySelector('button[type="submit"]');
        const statusDiv = document.getElementById('login-status') || createStatusDiv();

        setLoading(btn, true, "Loading...");
        statusDiv.innerHTML = '<span class="text-blue-500">Connecting...</span>';

        let targetUrl = typeof API_URL !== 'undefined' ? API_URL : '';
        if (!targetUrl && window.API_URL) targetUrl = window.API_URL;
        if (!targetUrl) targetUrl = "https://script.google.com/macros/s/AKfycbzlZcqnngOSiAvH-UnIj48B6p_RzM0nth1JQSY06gcRLfih0RIYYZUYuwIeBgPQAxYG/exec";

        try {
            const response = await fetch(`${targetUrl}?action=checkLogin&username=${u}&password=${p}`);
            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
            const text = await response.text();
            let result = JSON.parse(text);

            if (result.status === 'success') {
                currentUser = result.user;
                statusDiv.innerHTML = '<span class="text-green-500">Success!</span>';
                enterDashboard();
            } else {
                statusDiv.innerHTML = `<span class="text-red-500">Error: ${result.message}</span>`;
                showPopup('ç™»å…¥å¤±æ•—', result.message, 'error');
            }
        } catch (err) {
            console.error("Login Error:", err);
            statusDiv.innerHTML = `<span class="text-red-500">Error: ${err.message}</span>`;
            alert("ç³»çµ±éŒ¯èª¤:\n" + err.message);
        } finally {
            setLoading(btn, false, "Login");
        }
    }

    function createStatusDiv() {
        const div = document.createElement('div');
        div.id = 'login-status';
        div.className = "mt-4 text-sm text-center font-mono p-2 bg-slate-50 rounded border border-slate-200";
        document.getElementById('login-form').appendChild(div);
        return div;
    }

    async function enterDashboard() {
        try {
            document.getElementById('main-loading-overlay').classList.remove('hidden');
            if (!currentUser) throw new Error("User session invalid");

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');

            document.getElementById('user-name-display').innerText = currentUser.name || 'User';
            document.getElementById('user-role-display').innerText = currentUser.role || 'Staff';
            document.getElementById('tab-users').classList.remove('hidden');

            await loadOverview();
            await loadEvents(); // Restore loading events
            playAudio('popup');

        } catch (e) {
            console.error(e);
            alert("è¼‰å…¥ Dashboard å¤±æ•—: " + e.message);
        } finally {
            document.getElementById('main-loading-overlay').classList.add('hidden');
        }
    }

    function logout() { location.reload(); }

    // --- NAVIGATION ---
    function switchView(viewName) {
        ['dashboard', 'create-event', 'accounts'].forEach(v => {
            const el = document.getElementById(`view-${v}`);
            if (el) el.classList.add('hidden');
        });
        const target = document.getElementById(`view-${viewName}`);
        if (target) {
            target.classList.remove('hidden');
            if (viewName === 'accounts') loadUsers();
        }
    }

    function switchTab(tab) {
        ['events', 'create-event', 'users', 'scanner'].forEach(t => {
            const el = document.getElementById(`view-${t}`); // View IDs logic was a bit mixed in original, assuming view-events etc.
            const tabEl = document.getElementById(`tab-${t}`);
            if (tabEl) tabEl.classList.remove('active-tab');
            if (document.getElementById(`view-${t}`)) document.getElementById(`view-${t}`).classList.add('hidden');
        });

        // Mapping tabs to views based on original HTML structure
        // Original HTML has: view-events, view-create-event, view-users, view-scanner
        let viewId = `view-${tab}`;

        if (document.getElementById(viewId)) {
            document.getElementById(viewId).classList.remove('hidden');
        }
        if (document.getElementById(`tab-${tab}`)) {
            document.getElementById(`tab-${tab}`).classList.add('active-tab');
        }

        if (tab === 'events') loadEvents();
        if (tab === 'users') loadUsers();
    }

    // --- OVERVIEW ---
    async function loadOverview() {
        try {
            // Simplified overview for V9
            console.log("Loading Overview...");
        } catch (e) { console.error(e); }
    }

    // --- EVENTS LOGIC ---
    async function loadEvents() {
        const body = document.getElementById('events-list-body');
        if (!body) return;
        body.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center">Loading...</td></tr>';
        try {
            const res = await fetch(`${API_URL}?action=getEvents&includeClosed=true`);
            const json = await res.json();
            if (json.data && json.data.length) {
                allEventsData = json.data;
                body.innerHTML = json.data.map(e => `
                        <tr class="hover:bg-slate-50 transition-colors">
                            <td class="px-6 py-4 font-bold">${e.name}</td>
                            <td class="px-6 py-4 text-sm">${new Date(e.date).toLocaleDateString()}</td>
                            <td class="px-6 py-4">${e.status}</td>
                            <td class="px-6 py-4">
                                <button onclick="openEventManager('${e.event_id}')" class="text-blue-600 hover:text-blue-800">ç®¡ç†</button>
                            </td>
                        </tr>
                    `).join('');
            } else {
                body.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center">ç„¡æ´»å‹•</td></tr>';
            }
        } catch (e) {
            console.error(e);
            body.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error</td></tr>';
        }
    }

    // --- EVENT MANAGER ---
    window.openEventManager = async function (eventId) {
        currentEditingEventId = eventId;
        const modal = document.getElementById('event-manager-modal');
        const eventData = allEventsData.find(e => String(e.event_id) === String(eventId));

        if (!eventData) return alert("Error loading event");

        // Populate Form (Simplified for V9)
        document.getElementById('edit-evt-id').value = eventData.event_id;
        document.getElementById('edit-evt-name').value = eventData.name;

        await loadEventRegistrations(eventId, eventData.form_config);
        modal.classList.remove('hidden');
        switchModalTab('info');
    }

    function closeEventManager() {
        document.getElementById('event-manager-modal').classList.add('hidden');
        currentEditingEventId = null;
    }

    function switchModalTab(tab) {
        ['info', 'regs', 'checkin'].forEach(t => {
            const el = document.getElementById(`mview-${t}`);
            if (el) el.classList.toggle('hidden', t !== tab);
        });
    }

    async function loadEventRegistrations(eventId, formConfig) {
        const tbody = document.getElementById('registrations-list-body');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Loading Regs...</td></tr>';
        try {
            const response = await fetch(`${API_URL}?action=getRegistrations&eventId=${eventId}`);
            const result = await response.json();
            if (result.data) {
                currentEventRegistrations = result.data;
                renderEventParticipants(result.data, []);
            }
        } catch (e) { console.error(e); }
    }

    function renderEventParticipants(regs, fields) {
        const tbody = document.getElementById('registrations-list-body');
        if (!regs.length) { tbody.innerHTML = '<tr><td colspan="5" class="text-center">No Data</td></tr>'; return; }

        tbody.innerHTML = regs.map(r => `
                <tr>
                    <td class="px-6 py-4">${r.participant_name}</td>
                    <td class="px-6 py-4">${r.email}</td>
                    <td class="px-6 py-4">${r.phone || '-'}</td>
                    <td class="px-6 py-4">${r.status}</td>
                    <td class="px-6 py-4">-</td>
                </tr>
            `).join('');
    }

    // --- USERS LOGIC ---
    async function loadUsers() {
        const body = document.getElementById('users-list-body');
        if (!body) return;
        body.innerHTML = '<tr><td>Loading...</td></tr>';
        try {
            const res = await fetch(`${API_URL}?action=getUsers`);
            const json = await res.json();
            if (json.data) {
                body.innerHTML = json.data.map(u => `
                        <tr>
                            <td class="px-6 py-4">${u.username}</td>
                            <td class="px-6 py-4">${u.name}</td>
                            <td class="px-6 py-4">${u.role}</td>
                            <td class="px-6 py-4">Action</td>
                        </tr>
                     `).join('');
            }
        } catch (e) { console.error(e); }
    }

    // --- V9 STUBS (Excluded Features) ---
    function manualCheckIn() { console.log("STUB: manualCheckIn"); }
    function startConsoleScanner() { console.log("STUB: startConsoleScanner"); }
    function stopConsoleScanner() { console.log("STUB: stopConsoleScanner"); }
    function startScanner() { console.log("STUB: startScanner"); }
    function stopScanner() { console.log("STUB: stopScanner"); }
    function updateConsoleStats() { console.log("STUB: updateConsoleStats"); }
    function repairDatabase() { console.log("STUB: repairDatabase"); }
    function logConsoleActivity() { }
    function refreshCurrentEventData() { }

</script>
<script>
    // Diagnostic Script
    (function () {
        const title = document.querySelector('h2');
        if (!title) return;
        const dot = document.createElement('span');
        dot.style.marginLeft = '5px';
        dot.style.fontWeight = 'bold';
        if (typeof handleLogin === 'function') {
            dot.innerText = 'â—';
            dot.style.color = '#22c55e';
        } else {
            dot.innerText = 'â—';
            dot.style.color = '#ef4444';
            const banner = document.createElement('div');
            banner.className = "bg-red-500 text-white p-2 text-center text-xs fixed top-0 w-full z-50";
            banner.innerText = "CRITICAL ERROR: Script Failed.";
            document.body.appendChild(banner);
        }
        title.appendChild(dot);
    })();
</script>
</body>

</html>