<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEED EVENT+ | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js" defer></script>
    <script>
        window.onerror = function (msg, url, line) {
            // Filter out generic script errors (CORS/CDN/Network issues)
            if (String(msg).indexOf('Script error') > -1 || (line === 0)) {
                console.warn("Ext. Script Error:", url);
                return true; // Suppress
            }
            console.error("ç³»çµ±éŒ¯èª¤:", msg, url, line);
            // Only alert if it's not a known benign error
            if (String(msg).includes('ResizeObserver')) return true;

            // alert("ç³»çµ±éŒ¯èª¤: " + msg); // Optional: keep enabled for dev, disabled for prod if annoying
            return false;
        };
    </script>
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Animations -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Outfit', sans-serif;
            background: #f8fafc;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .active-tab {
            border-bottom: 2px solid #0f172a;
            color: #0f172a;
            font-weight: 600;
        }

        .tab-btn {
            transition: all 0.3s ease;
        }

        .card-hover {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }

        /* Global Table Styles (Moved out of mobile-only query) */
        #registrations-table {
            font-size: 0.875rem;
        }

        #registrations-table th,
        #registrations-table td {
            padding: 0.75rem 1rem !important;
            vertical-align: middle;
        }

        #registrations-table thead th {
            position: sticky;
            top: 0;
            z-index: 20;
            /* Increased to ensure it stays above data but below modals */
            background-color: #f8fafc;
            box-shadow: inset 0 -1px 0 #edf2f7;
        }

        /* Phase 16: Mobile Optimization */
        @media (max-width: 768px) {

            /* Filter Panel Mobile */
            #mview-regs .grid {
                grid-template-columns: 1fr !important;
            }

            /* Batch Toolbar Mobile */
            #batch-toolbar .flex {
                flex-direction: column;
                gap: 0.75rem;
            }

            #batch-toolbar button {
                width: 100%;
                justify-content: center;
            }

            /* Quick Filter Buttons */
            .quick-filter-btn {
                font-size: 0.75rem;
                padding: 0.375rem 0.75rem;
            }
        }

        /* Batch Toolbar Animation */
        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate__slideInUp {
            animation: slideInUp 0.3s ease-out;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans h-screen flex flex-col">
    <!-- Global Loading Overlay -->
    <div id="main-loading-overlay"
        class="fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center z-[100] hidden">
        <div class="bg-white p-8 rounded-2xl flex flex-col items-center animate__animated animate__fadeIn">
            <i class="fas fa-circle-notch fa-spin text-4xl text-blue-600 mb-4"></i>
            <h3 class="text-lg font-bold text-slate-700">è¼‰å…¥ä¸­... Please wait</h3>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen"
        class="fixed inset-0 bg-slate-900 flex items-center justify-center z-50 animate__animated animate__fadeIn">
        <div
            class="bg-white p-10 rounded-2xl shadow-2xl w-96 transform transition-all animate__animated animate__zoomIn">
            <h2 class="text-3xl font-bold mb-2 text-center text-slate-800 tracking-tight">SEED EVENT+</h2>
            <p class="text-center text-gray-500 mb-8 text-sm">Admin Access</p>
            <form id="login-form" class="space-y-4" onsubmit="handleLogin(event)">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">å¸³è™Ÿ Username</label>
                    <input type="text" id="username" required placeholder="admin"
                        class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">å¯†ç¢¼ Password</label>
                    <input type="password" id="password" required placeholder="admin123"
                        class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>

                <!-- Debug / API Config -->
                <div class="pt-2">
                    <button type="button" onclick="document.getElementById('api-config-box').classList.toggle('hidden')"
                        class="text-xs text-slate-400 hover:text-blue-500 underline">
                        é€²éšé€£ç·šè¨­å®š (API Config)
                    </button>
                    <div id="api-config-box" class="hidden mt-2 p-3 bg-slate-100 rounded text-xs">
                        <label class="block text-slate-500 mb-1">Backend API URL:</label>
                        <input type="text" id="custom-api-url"
                            class="w-full p-2 border rounded text-slate-600 font-mono text-xs"
                            placeholder="Paste API URL here (https://script.google.com/...)"
                            onchange="if(this.value) { window.API_URL = this.value; if(typeof API_URL !== 'undefined') API_URL = this.value; console.log('API URL Updated:', window.API_URL); }">
                        <div class="mt-2 text-slate-400">è‹¥ config.js è¼‰å…¥å¤±æ•—ï¼Œæˆ–æ˜¯çœ‹åˆ° Script Errorï¼Œè«‹æ‰‹å‹•è²¼ä¸Šç¶²å€ã€‚</div>
                    </div>
                </div>

                <button type="submit"
                    class="w-full bg-slate-900 text-white py-3 rounded-lg font-bold hover:bg-black transition-all transform active:scale-95 shadow-lg hover:shadow-xl">
                    ç™»å…¥ç³»çµ± Login
                </button>
            </form>
            <p class="mt-4 text-xs text-center text-gray-400">é è¨­: admin / admin123</p>
            <p class="mt-2 text-xs text-center text-slate-300 font-mono opacity-50">v1.2.0</p>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="dashboard" class="flex-1 flex flex-col hidden">
        <!-- Top Navigation -->
        <header class="bg-white/90 backdrop-blur shadow-sm z-30 sticky top-0 animate__animated animate__slideInDown">
            <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight">SEED EVENT+ <span id="user-role-display"
                        class="text-blue-600 text-sm bg-blue-50 px-2 py-1 rounded-full ml-2 font-normal align-middle"></span>
                </h1>
                <div class="flex items-center space-x-6">
                    <span id="user-name-display" class="text-sm font-medium text-slate-600"></span>
                    <button onclick="logout()"
                        class="text-sm text-red-500 hover:text-red-700 font-medium transition-colors">ç™»å‡º Logout</button>
                </div>
            </div>
            <div class="max-w-7xl mx-auto px-6 flex justify-end pb-4">
                <button onclick="repairDatabase()" class="text-xs text-blue-600 hover:text-blue-800 underline">ä¿®å¾©è³‡æ–™åº«æ¬„ä½
                    (Repair DB)</button>
            </div>
            <!-- Tabs -->
            <div class="max-w-7xl mx-auto px-6 flex space-x-8 border-t border-gray-100">
                <button onclick="switchTab('dashboard')" id="tab-dashboard"
                    class="tab-btn py-4 text-sm font-medium text-gray-400 hover:text-slate-800">ğŸ“Š å„€è¡¨æ¿</button>
                <button onclick="switchTab('events')" id="tab-events"
                    class="tab-btn py-4 text-sm font-medium text-gray-400 hover:text-slate-800 active-tab">æ´»å‹•åˆ—è¡¨</button>
                <button onclick="switchTab('create-event')" id="tab-create-event"
                    class="tab-btn py-4 text-sm font-medium text-gray-400 hover:text-slate-800">å»ºç«‹æ´»å‹•</button>
                <button onclick="switchTab('users')" id="tab-users"
                    class="tab-btn py-4 text-sm font-medium text-gray-400 hover:text-slate-800">å¸³è™Ÿ Users</button>
                <button onclick="switchTab('logs')" id="tab-logs"
                    class="tab-btn py-4 text-sm font-medium text-gray-400 hover:text-slate-800">ğŸ“‹ æ“ä½œæ—¥èªŒ</button>
                <button onclick="switchTab('scanner')" id="tab-scanner"
                    class="tab-btn py-4 text-sm font-medium text-gray-400 hover:text-slate-800">QR æƒæ</button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-auto bg-gray-100 p-6">

            <!-- Overview View Removed -->
            <div id="view-overview" class="hidden"></div>

            <!-- Dashboard View (Phase 17.3) -->
            <div id="view-dashboard" class="max-w-7xl mx-auto space-y-6 hidden animate__animated animate__fadeIn">
                <!-- Header with Refresh -->
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-slate-800">ğŸ“Š æ•¸æ“šå„€è¡¨æ¿</h2>
                    <div class="flex items-center gap-3">
                        <span id="dashboard-last-update" class="text-xs text-slate-400">æœ€å¾Œæ›´æ–°: --</span>
                        <button onclick="refreshDashboard()"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-all flex items-center gap-2">
                            <i class="fas fa-sync-alt"></i>
                            é‡æ–°æ•´ç†
                        </button>
                    </div>
                </div>

                <!-- Global Statistics Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Total Events -->
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl shadow-lg text-white">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-calendar-alt text-3xl opacity-80"></i>
                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full">ç¸½è¨ˆ</span>
                        </div>
                        <div class="text-4xl font-black mb-1" id="stat-total-events">-</div>
                        <div class="text-sm opacity-90">æ´»å‹•ç¸½æ•¸</div>
                    </div>

                    <!-- Total Registrations -->
                    <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl shadow-lg text-white">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-users text-3xl opacity-80"></i>
                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full">ç¸½è¨ˆ</span>
                        </div>
                        <div class="text-4xl font-black mb-1" id="stat-total-registrations">-</div>
                        <div class="text-sm opacity-90">å ±åç¸½æ•¸</div>
                    </div>

                    <!-- Pending Approvals -->
                    <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 p-6 rounded-xl shadow-lg text-white">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-clock text-3xl opacity-80"></i>
                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full">å¾…è™•ç†</span>
                        </div>
                        <div class="text-4xl font-black mb-1" id="stat-pending">-</div>
                        <div class="text-sm opacity-90">å¾…å¯©æ ¸å ±å</div>
                    </div>

                    <!-- Check-in Rate -->
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-xl shadow-lg text-white">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-check-circle text-3xl opacity-80"></i>
                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full">æ¯”ç‡</span>
                        </div>
                        <div class="text-4xl font-black mb-1" id="stat-checkin-rate">-</div>
                        <div class="text-sm opacity-90">æ•´é«”å ±åˆ°ç‡</div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Registration Trend Chart -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-slate-800">å ±åè¶¨å‹¢</h3>
                            <select id="trend-period" onchange="updateTrendChart()"
                                class="text-sm border border-slate-300 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="7">æœ€è¿‘ 7 å¤©</option>
                                <option value="14">æœ€è¿‘ 14 å¤©</option>
                                <option value="30">æœ€è¿‘ 30 å¤©</option>
                            </select>
                        </div>
                        <div class="relative h-[300px] w-full">
                            <canvas id="trend-chart"></canvas>
                        </div>
                    </div>

                    <!-- Status Distribution Chart -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">ç‹€æ…‹åˆ†å¸ƒ</h3>
                        <div class="relative h-[300px] w-full">
                            <canvas id="status-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Active Events Table -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-6 border-b border-slate-100">
                        <h3 class="text-lg font-bold text-slate-800">é€²è¡Œä¸­çš„æ´»å‹•</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-100">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase w-1/3">
                                        æ´»å‹•åç¨±</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase">æ—¥æœŸ</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase">å ±åæ•¸</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase">å®¹é‡ä½¿ç”¨ç‡
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase">ç‹€æ…‹</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-events-body" class="bg-white divide-y divide-slate-100">
                                <!-- Dynamic rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Operation Logs View (Phase 17.2) -->
            <div id="view-logs" class="max-w-7xl mx-auto space-y-6 hidden animate__animated animate__fadeIn">
                <!-- Header with Filters -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">ğŸ“‹ æ“ä½œæ—¥èªŒ</h2>

                    <!-- Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <select id="log-filter-user" onchange="applyLogFilters()"
                            class="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                            <option value="">æ‰€æœ‰ä½¿ç”¨è€…</option>
                        </select>

                        <select id="log-filter-action" onchange="applyLogFilters()"
                            class="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                            <option value="">æ‰€æœ‰æ“ä½œ</option>
                            <option value="APPROVE_REGISTRATION">æ ¸å‡†å ±å</option>
                            <option value="REJECT_REGISTRATION">æ‹’çµ•å ±å</option>
                            <option value="CREATE_EVENT">å»ºç«‹æ´»å‹•</option>
                            <option value="UPDATE_EVENT">æ›´æ–°æ´»å‹•</option>
                            <option value="DELETE_EVENT">åˆªé™¤æ´»å‹•</option>
                            <option value="BATCH_APPROVE">æ‰¹æ¬¡æ ¸å‡†</option>
                            <option value="BATCH_REJECT">æ‰¹æ¬¡æ‹’çµ•</option>
                        </select>

                        <input type="date" id="log-filter-date" onchange="applyLogFilters()"
                            class="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">

                        <button onclick="resetLogFilters()"
                            class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium transition-colors">
                            <i class="fas fa-redo mr-1"></i>é‡ç½®
                        </button>
                    </div>
                </div>

                <!-- Logs Table -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-100">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase">æ™‚é–“</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase">ä½¿ç”¨è€…</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase">æ“ä½œ</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase">ç›®æ¨™</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase">è©³æƒ…</th>
                                </tr>
                            </thead>
                            <tbody id="logs-table-body" class="bg-white divide-y divide-slate-100">
                                <!-- Dynamic rows -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="px-6 py-4 border-t border-slate-100 flex justify-between items-center">
                        <span class="text-sm text-slate-600">é¡¯ç¤º <strong id="logs-showing">0</strong> ç­†è¨˜éŒ„</span>
                        <div class="flex gap-2">
                            <button onclick="loadLogs(currentLogPage - 1)" id="logs-prev-btn"
                                class="px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded text-sm font-medium transition-colors disabled:opacity-50"
                                disabled>
                                ä¸Šä¸€é 
                            </button>
                            <span class="px-3 py-1 text-sm text-slate-600">ç¬¬ <strong id="logs-current-page">1</strong>
                                é </span>
                            <button onclick="loadLogs(currentLogPage + 1)" id="logs-next-btn"
                                class="px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded text-sm font-medium transition-colors disabled:opacity-50"
                                disabled>
                                ä¸‹ä¸€é 
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create Event View -->
            <div id="view-create-event" class="max-w-7xl mx-auto space-y-8 hidden animate__animated animate__fadeIn">
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-xl font-bold mb-6 text-slate-800">å»ºç«‹æ–°æ´»å‹•</h3>
                    <form id="create-event-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-400 uppercase">æ´»å‹•åç¨±</label>
                            <input type="text" id="evt-name" required
                                class="w-full p-3 bg-slate-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-400 uppercase">æ—¥æœŸ</label>
                            <input type="date" id="evt-date" required
                                class="w-full p-3 bg-slate-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-400 uppercase">åœ°é»</label>
                            <input type="text" id="evt-loc" required
                                class="w-full p-3 bg-slate-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-400 uppercase">åƒ¹æ ¼</label>
                            <input type="number" id="evt-price" required
                                class="w-full p-3 bg-slate-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>
                        <div class="md:col-span-2 space-y-1">
                            <label class="text-xs font-bold text-slate-400 uppercase">æ´»å‹•åœ–ç‰‡ (Image URL)</label>
                            <input type="text" id="evt-image-url" placeholder="https://example.com/banner.jpg"
                                class="w-full p-3 bg-slate-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>
                        <div class="md:col-span-2 space-y-1">
                            <label class="text-xs font-bold text-slate-400 uppercase">æè¿° (æ”¯æ´ HTML)</label>
                            <textarea id="evt-desc"
                                class="w-full p-3 bg-slate-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all font-mono text-sm"
                                rows="5" placeholder="å¯è¼¸å…¥ HTML æ¨™ç±¤æˆ–æ˜¯ç´”æ–‡å­—"></textarea>
                        </div>
                        <div class="md:col-span-2 flex space-x-6 pt-2">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="evt-enable-qr" class="sr-only peer" checked>
                                <div
                                    class="relative w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                </div>
                                <span class="ms-3 text-sm font-medium text-slate-700">é¡¯ç¤º QR Code</span>
                            </label>

                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="evt-enable-checkin" class="sr-only peer">
                                <div
                                    class="relative w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600">
                                </div>
                                <span class="ms-3 text-sm font-medium text-slate-700">é–‹æ”¾å ±åˆ° (Check-in)</span>
                            </label>
                        </div>

                        <!-- Custom Fields Builder (Professional) -->
                        <div class="md:col-span-2 p-6 rounded-xl bg-slate-50 border border-slate-200">
                            <h4 class="font-bold mb-4 text-slate-800 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4">
                                    </path>
                                </svg>
                                è‡ªè¨‚å ±åè¡¨å–®æ¬„ä½ (Custom Form Fields)
                            </h4>

                            <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm mb-4">
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 mb-3">
                                    <div class="md:col-span-3">
                                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">æ¬„ä½åç¨±
                                            Label</label>
                                        <input type="text" id="new-field-label" placeholder="ä¾‹å¦‚: ç”¨é¤ç¿’æ…£"
                                            class="w-full p-2 bg-slate-50 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    </div>
                                    <div class="md:col-span-3">
                                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">é¡å‹
                                            Type</label>
                                        <select id="new-field-type" onchange="toggleFieldOptions()"
                                            class="w-full p-2 bg-slate-50 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                            <option value="text">å–®è¡Œæ–‡å­— (Text)</option>
                                            <option value="textarea">å¤šè¡Œæ–‡å­— (Textarea)</option>
                                            <option value="select">ä¸‹æ‹‰é¸å–® (Select)</option>
                                            <option value="date">æ—¥æœŸ (Date)</option>
                                            <option value="email">Email</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-4">
                                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">é¸é … Options
                                            (ä»¥é€—è™Ÿåˆ†éš”)</label>
                                        <input type="text" id="new-field-options" placeholder="è‘·, ç´ , ä¸åƒç‰›" disabled
                                            class="w-full p-2 bg-slate-100 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none disabled:text-slate-300">
                                    </div>
                                    <div class="md:col-span-2 flex items-end">
                                        <div class="flex items-center h-10 pt-4">
                                            <label class="inline-flex items-center cursor-pointer">
                                                <input type="checkbox" id="new-field-required" class="sr-only peer">
                                                <div
                                                    class="relative w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-500">
                                                </div>
                                                <span class="ms-3 text-sm font-medium text-slate-600">å¿…å¡«
                                                    (Required)</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" onclick="addCustomField()"
                                    class="w-full py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition-colors text-sm font-bold flex items-center justify-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    æ–°å¢æ¬„ä½ Add Field
                                </button>
                            </div>

                            <div class="space-y-2">
                                <label class="block text-xs font-bold text-slate-400 uppercase">ç›®å‰æ¬„ä½é è¦½</label>
                                <ul id="custom-fields-list" class="space-y-2">
                                    <!-- Dynamic Fields -->
                                    <li
                                        class="empty-state text-sm text-slate-400 text-center py-4 bg-slate-100 rounded-lg border border-dashed border-slate-300">
                                        å°šæœªæ–°å¢ä»»ä½•è‡ªè¨‚æ¬„ä½
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <button type="submit"
                            class="bg-blue-600 text-white py-4 px-6 rounded-xl md:col-span-2 hover:bg-blue-700 font-bold tracking-wide shadow-lg shadow-blue-200 transition-all transform hover:-translate-y-1">
                            å»ºç«‹æ´»å‹• Create Event
                        </button>
                    </form>
                </div>
            </div>

            <!-- Event List View -->
            <div id="view-events" class="max-w-7xl mx-auto space-y-8 hidden animate__animated animate__fadeIn">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-6 border-b border-slate-100">
                        <h3 class="text-xl font-bold text-slate-800">æ´»å‹•åˆ—è¡¨</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-100">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                        åç¨±</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                        æ—¥æœŸ</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                        å ±åäººæ•¸</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                        ç‹€æ…‹</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                        æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="events-list-body" class="bg-white divide-y divide-gray-200">
                                <!-- Events Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="view-users" class="max-w-7xl mx-auto space-y-6 hidden">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-bold mb-4">æ–°å¢å¸³è™Ÿ</h3>
                    <form id="create-user-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="new-u-username" placeholder="å¸³è™Ÿ (Username)" required
                            class="p-2 border rounded">
                        <input type="text" id="new-u-password" placeholder="å¯†ç¢¼ (Password)" required
                            class="p-2 border rounded">
                        <input type="text" id="new-u-name" placeholder="å§“å (Name)" required class="p-2 border rounded">
                        <select id="new-u-role" class="p-2 border rounded" required>
                            <option value="System Admin">ç³»çµ±ç®¡ç†å“¡ (System Admin)</option>
                            <option value="Finance Officer">è²¡å‹™äººå“¡ (Finance Officer)</option>
                        </select>
                        <button type="submit"
                            class="bg-blue-600 text-white py-2 px-4 rounded md:col-span-2 hover:bg-blue-700">å»ºç«‹å¸³è™Ÿ</button>
                    </form>
                </div>
            </div>

            <!-- Scanner View -->
            <div id="view-scanner" class="max-w-md mx-auto hidden animate__animated animate__fadeIn">
                <div
                    class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 text-center relative overflow-hidden">
                    <h3 class="text-xl font-bold mb-6 text-slate-800">QR Code æƒæå™¨</h3>

                    <div id="main-scanner-overlay"
                        class="absolute inset-0 flex flex-col items-center justify-center bg-white/90 z-20">
                        <i class="fas fa-camera text-slate-400 text-5xl mb-4"></i>
                        <button onclick="startScanner()"
                            class="bg-blue-600 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:bg-blue-700 transition transform hover:scale-105 active:scale-95 flex items-center">
                            <i class="fas fa-power-off mr-2"></i> å•Ÿå‹•ç›¸æ©Ÿ
                        </button>
                    </div>

                    <button onclick="stopScanner()" id="btn-stop-main-scanner"
                        class="absolute top-4 right-4 bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs hidden z-30 hover:bg-red-200">
                        é—œé–‰
                    </button>

                    <div id="reader"
                        class="mx-auto border-2 border-slate-100 rounded-lg overflow-hidden mb-6 min-h-[300px] bg-black">
                    </div>
                    <p id="scan-result" class="text-sm font-medium text-slate-500 min-h-[20px]"></p>
                </div>
            </div>

        </main>
    </div>

    <!-- Create User Modal -->
    <div id="create-user-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl p-8 max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold mb-4 text-slate-800">æ–°å¢å¸³è™Ÿ</h3>
            <form id="create-user-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">ä½¿ç”¨è€…åç¨±</label>
                    <input type="text" id="new-u-username" required
                        class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">å¯†ç¢¼</label>
                    <input type="password" id="new-u-password" required
                        class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">å§“å (é¡¯ç¤ºç”¨)</label>
                    <input type="text" id="new-u-name" required
                        class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">æ¬Šé™è§’è‰²</label>
                    <select id="new-u-role" class="w-full p-2 border border-slate-200 rounded-lg outline-none">
                        <option value="Admin">ç³»çµ±ç®¡ç†å“¡ (Admin)</option>
                        <option value="Staff">å·¥ä½œäººå“¡ (Staff)</option>
                    </select>
                </div>
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('create-user-modal').classList.add('hidden')"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-50 rounded-lg">å–æ¶ˆ</button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm btn-loading">å»ºç«‹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Event Manager Modal -->
    <div id="event-manager-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-7xl h-[95vh] flex flex-col m-4 overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-gray-100 px-6 py-4 flex justify-between items-center border-b">
                <h3 class="text-xl font-bold text-gray-800" id="modal-event-title">æ´»å‹•ç®¡ç†</h3>
                <button onclick="closeEventManager()"
                    class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>

            <!-- Modal Tabs -->
            <div class="bg-white border-b px-6 flex space-x-6">
                <button onclick="switchModalTab('info')" id="mtab-info"
                    class="py-3 text-sm font-medium border-b-2 border-blue-600 text-blue-600 transition-colors">åŸºæœ¬è³‡è¨Š</button>
                <button onclick="switchModalTab('regs')" id="mtab-regs"
                    class="py-3 text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors">å ±ååå–®</button>
                <button onclick="switchModalTab('checkin')" id="mtab-checkin"
                    class="py-3 text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors flex items-center">
                    <span>å ±åˆ°ç®¡ç† (Console)</span>
                    <span class="ml-2 bg-slate-100 text-slate-600 text-xs px-2 py-0.5 rounded-full"
                        id="tab-checkin-badge">Live</span>
                </button>
                <button onclick="switchModalTab('landing')" id="mtab-landing"
                    class="py-3 text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors flex items-center">
                    <i class="fas fa-rocket mr-2"></i> æ¨å»£é é¢
                </button>
            </div>

            <!-- Modal Content -->
            <div class="flex-1 overflow-y-auto overflow-x-hidden p-6 bg-gray-50 scroll-smooth">

                <!-- Info Tab -->
                <div id="mview-info">
                    <form id="edit-event-form" class="space-y-4 max-w-7xl mx-auto bg-white p-6 rounded shadow">
                        <input type="hidden" id="edit-evt-id">
                        <h4 class="font-bold text-gray-700 text-lg mb-4">ç·¨è¼¯æ´»å‹•è³‡è¨Š</h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">åç¨±</label>
                            <input type="text" id="edit-evt-name" required class="w-full mt-1 p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">æ—¥æœŸ</label>
                            <input type="date" id="edit-evt-date" required class="w-full mt-1 p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">åœ°é»</label>
                            <input type="text" id="edit-evt-loc" required class="w-full mt-1 p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">åƒ¹æ ¼</label>
                            <input type="number" id="edit-evt-price" required class="w-full mt-1 p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">æ´»å‹•åœ–ç‰‡ (Image URL)</label>
                            <input type="text" id="edit-evt-image-url" class="w-full mt-1 p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">æè¿° (HTML)</label>
                            <textarea id="edit-evt-desc" class="w-full mt-1 p-2 border rounded font-mono text-sm"
                                rows="5"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ç‹€æ…‹</label>
                            <select id="edit-evt-status" class="w-full mt-1 p-2 border rounded">
                                <option value="Open">é–‹å•Ÿå ±å (Open)</option>
                                <option value="Closed">åœæ­¢å ±å (Closed)</option>
                            </select>
                        </div>
                        <div class="flex space-x-6 pt-2">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="edit-evt-enable-qr" class="sr-only peer">
                                <div
                                    class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                </div>
                                <span class="ms-3 text-sm font-medium text-gray-700">é¡¯ç¤º QR Code</span>
                            </label>

                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="edit-evt-enable-checkin" class="sr-only peer">
                                <div
                                    class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600">
                                </div>
                                <span class="ms-3 text-sm font-medium text-gray-700">é–‹æ”¾å ±åˆ° (Check-in)</span>
                            </label>
                        </div>
                        <div class="flex justify-between items-center pt-6 border-t">
                            <button type="button" onclick="confirmDeleteEvent()"
                                class="text-red-600 hover:bg-red-50 px-4 py-2 rounded-lg text-sm font-bold border border-red-200 transition-colors">
                                <i class="fas fa-trash-alt mr-2"></i> åˆªé™¤æ­¤æ´»å‹•
                            </button>
                            <button type="submit"
                                class="px-8 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg transition-all active:scale-95">
                                <i class="fas fa-save mr-2"></i> å„²å­˜è®Šæ›´
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Registrations Tab -->
                <div id="mview-regs" class="hidden space-y-4">
                    <!-- Advanced Filter Panel -->
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-3">
                            <!-- Status Filter -->
                            <select id="filter-status" onchange="applyFilters()"
                                class="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                                <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                                <option value="Pending">â³ å¾…å¯©æ ¸</option>
                                <option value="Approved">âœ… å·²æ ¸å‡†</option>
                                <option value="Rejected">âŒ å·²æ‹’çµ•</option>
                            </select>

                            <!-- Check-in Filter -->
                            <select id="filter-checkin" onchange="applyFilters()"
                                class="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                                <option value="">å ±åˆ°ç‹€æ…‹</option>
                                <option value="checked">âœ“ å·²å ±åˆ°</option>
                                <option value="not-checked">â—‹ æœªå ±åˆ°</option>
                            </select>

                            <!-- Search Box -->
                            <input type="text" id="filter-search" placeholder="ğŸ” æœå°‹å§“åã€Emailã€é›»è©±"
                                onkeyup="debounceFilter()"
                                class="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">

                            <!-- Action Buttons -->
                            <div class="flex gap-2">
                                <button onclick="resetFilters()"
                                    class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                                    <i class="fas fa-redo mr-1"></i>é‡ç½®
                                </button>
                            </div>
                        </div>

                        <!-- Quick Filters -->
                        <div class="flex flex-wrap gap-2 mb-3">
                            <button onclick="quickFilter('today')"
                                class="quick-filter-btn px-3 py-1 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-full text-xs font-medium transition-colors">
                                ğŸ“… ä»Šæ—¥å ±å
                            </button>
                            <button onclick="quickFilter('pending')"
                                class="quick-filter-btn px-3 py-1 bg-yellow-50 hover:bg-yellow-100 text-yellow-700 rounded-full text-xs font-medium transition-colors">
                                â³ å¾…å¯©æ ¸
                            </button>
                            <button onclick="quickFilter('approved')"
                                class="quick-filter-btn px-3 py-1 bg-green-50 hover:bg-green-100 text-green-700 rounded-full text-xs font-medium transition-colors">
                                âœ… å·²æ ¸å‡†
                            </button>
                            <button onclick="quickFilter('checked-in')"
                                class="quick-filter-btn px-3 py-1 bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-full text-xs font-medium transition-colors">
                                ğŸ« å·²å ±åˆ°
                            </button>
                        </div>

                        <span id="filter-active-indicator" class="hidden ml-2 text-orange-600">ï¼ˆå·²å¥—ç”¨ç¯©é¸ï¼‰</span>
                        <div class="mt-2 text-xs text-slate-400">
                            æ‰¾åˆ° <span id="filter-result-count" class="font-bold text-slate-600">0</span> ç­†ç¬¦åˆçš„å ±åè³‡æ–™
                        </div>
                    </div>

                    <!-- AI Assisted Tools -->
                    <div class="mt-4 pt-4 border-t border-slate-100 flex flex-wrap gap-2">
                        <span class="text-xs font-bold text-slate-400 uppercase w-full mb-1">AI è¼”åŠ©å·¥å…· (AI Assisted
                            Tools)</span>
                        <button onclick="detectDuplicates()"
                            class="px-3 py-1.5 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 rounded-lg text-xs font-bold transition-all border border-indigo-100 flex items-center">
                            <i class="fas fa-clone mr-1.5"></i> åµæ¸¬é‡è¤‡å ±å (Detect Duplicates)
                        </button>
                        <button onclick="suggestAutoApprovals()"
                            class="px-3 py-1.5 bg-cyan-50 hover:bg-cyan-100 text-cyan-700 rounded-lg text-xs font-bold transition-all border border-cyan-100 flex items-center">
                            <i class="fas fa-magic mr-1.5"></i> å»ºè­°è‡ªå‹•æ ¸å‡† (Auto-Approval)
                        </button>
                    </div>

                    <!-- Stats Bar -->
                    <div class="flex justify-between items-center mt-6">
                        <div class="text-sm text-gray-600">
                            å·²å ±å: <span id="reg-count-total" class="font-bold text-gray-900">-</span> |
                            å·²ä»˜æ¬¾: <span id="reg-count-paid" class="font-bold text-green-600">-</span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="loadModalRegistrations()"
                                class="bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-300">
                                <i class="fas fa-sync-alt mr-1"></i>é‡æ–°æ•´ç†
                            </button>
                            <button onclick="downloadCSV()"
                                class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                <i class="fas fa-download mr-1"></i>åŒ¯å‡º CSV
                            </button>
                        </div>
                    </div>

                    <!-- Registration Management List -->
                    <div id="event-registrations-section" class="mt-4">
                        <div class="overflow-x-auto rounded-lg border border-slate-100">
                            <table class="min-w-full divide-y divide-slate-100" id="registrations-table">
                                <thead class="bg-slate-50" id="registrations-table-head">
                                    <!-- Dynamic Header injected here -->
                                </thead>
                                <tbody id="registrations-list-body" class="bg-white divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Check-in Console Tab (New) -->
                <div id="mview-checkin" class="hidden h-full flex flex-col">
                    <!-- Stats Dashboard (Live) -->
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                            <div class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1">ç¸½å ±å</div>
                            <div class="text-3xl font-black text-slate-800" id="console-total">-</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-green-100 bg-green-50 shadow-sm">
                            <div class="text-xs text-green-600 uppercase font-bold tracking-wider mb-1">å·²å ±åˆ°</div>
                            <div class="text-3xl font-black text-green-600" id="console-checked-in">-</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-orange-100 bg-orange-50 shadow-sm">
                            <div class="text-xs text-orange-600 uppercase font-bold tracking-wider mb-1">æœªå ±åˆ°</div>
                            <div class="text-3xl font-black text-orange-600" id="console-unchecked">-</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-blue-100 bg-blue-50 shadow-sm">
                            <div class="text-xs text-blue-600 uppercase font-bold tracking-wider mb-1">å ±åˆ°ç‡</div>
                            <div class="text-3xl font-black text-blue-600" id="console-rate">0%</div>
                        </div>
                    </div>

                    <!-- Scanner & Manual Check-in Area -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1 min-h-0">
                        <!-- Left: Scanner -->
                        <div
                            class="bg-black rounded-2xl overflow-hidden relative shadow-lg flex flex-col items-center justify-center p-4 min-h-[400px]">

                            <!-- Manual Start Overlay -->
                            <div id="scanner-blocked-overlay"
                                class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 z-20">
                                <i class="fas fa-camera text-slate-700 text-6xl mb-4"></i>
                                <button onclick="startConsoleScanner()"
                                    class="bg-blue-600 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:bg-blue-700 transition transform hover:scale-105 active:scale-95 flex items-center">
                                    <i class="fas fa-power-off mr-2"></i> å•Ÿå‹•æƒæé¡é ­
                                </button>
                                <p class="text-slate-500 text-xs mt-4">è«‹å…è¨±ç€è¦½å™¨å­˜å–ç›¸æ©Ÿæ¬Šé™</p>
                            </div>

                            <button onclick="stopConsoleScanner()" id="btn-stop-scanner"
                                class="absolute top-4 right-4 bg-red-600/80 text-white px-3 py-1.5 rounded-full text-xs backdrop-blur-md hidden z-30 hover:bg-red-700 transition">
                                <i class="fas fa-stop mr-1"></i> é—œé–‰é¡é ­
                            </button>

                            <div id="console-reader" class="w-full h-full max-h-[500px] bg-black"></div>
                            <div
                                class="absolute top-4 left-4 bg-black/50 text-white px-3 py-1 rounded-full text-xs backdrop-blur-md pointer-events-none">
                                ğŸ“· é¡é ­é‹ä½œä¸­
                            </div>
                            <!-- Scanner Status Overlay -->
                            <div id="console-scan-status"
                                class="absolute inset-0 flex items-center justify-center bg-black/80 hidden z-10">
                                <span class="text-white font-medium animate-pulse">è™•ç†ä¸­...</span>
                            </div>
                        </div>

                        <!-- Right: Recent Activity / Manual -->
                        <div class="flex flex-col space-y-4">
                            <!-- Manual Check-in Box -->
                            <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                                <h4 class="font-bold text-slate-700 mb-2">æ‰‹å‹•å ±åˆ° (Manual Check-in)</h4>
                                <div class="flex space-x-2">
                                    <input type="tel" id="manual-checkin-phone" placeholder="è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ (Phone)"
                                        class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                    <button onclick="manualCheckIn()"
                                        class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700">
                                        å ±åˆ°
                                    </button>
                                </div>
                            </div>

                            <div
                                class="bg-white rounded-2xl border border-slate-200 shadow-sm flex flex-col overflow-hidden flex-1">
                                <div
                                    class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                                    <h4 class="font-bold text-slate-700">æœ€è¿‘å‹•æ…‹</h4>
                                    <span class="text-xs text-slate-400">å¯¦æ™‚æ›´æ–°</span>
                                </div>
                                <div id="console-activity-log" class="flex-1 overflow-y-auto p-4 space-y-3">
                                    <div class="text-center text-slate-400 py-10 text-sm">æš«ç„¡å ±åˆ°ç´€éŒ„</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Landing Tab (Previously Orphaned) -->
                <div id="mview-landing" class="hidden space-y-8 animate__animated animate__fadeIn">
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <h4 class="font-bold text-slate-800 text-lg mb-4 flex items-center gap-2">
                            <i class="fas fa-link text-blue-600"></i> æ¨å»£ç¶²å€èˆ‡é è¦½
                        </h4>
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1 bg-slate-50 p-4 rounded-xl border border-slate-100 break-all font-mono text-sm text-slate-600"
                                id="landing-url-display">
                                ---
                            </div>
                            <div class="flex gap-2">
                                <button onclick="copyLandingURL()"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold transition-all flex items-center gap-2 shadow-sm hover:shadow-md active:scale-95">
                                    <i class="fas fa-copy"></i> è¤‡è£½é€£çµ
                                </button>
                                <button onclick="previewLandingPage()"
                                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl font-bold transition-all flex items-center gap-2 shadow-sm hover:shadow-md active:scale-95">
                                    <i class="fas fa-external-link-alt"></i> é è¦½é é¢
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- QR Code Section -->
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <h4 class="font-bold text-slate-800 text-lg mb-4 flex items-center gap-2">
                            <i class="fas fa-qrcode text-purple-600"></i> æ´»å‹• QR Code
                        </h4>
                        <div class="flex flex-col md:flex-row items-center md:items-start gap-8">
                            <div class="bg-white border-4 border-slate-50 rounded-2xl p-6 shadow-md">
                                <img id="landing-qr-image" src="" alt="QR Code"
                                    class="w-56 h-56 transition-transform hover:scale-105 duration-300">
                            </div>
                            <div class="flex-1 space-y-4 text-center md:text-left">
                                <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                                    <p class="text-slate-700 text-sm leading-relaxed">
                                        æ‚¨å¯ä»¥å°‡æ­¤ QR Code ç½®æ–¼æµ·å ±ã€å‚³å–®æˆ–ç¤¾ç¾¤åª’é«”ä¸Šã€‚
                                        <br>å ±åè€…æƒæå¾Œå°‡ç›´æ¥é€²å…¥æ´»å‹•å°ˆå±¬å ±åé é¢ã€‚
                                    </p>
                                </div>
                                <button onclick="downloadLandingQR()"
                                    class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-xl font-bold transition-all flex items-center justify-center gap-2 shadow-lg hover:shadow-xl active:scale-95 transform hover:-translate-y-0.5">
                                    <i class="fas fa-download"></i> ä¸‹è¼‰ QR Code (500x500)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
    </div>
    </div>

    <script>
        function getApiUrl() {
            if (window.API_URL) return window.API_URL;
            if (typeof API_URL !== 'undefined') return API_URL;
            // Fallback to the latest version as a safety measure
            return "https://script.google.com/macros/s/AKfycbyF3Xd9HY1R71SdSse-mFDLkAXvV9bTicVJ_0We3p8woq7PrWo3JZ69tfvq6wtO7A5p/exec";
        }

        var API_URL = getApiUrl();
        let currentUser = null;
        let currentEventId = null; // Store currently viewed event ID for modal
        let customFields = []; // Global custom fields definition



        // Login System
        // Login System
        async function handleLogin(e) {
            e.preventDefault();
            console.log("handleLogin triggered");

            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            // Find button inside the form that triggered the event
            const btn = e.target.querySelector('button[type="submit"]');
            const statusDiv = document.getElementById('login-status') || createStatusDiv();

            if (typeof setLoading === 'function') setLoading(true, btn);
            else { if (btn) btn.innerText = "Loading..."; }

            statusDiv.innerHTML = '<span class="text-blue-500">Connecting to server...</span>';

            // Ensure API_URL
            let targetUrl = getApiUrl();

            console.log("Login Target:", targetUrl);

            try {
                const response = await fetch(`${targetUrl}?action=checkLogin&username=${u}&password=${p}`);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);

                const text = await response.text();
                console.log("Response raw:", text);

                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    throw new Error("Invalid JSON response: " + text.substring(0, 100) + "...");
                }

                if (result.status === 'success') {
                    currentUser = result.user;
                    // Pre-load permissions before entering dashboard
                    loadUserPermissions();
                    statusDiv.innerHTML = '<span class="text-green-500">Login Successful!</span>';
                    enterDashboard();
                } else {
                    statusDiv.innerHTML = `<span class="text-red-500">Error: ${result.message}</span>`;
                    showPopup('ç™»å…¥å¤±æ•—', result.message, 'error');
                }
            } catch (err) {
                console.error("Login Error:", err);
                statusDiv.innerHTML = `<span class="text-red-500 font-bold break-all">Connection Error: ${err.message}</span>`;
                alert("ç³»çµ±éŒ¯èª¤ (Login Error):\n" + err.message);
            } finally {
                if (typeof setLoading === 'function') setLoading(false, btn);
                else { if (btn) btn.innerText = "Login"; }
            }
        }

        function createStatusDiv() {
            const div = document.createElement('div');
            div.id = 'login-status';
            div.className = "mt-4 text-sm text-center font-mono p-2 bg-slate-50 rounded border border-slate-200";
            document.getElementById('login-form').appendChild(div);
            return div;
        }

        async function enterDashboard() {
            try {
                // Show Loading
                document.getElementById('main-loading-overlay').classList.remove('hidden');

                if (!currentUser) throw new Error("User session invalid");

                document.getElementById('login-screen').classList.add('hidden');
                const dashboard = document.getElementById('dashboard');
                dashboard.classList.remove('hidden');

                document.getElementById('user-name-display').innerText = currentUser.name || 'User';
                document.getElementById('user-role-display').innerText = currentUser.role || 'Staff';

                console.log("Current User Role Raw:", currentUser.role);
                // alert("Debug Role: " + currentUser.role); // Debugging removed

                // explicit role check
                // FORCE SHOW for debugging - logic was flaky
                const userTab = document.getElementById('tab-users');
                userTab.classList.remove('hidden');

                /*
                if (String(currentUser.role).trim() === 'System Admin') {
                    userTab.classList.remove('hidden');
                } else {
                    if (String(currentUser.role).includes('Admin')) {
                         userTab.classList.remove('hidden');
                    } else {
                         // userTab.classList.add('hidden'); // Disabled hiding for now
                    }
                }
                */

                // Load Overview Stats first
                await loadOverview();

                // Auto-repair headers in background
                fetch(getApiUrl(), { method: 'POST', body: JSON.stringify({ action: 'fixHeaders' }) })
                    .catch(console.error);

                playAudio('popup'); // Welcome sound

            } catch (e) {
                console.error(e);
                alert("è¼‰å…¥ Dashboard å¤±æ•—: " + e.message);
            } finally {
                // Hide Loading
                document.getElementById('main-loading-overlay').classList.add('hidden');
            }
        }

        function logout() {
            location.reload();
        }

        // Tabs
        function switchTab(tab) {
            ['overview', 'events', 'scanner', 'users', 'create-event', 'dashboard', 'logs'].forEach(t => {
                const el = document.getElementById(`view-${t}`);
                const tabEl = document.getElementById(`tab-${t}`);
                if (el) el.classList.add('hidden');
                if (tabEl) tabEl.classList.remove('active-tab');
            });
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('active-tab');

            if (tab === 'overview') loadOverview();
            if (tab === 'events') loadEvents();
            if (tab === 'dashboard') loadDashboard();
            if (tab === 'logs') loadLogs(1);
            if (tab === 'scanner') {
                // startScanner(); // Auto-start removed
                // Show default state is handled by HTML overlay
            }
            else stopScanner();
        }

        // --- Overview Logic ---
        async function loadOverview() {
            // Simple approach: get all events and get all registrations (could be slow if huge data, but prototype OK)
            try {
                const [resE, resR] = await Promise.all([
                    fetch(`${getApiUrl()}?action=getEvents&includeClosed=true`),
                    fetch(`${getApiUrl()}?action=getRegistrations`)
                ]);
                const jsonE = await resE.json();
                const jsonR = await resR.json();

                const events = jsonE.data || [];
                const regs = jsonR.data || [];

                document.getElementById('stat-total-events').innerText = events.length;
                document.getElementById('stat-total-regs').innerText = regs.length;

                const pending = regs.filter(r => r.status === 'Pending').length;
                document.getElementById('stat-pending-regs').innerText = pending;
            } catch (e) { console.error(e); }
        }

        // --- Helpers ---
        function showLoadingOverlay() {
            const overlay = document.getElementById('main-loading-overlay');
            if (overlay) overlay.classList.remove('hidden');
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('main-loading-overlay');
            if (overlay) overlay.classList.add('hidden');
        }

        function setLoading(isLoading, btn = null, loadingText = "è™•ç†ä¸­...") {
            // Robust check: if first arg is an element and second is boolean, they are swapped
            if (isLoading && typeof isLoading === 'object' && isLoading.nodeType && typeof btn === 'boolean') {
                const temp = isLoading;
                isLoading = btn;
                btn = temp;
            }

            if (isLoading) {
                if (btn) {
                    btn.dataset.originalText = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>${loadingText}`;
                    btn.classList.add('opacity-75', 'cursor-not-allowed');
                } else {
                    showLoadingOverlay();
                }
            } else {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = btn.dataset.originalText || (btn.type === 'submit' ? 'é€å‡º' : btn.innerHTML);
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                }
                hideLoadingOverlay();
            }
        }

        // --- Events Logic ---
        async function loadEvents() {
            const body = document.getElementById('events-list-body');
            body.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center"><i class="fas fa-spinner fa-spin mr-2"></i>è¼‰å…¥ä¸­...</td></tr>';

            try {
                // Fetch events and registrations in parallel
                const [eventsRes, regsRes] = await Promise.all([
                    fetch(`${getApiUrl()}?action=getEvents&includeClosed=true`),
                    fetch(`${getApiUrl()}?action=getRegistrations`)
                ]);

                const eventsJson = await eventsRes.json();
                const regsJson = await regsRes.json();

                if (eventsJson.data && eventsJson.data.length) {
                    allEventsData = eventsJson.data; // Cache for modal
                    const allRegs = regsJson.data || [];

                    // Count registrations per event
                    const regCounts = {};
                    allRegs.forEach(reg => {
                        if (!regCounts[reg.event_id]) regCounts[reg.event_id] = 0;
                        regCounts[reg.event_id]++;
                    });

                    body.innerHTML = eventsJson.data.map(e => {
                        const regCount = regCounts[e.event_id] || 0;
                        const landingUrl = `${window.location.origin}/index.html?event=${e.event_id}`;

                        return `
                        <tr class="hover:bg-slate-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap font-bold text-gray-900 flex items-center">
                                <span class="w-2 h-2 rounded-full ${e.status === 'Open' ? 'bg-green-500' : 'bg-slate-300'} mr-2"></span>
                                ${e.name}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(e.date).toLocaleDateString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-blue-50 text-blue-700">
                                    <i class="fas fa-users mr-1.5 text-xs"></i>
                                    ${regCount}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${e.status === 'Open' ? 'bg-green-100 text-green-800' : 'bg-slate-100 text-slate-800'}">
                                    ${e.status === 'Open' ? 'å ±åä¸­' : 'å·²çµæŸ'}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex items-center space-x-2">
                                    <button onclick="copyEventLink('${e.event_id}')" 
                                        class="text-slate-600 hover:text-blue-600 transition-colors p-2 hover:bg-blue-50 rounded-lg" 
                                        title="è¤‡è£½æ´»å‹•é€£çµ">
                                        <i class="fas fa-link"></i>
                                    </button>
                                    <button onclick="openEventManager('${e.event_id}')" 
                                        class="bg-blue-600 text-white px-3 py-1.5 rounded-lg hover:bg-blue-700 shadow-sm transition-all hover:shadow-md active:scale-95 flex items-center">
                                        <i class="fas fa-cog mr-1"></i> ç®¡ç†
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `}).join('');
                } else {
                    body.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-slate-400">å°šç„¡æ´»å‹•ï¼Œè«‹é»æ“Šä¸Šæ–¹å»ºç«‹</td></tr>';
                }
            } catch (e) {
                console.error(e);
                body.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }

        document.getElementById('create-event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            setLoading(true, btn);

            const payload = {
                action: 'createEvent',
                name: document.getElementById('evt-name').value,
                date: document.getElementById('evt-date').value,
                location: document.getElementById('evt-loc').value,
                price: document.getElementById('evt-price').value,
                description: document.getElementById('evt-desc').value,
                descriptionHtml: document.getElementById('evt-desc').value, // Use same for now, or separate if UI split
                imageUrl: document.getElementById('evt-image-url').value,
                enableQr: document.getElementById('evt-enable-qr').checked,
                enableCheckIn: document.getElementById('evt-enable-checkin').checked,
                formConfig: customFields // Include custom fields
            };

            try {
                const response = await fetch(getApiUrl(), { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.json();

                if (result.status === 'success') {
                    playAudio('success');
                    showPopup('æˆåŠŸ', 'æ´»å‹•å»ºç«‹æˆåŠŸ', 'success');
                    e.target.reset();
                    customFields = []; // Reset custom fields
                    renderCustomFieldsList();

                    // Refetch events and switch back
                    await loadEvents();
                    switchTab('events');
                } else {
                    playAudio('error');
                    showPopup('å¤±æ•—', result.message || 'å»ºç«‹æ´»å‹•å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error("Create event error:", error);
                playAudio('error');
                showPopup('éŒ¯èª¤', 'é€£ç·šåˆ°ä¼ºæœå™¨æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            } finally {
                setLoading(false, btn);
            }

            // Show toast instead of alert? keeping alert for now as requested
            // alert('æ´»å‹•å»ºç«‹æˆåŠŸ');
        });

        // --- Event Manager Modal Logic ---
        let currentEditingEventId = null;
        let currentEventRegistrations = []; // Store for CSV export
        let allEventsData = []; // Populated by loadEvents

        // Expose to window to ensure button onclick works
        window.openEventManager = async function (eventId) {
            playAudio('popup');
            currentEditingEventId = eventId;

            const modal = document.getElementById('event-manager-modal');
            console.log("Opening event manager for ID:", eventId);
            const eventData = allEventsData.find(e => String(e.event_id) === String(eventId)); // Ensure type match

            if (!eventData) {
                console.error("Event data not found for ID:", eventId, "Available:", allEventsData);
                alert("ç„¡æ³•è®€å–æ´»å‹•è³‡æ–™ï¼Œè«‹é‡æ–°æ•´ç†é é¢å†è©¦");
                return;
            }

            // 1. Populate Edit Form
            document.getElementById('edit-evt-id').value = eventData.event_id;
            document.getElementById('edit-evt-name').value = eventData.name;
            document.getElementById('edit-evt-date').value = eventData.date.split('T')[0];
            document.getElementById('edit-evt-loc').value = eventData.location;
            document.getElementById('edit-evt-price').value = eventData.price;
            document.getElementById('edit-evt-desc').value = eventData.description_html || eventData.description || '';
            document.getElementById('edit-evt-image-url').value = eventData.image_url || '';
            document.getElementById('edit-evt-status').value = eventData.status;
            const enableQr = eventData.enable_qr !== undefined ? (eventData.enable_qr === true || String(eventData.enable_qr) === 'true') : true;
            document.getElementById('edit-evt-enable-qr').checked = enableQr;

            // Handle enable_checkin: default false if undefined
            const enableCheckIn = eventData.enable_checkin !== undefined ? (eventData.enable_checkin === true || String(eventData.enable_checkin) === 'true') : false;
            document.getElementById('edit-evt-enable-checkin').checked = enableCheckIn;

            // 2. Load Registrations with Dynamic Columns
            await loadEventRegistrations(eventId, eventData.form_config);

            // 3. Populate Custom Fields for Editing
            try {
                customFields = typeof eventData.form_config === 'string' ? JSON.parse(eventData.form_config) : (eventData.form_config || []);
            } catch (e) {
                console.error("Error parsing form config for edit", e);
                customFields = [];
            }
            renderCustomFieldsList();

            modal.classList.remove('hidden');
            switchModalTab('info'); // Default to info tab
        }

        function closeEventManager() {
            document.getElementById('event-manager-modal').classList.add('hidden');
            currentEditingEventId = null;
            stopConsoleScanner(); // Ensure console scanner is stopped when modal closes
        }

        // switchModalTab renamed and defined globally below in Phase 17 section

        // --- Custom Fields Logic ---


        function toggleFieldOptions() {
            const type = document.getElementById('new-field-type').value;
            const optionsInput = document.getElementById('new-field-options');
            if (type === 'select') {
                optionsInput.disabled = false;
                optionsInput.classList.remove('bg-slate-100');
                optionsInput.classList.add('bg-white');
                optionsInput.placeholder = "é¸é …1, é¸é …2, é¸é …3";
            } else {
                optionsInput.disabled = true;
                optionsInput.value = '';
                optionsInput.classList.add('bg-slate-100');
                optionsInput.classList.remove('bg-white');
                optionsInput.placeholder = "åƒ…é©ç”¨æ–¼ä¸‹æ‹‰é¸å–®";
            }
        }

        function addCustomField() {
            const label = document.getElementById('new-field-label').value.trim();
            const type = document.getElementById('new-field-type').value;
            const options = document.getElementById('new-field-options').value.trim();
            const required = document.getElementById('new-field-required').checked;

            if (!label) return alert("è«‹è¼¸å…¥æ¬„ä½åç¨±");
            if (type === 'select' && !options) return alert("ä¸‹æ‹‰é¸å–®è«‹è¼¸å…¥é¸é … (ä»¥é€—è™Ÿåˆ†éš”)");

            customFields.push({ label, type, options, required });
            renderCustomFieldsList();

            // Reset inputs
            document.getElementById('new-field-label').value = '';
            document.getElementById('new-field-options').value = '';
            document.getElementById('new-field-required').checked = false;
            document.getElementById('new-field-type').value = 'text';
            toggleFieldOptions();
        }

        function removeCustomField(index) {
            customFields.splice(index, 1);
            renderCustomFieldsList();
        }

        function renderCustomFieldsList() {
            const list = document.getElementById('custom-fields-list');
            if (customFields.length === 0) {
                list.innerHTML = `<li class="empty-state text-sm text-slate-400 text-center py-4 bg-slate-100 rounded-lg border border-dashed border-slate-300">å°šæœªæ–°å¢ä»»ä½•è‡ªè¨‚æ¬„ä½</li>`;
                return;
            }

            list.innerHTML = customFields.map((field, index) => `
                <li class="flex justify-between items-center bg-white p-3 rounded-lg border border-slate-200 shadow-sm animate__animated animate__fadeIn">
                    <div class="flex items-center">
                        <span class="text-xs font-bold uppercase text-slate-500 mr-2 bg-slate-100 px-2 py-1 rounded">${field.type}</span>
                        <span class="text-sm font-bold text-slate-700">${field.label}</span>
                        ${field.required ? '<span class="text-xs text-red-500 ml-1">*å¿…å¡«</span>' : ''}
                        ${field.options ? `<span class="text-xs text-slate-400 ml-2">(${field.options})</span>` : ''}
                    </div>
                    <button type="button" onclick="removeCustomField(${index})" class="text-red-400 hover:text-red-600 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </li>
            `).join('');
        }

        // --- Registration Data Logic ---
        async function loadEventRegistrations(eventId, formConfig) {
            const tbody = document.getElementById('registrations-list-body');
            const thead = document.getElementById('registrations-table-head');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-slate-400">Loading...</td></tr>';

            // Clear selections when loading new data
            selectedRegistrations.clear();
            updateBatchToolbar();

            try {
                // Parse Form Config for Dynamic Headers
                let customFields = [];
                try {
                    customFields = typeof formConfig === 'string' ? JSON.parse(formConfig) : (formConfig || []);
                } catch (e) { console.error("Config parse error", e); }

                // Build Table Header with Checkbox
                let headerHTML = `
                    <tr>
                        <th class="px-4 py-3 text-center">
                            <input type="checkbox" id="select-all-checkbox" 
                                onchange="toggleSelectAll()" 
                                class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 cursor-pointer">
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-400 uppercase sticky top-0 bg-slate-50 z-20 shadow-sm">å§“å Name</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-400 uppercase sticky top-0 bg-slate-50 z-20 shadow-sm">Email</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-400 uppercase sticky top-0 bg-slate-50 z-20 shadow-sm">é›»è©± Phone</th>
                `;

                // Add Dynamic Headers
                customFields.forEach(field => {
                    headerHTML += `<th class="px-4 py-3 text-left text-xs font-bold text-slate-400 uppercase sticky top-0 bg-slate-50 z-20 shadow-sm">${field.label}</th>`;
                });

                // Status and Check-in Headers
                headerHTML += `
                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-400 uppercase sticky top-0 bg-slate-50 z-20 shadow-sm">å ±åç‹€æ³ Status</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-400 uppercase sticky top-0 bg-slate-50 z-20 shadow-sm">ç¹³è²»ç‹€æ³ Payment</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-400 uppercase sticky top-0 bg-slate-50 z-20 shadow-sm">å ±åˆ°ç‹€æ³ Check-in</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-400 uppercase sticky top-0 bg-slate-50 z-20 shadow-sm">æ“ä½œ Actions</th>
                    </tr>
                `;
                thead.innerHTML = headerHTML;


                const response = await fetch(`${getApiUrl()}?action=getRegistrations&eventId=${eventId}`);
                const result = await response.json();

                if (result.data) {
                    currentEventRegistrations = result.data; // Save for filtering and CSV
                    allFilteredRegistrations = result.data; // Initialize filtered data

                    // Update filter result count
                    const resultCount = document.getElementById('filter-result-count');
                    if (resultCount) resultCount.textContent = result.data.length;

                    // Use new rendering function
                    renderFilteredRegistrations(result.data);
                    loadOverview(); // Update stats
                } else {
                    tbody.innerHTML = `<tr><td colspan="${7 + customFields.length}" class="text-center py-4 text-red-500">Failed to load</td></tr>`;
                }
            } catch (error) {
                console.error("Load regs error:", error);
                tbody.innerHTML = `<tr><td colspan="100%" class="text-center py-4 text-red-500">Error loading data</td></tr>`;
            }
        }

        function renderEventParticipants(registrations, customFields) {
            const tbody = document.getElementById('registrations-list-body');
            if (registrations.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${5 + customFields.length}" class="text-center py-8 text-slate-400">ç›®å‰æ²’æœ‰å ±åè³‡æ–™ No registrations yet.</td></tr>`;
                return;
            }

            tbody.innerHTML = registrations.map(reg => {
                // Parse Custom Data
                let customData = {};
                try {
                    customData = reg.dynamic_data ? JSON.parse(reg.dynamic_data) : {}; // Changed from custom_data
                } catch (e) { console.error("Parse custom data error", e); }

                // Build Dynamic Cells
                let dynamicCells = '';
                customFields.forEach(field => {
                    const val = customData[field.label] || '-';
                    dynamicCells += `<td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${val}</td>`;
                });

                // Status Badge Colors
                // Time Cell
                const checkInTime = reg.check_in_time ? new Date(reg.check_in_time).toLocaleString('zh-TW', { hour12: false }) : '-';
                // If it comes as formatted string from GAS, just use it.
                // GAS sends "yyyy-MM-dd HH:mm:ss". new Date() parses it? 
                // Let's just use it directly or simple fallback.
                const timeDisplay = reg.check_in_time || '-';

                let statusColor = "bg-gray-100 text-gray-800";
                if (reg.status === 'Approved') statusColor = "bg-green-100 text-green-800";
                if (reg.status === 'Rejected') statusColor = "bg-red-100 text-red-800";
                // Check-in Badge
                let checkInBadge = '';
                if (reg.check_in_status === 'CheckedIn') {
                    checkInBadge = `<span class="px-2 py-1 text-xs font-bold rounded-full uppercase tracking-wide bg-purple-100 text-purple-800 ml-1">å·²å ±åˆ° Check-in</span>`;
                }

                return `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-bold text-slate-800">${reg.participant_name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${reg.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${reg.phone || '-'}</td>
                    ${dynamicCells}
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600 font-mono">${timeDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-bold rounded-full uppercase tracking-wide ${statusColor}">
                            ${reg.status}
                        </span>
                        ${checkInBadge}
                        <div class="text-xs text-slate-400 mt-1">Payment: ${reg.payment_status}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        ${reg.status === 'Pending' ? `
                            <button onclick="updateRegStatus('${reg.reg_id}', 'Approved')" class="text-green-600 hover:text-green-900">Approve</button>
                            <button onclick="updateRegStatus('${reg.reg_id}', 'Rejected')" class="text-red-600 hover:text-red-900">Reject</button>
                        ` : ''}
                        ${reg.payment_status === 'Unpaid' ? `
                            <button onclick="updatePaymentStatus('${reg.reg_id}', 'Paid')" class="text-blue-600 hover:text-blue-900">Mark Paid</button>
                        ` : ''}
                        ${reg.qr_code_data ? `
                            <button onclick="showQRCode('${reg.qr_code_data}')" class="text-purple-600 hover:text-purple-900">QR</button>
                        ` : ''}
                    </td>
                </tr>
            `}).join('');
        }

        // --- Edit Event Submit ---
        document.getElementById('edit-event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            setLoading(true, btn);

            const payload = {
                action: 'updateEvent',
                eventId: document.getElementById('edit-evt-id').value,
                name: document.getElementById('edit-evt-name').value,
                date: document.getElementById('edit-evt-date').value,
                location: document.getElementById('edit-evt-loc').value,
                price: document.getElementById('edit-evt-price').value,
                description: document.getElementById('edit-evt-desc').value,
                status: document.getElementById('edit-evt-status').value,
                enableQr: document.getElementById('edit-evt-enable-qr').checked,
                enableCheckIn: document.getElementById('edit-evt-enable-checkin').checked,
                formConfig: customFields
            };

            try {
                await fetch(getApiUrl(), { method: 'POST', body: JSON.stringify(payload) });
                showPopup('æˆåŠŸ', 'æ´»å‹•æ›´æ–°æˆåŠŸ', 'success');
                loadEvents();
            } catch (e) { showPopup('å¤±æ•—', 'æ›´æ–°å¤±æ•—', 'error'); }
            finally { setLoading(false, btn); }
        });

        // --- Modal Registrations Logic ---
        // let currentRegsData = []; // This is replaced by currentEventRegistrations

        // async function loadModalRegistrations() { // This function is replaced by loadEventRegistrations
        //     if (!currentEventId) return;
        //     const body = document.getElementById('modal-reg-body');
        //     body.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center">è¼‰å…¥ä¸­...</td></tr>';

        //     try {
        //         const res = await fetch(`${getApiUrl()}?action=getRegistrations&eventId=${currentEventId}`);
        //         const json = await res.json();

        //         if (json.data) {
        //             currentRegsData = json.data;
        //             document.getElementById('reg-count-total').innerText = json.data.length;
        //             document.getElementById('reg-count-paid').innerText = json.data.filter(r => r.payment_status === 'Paid').length;

        //             if (json.data.length > 0) {
        //                 body.innerHTML = json.data.map(r => renderModalRegRow(r)).join('');
        //             } else {
        //                 body.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">å°šç„¡å ±åè³‡æ–™</td></tr>';
        //             }
        //         }
        //     } catch (e) {
        //         body.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">è¼‰å…¥å¤±æ•—</td></tr>';
        //     }
        // }

        // function renderModalRegRow(r) { // This function is replaced by renderEventParticipants
        //     // Helpers
        //     const getStatusBtn = (curr) => {
        //         if (curr === 'Pending') return `
        //             <button onclick="updateStatus('${r.reg_id}', 'Approved')" class="text-green-600 hover:underline mr-1">æ‰¹å‡†</button>
        //             <button onclick="updateStatus('${r.reg_id}', 'Rejected')" class="text-red-600 hover:underline">æ‹’çµ•</button>
        //         `;
        //         return `<span class="text-xs px-2 py-0.5 rounded ${curr === 'Approved' ? 'bg-green-100 text-green-800' : (curr === 'Rejected' ? 'bg-red-100 text-red-800' : 'bg-yellow-100')}">${curr}</span>`;
        //     };

        //     const getPayBtn = (curr, status) => {
        //         if (status !== 'Approved') return '<span class="text-gray-300">-</span>';
        //         if (curr === 'Unpaid') return `<button onclick="updatePayment('${r.reg_id}', 'Paid')" class="text-blue-600 hover:underline font-bold">æ”¶æ¬¾</button>`;
        //         return '<span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-800 rounded">Paid</span>';
        //     };

        //     let extraInfo = '';
        //     if (r.dynamic_data) {
        //         extraInfo = '<div class="mt-1 text-xs text-gray-500">';
        //         for (const [key, val] of Object.entries(r.dynamic_data)) {
        //             extraInfo += `<span class="mr-2"><strong>${key}:</strong> ${val}</span>`;
        //         }
        //         extraInfo += '</div>';
        //     }

        //     const qrBtn = r.qr_code_data ? `<button onclick="viewQR('${r.qr_code_data}')" class="text-purple-600 text-xs hover:underline">QR</button>` : '';

        //     return `
        //         <tr>
        //             <td class="px-4 py-3 text-sm">
        //                 <div class="font-bold text-gray-900">${r.participant_name}</div>
        //                 ${extraInfo}
        //             </td>
        //             <td class="px-4 py-3 text-sm text-gray-600">
        //                 <div>${r.email}</div>
        //                 <div class="text-xs">${r.phone}</div>
        //             </td>
        //             <td class="px-4 py-3 text-sm">${getStatusBtn(r.status)}</td>
        //             <td class="px-4 py-3 text-sm">${getPayBtn(r.payment_status, r.status)}</td>
        //             <td class="px-4 py-3 text-sm text-gray-600">${r.check_in_status}</td>
        //             <td class="px-4 py-3 text-sm text-right">${qrBtn}</td>
        //         </tr>
        //     `;
        // }

        async function updateRegStatus(id, status) {
            if (!confirm(`ç¢ºå®šè¦è®Šæ›´ç‹€æ…‹ç‚º ${status} ?`)) return;
            setLoading(true);
            try {
                await fetch(getApiUrl(), { method: 'POST', body: JSON.stringify({ action: 'updateStatus', regId: id, status: status }) });
                showPopup('æˆåŠŸ', `ç‹€æ…‹å·²æ›´æ–°ç‚º ${status}`, 'success');
                // Reload registrations
                const eventData = allEventsData.find(e => e.event_id === currentEditingEventId);
                if (eventData) {
                    await loadEventRegistrations(currentEditingEventId, eventData.form_config);
                }
                loadOverview();
            } catch (e) { showPopup('éŒ¯èª¤', 'æ›´æ–°å¤±æ•—', 'error'); }
            finally { setLoading(false); }
        }

        async function updatePaymentStatus(id, status) {
            if (!confirm(`ç¢ºå®šå·²æ”¶æ¬¾? æ­¤æ“ä½œå°‡ç”¢ç”Ÿ QR Code`)) return;
            setLoading(true);
            try {
                await fetch(getApiUrl(), { method: 'POST', body: JSON.stringify({ action: 'updatePayment', regId: id, paymentStatus: status }) });
                showPopup('æˆåŠŸ', `ä»˜æ¬¾ç‹€æ…‹å·²æ›´æ–°ç‚º ${status}`, 'success');
                // Reload registrations
                const eventData = allEventsData.find(e => e.event_id === currentEditingEventId);
                if (eventData) {
                    await loadEventRegistrations(currentEditingEventId, eventData.form_config);
                }
                loadOverview();
            } catch (e) { showPopup('éŒ¯èª¤', 'æ›´æ–°å¤±æ•—', 'error'); }
            finally { setLoading(false); }
        }

        function showQRCode(data) { // Renamed from viewQR
            const url = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(data)}`;
            const win = window.open("", "QR Code", "width=300,height=300");
            win.document.write(`<div style="text-align:center; padding:20px;"><img src="${url}"/><br>è«‹ä¿å­˜æ­¤åœ–</div>`);
        }


        // --- Event List Helper Functions ---
        function copyEventLink(eventId) {
            const landingUrl = `${window.location.origin}/index.html?event=${eventId}`;

            // Use modern clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(landingUrl).then(() => {
                    playAudio('success');
                    showPopup('æˆåŠŸ', 'æ´»å‹•é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
                }).catch(err => {
                    console.error('Clipboard error:', err);
                    fallbackCopyText(landingUrl);
                });
            } else {
                fallbackCopyText(landingUrl);
            }
        }

        function fallbackCopyText(text) {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                playAudio('success');
                showPopup('æˆåŠŸ', 'æ´»å‹•é€£çµå·²è¤‡è£½', 'success');
            } catch (err) {
                showPopup('éŒ¯èª¤', 'è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½', 'error');
            }
            document.body.removeChild(textArea);
        }

        function previewEventPage(eventId) {
            const landingUrl = `${window.location.origin}/index.html?event=${eventId}`;
            playAudio('click');
            window.open(landingUrl, '_blank', 'noopener,noreferrer');
        }

        // --- Landing Page Tab Functions ---
        function copyLandingUrl() {
            const urlInput = document.getElementById('landing-url-display');
            const url = urlInput.value;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    playAudio('success');
                    showPopup('æˆåŠŸ', 'Landing Page é€£çµå·²è¤‡è£½', 'success');
                }).catch(() => {
                    fallbackCopyText(url);
                });
            } else {
                fallbackCopyText(url);
            }
        }

        function previewLandingPage() {
            const url = document.getElementById('landing-url-display').value;
            playAudio('click');
            window.open(url, '_blank', 'noopener,noreferrer');
        }

        function downloadLandingQR() {
            const qrImage = document.getElementById('landing-qr-image');
            const url = qrImage.src;

            if (!url || url === '') {
                showPopup('éŒ¯èª¤', 'è«‹å…ˆåˆ‡æ›åˆ° Landing Page é ç±¤ä»¥ç”Ÿæˆ QR Code', 'error');
                return;
            }

            playAudio('click');
            const link = document.createElement('a');
            link.href = url;
            link.download = `event_${currentEditingEventId}_landing_qr.png`;
            link.click();
            showPopup('æˆåŠŸ', 'QR Code å·²ä¸‹è¼‰', 'success');
        }

        function initLandingPageTab() {
            if (!currentEditingEventId) return;

            const landingUrl = `${window.location.origin}/index.html?event=${currentEditingEventId}`;
            document.getElementById('landing-url-display').value = landingUrl;

            // Generate QR Code using API
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=${encodeURIComponent(landingUrl)}`;
            document.getElementById('landing-qr-image').src = qrUrl;
        }


        // --- CSV Export ---
        function downloadCSV() {
            if (!currentEventRegistrations || currentEventRegistrations.length === 0) {
                alert("æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º");
                return;
            }

            // Get Custom Fields Config
            const eventData = allEventsData.find(e => e.event_id === currentEditingEventId);
            let customFields = [];
            if (eventData && eventData.form_config) {
                try {
                    customFields = typeof eventData.form_config === 'string' ? JSON.parse(eventData.form_config) : eventData.form_config;
                } catch (e) { }
            }

            // Headers
            const headers = ['å§“å', 'Email', 'é›»è©±', ...customFields.map(f => f.label), 'ç‹€æ…‹', 'ä»˜æ¬¾ç‹€æ…‹', 'å ±åˆ°ç‹€æ…‹'];
            const csvRows = [headers.join(',')];

            // Rows
            for (const row of currentEventRegistrations) {
                let customData = {};
                try {
                    customData = row.dynamic_data ? JSON.parse(row.dynamic_data) : {};
                } catch (e) { }

                const dynamicValues = customFields.map(f => {
                    const val = customData[f.label] || '';
                    return `"${val.replace(/"/g, '""')}"`; // Escape quotes
                });

                const values = [
                    `"${row.participant_name}"`,
                    `"${row.email}"`,
                    `"${row.phone || ''}"`,
                    ...dynamicValues,
                    `"${row.status}"`,
                    `"${row.payment_status}"`,
                    `"${row.check_in_status || 'NotCheckedIn'}"`
                ];
                csvRows.push(values.join(','));
            }

            const blob = new Blob(["\uFEFF" + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `registrations_${currentEditingEventId}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ==================== PHASE 16: BATCH OPERATIONS & FILTERING ====================

        // --- Global Variables for Batch Operations ---
        let selectedRegistrations = new Set();
        let allFilteredRegistrations = [];
        let filterDebounceTimer = null;

        // --- Checkbox Selection Management ---
        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.reg-checkbox');
            const selectAllCheckbox = document.getElementById('select-all-checkbox');

            if (selectAllCheckbox.checked) {
                checkboxes.forEach(cb => {
                    cb.checked = true;
                    selectedRegistrations.add(cb.dataset.regId);
                });
            } else {
                checkboxes.forEach(cb => cb.checked = false);
                selectedRegistrations.clear();
            }

            updateBatchToolbar();
        }

        function toggleSelect(regId) {
            if (selectedRegistrations.has(regId)) {
                selectedRegistrations.delete(regId);
            } else {
                selectedRegistrations.add(regId);
            }

            updateBatchToolbar();
            updateSelectAllCheckbox();
        }

        function updateSelectAllCheckbox() {
            const checkboxes = document.querySelectorAll('.reg-checkbox');
            const selectAllCheckbox = document.getElementById('select-all-checkbox');

            if (!selectAllCheckbox) return;

            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const someChecked = Array.from(checkboxes).some(cb => cb.checked);

            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = someChecked && !allChecked;
        }

        function updateBatchToolbar() {
            const toolbar = document.getElementById('batch-toolbar');
            const count = selectedRegistrations.size;

            document.getElementById('selected-count').textContent = count;

            if (count > 0) {
                toolbar.classList.remove('hidden');
            } else {
                toolbar.classList.add('hidden');
            }
        }

        function clearSelection() {
            selectedRegistrations.clear();
            document.querySelectorAll('.reg-checkbox').forEach(cb => cb.checked = false);
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            updateBatchToolbar();
            playAudio('click');
        }

        // --- Batch Operations ---
        async function batchApprove() {
            if (selectedRegistrations.size === 0) {
                showPopup('æç¤º', 'è«‹å…ˆé¸æ“‡è¦æ ¸å‡†çš„å ±å', 'warning');
                return;
            }

            const count = selectedRegistrations.size;
            if (!confirm(`ç¢ºå®šè¦æ ¸å‡† ${count} ç­†å ±åå—ï¼Ÿ`)) return;

            playAudio('click');
            showLoadingOverlay();

            try {
                const regIds = Array.from(selectedRegistrations);
                const response = await fetch(getApiUrl(), {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'batchApprove',
                        regIds: regIds
                    })
                });

                const result = await response.json();
                hideLoadingOverlay();

                if (result.status === 'success') {
                    playAudio('success');
                    showPopup('æˆåŠŸ', `å·²æ ¸å‡† ${result.count || count} ç­†å ±å`, 'success');
                    clearSelection();
                    const eventData = allEventsData.find(e => e.event_id === currentEditingEventId);
                    if (eventData) {
                        await loadEventRegistrations(currentEditingEventId, eventData.form_config);
                    }
                    loadOverview();
                } else {
                    playAudio('error');
                    showPopup('å¤±æ•—', result.message || 'æ‰¹æ¬¡æ ¸å‡†å¤±æ•—', 'error');
                }
            } catch (error) {
                hideLoadingOverlay();
                playAudio('error');
                showPopup('éŒ¯èª¤', 'æ‰¹æ¬¡æ ¸å‡†æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }

        async function batchReject() {
            if (selectedRegistrations.size === 0) {
                showPopup('æç¤º', 'è«‹å…ˆé¸æ“‡è¦æ‹’çµ•çš„å ±å', 'warning');
                return;
            }

            const count = selectedRegistrations.size;
            if (!confirm(`ç¢ºå®šè¦æ‹’çµ• ${count} ç­†å ±åå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) return;

            playAudio('click');
            showLoadingOverlay();

            try {
                const regIds = Array.from(selectedRegistrations);
                const response = await fetch(getApiUrl(), {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'batchReject',
                        regIds: regIds
                    })
                });

                const result = await response.json();
                hideLoadingOverlay();

                if (result.status === 'success') {
                    playAudio('success');
                    showPopup('æˆåŠŸ', `å·²æ‹’çµ• ${result.count || count} ç­†å ±å`, 'success');
                    clearSelection();
                    const eventData = allEventsData.find(e => e.event_id === currentEditingEventId);
                    if (eventData) {
                        await loadEventRegistrations(currentEditingEventId, eventData.form_config);
                    }
                    loadOverview();
                } else {
                    playAudio('error');
                    showPopup('å¤±æ•—', result.message || 'æ‰¹æ¬¡æ‹’çµ•å¤±æ•—', 'error');
                }
            } catch (error) {
                hideLoadingOverlay();
                playAudio('error');
                showPopup('éŒ¯èª¤', 'æ‰¹æ¬¡æ‹’çµ•æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }

        function batchExport() {
            if (selectedRegistrations.size === 0) {
                showPopup('æç¤º', 'è«‹å…ˆé¸æ“‡è¦åŒ¯å‡ºçš„å ±å', 'warning');
                return;
            }

            playAudio('click');

            // Filter selected registrations
            const selectedData = currentEventRegistrations.filter(reg =>
                selectedRegistrations.has(reg.reg_id)
            );

            // Get Custom Fields Config
            const eventData = allEventsData.find(e => e.event_id === currentEditingEventId);
            let customFields = [];
            if (eventData && eventData.form_config) {
                try {
                    customFields = typeof eventData.form_config === 'string' ? JSON.parse(eventData.form_config) : eventData.form_config;
                } catch (e) { }
            }

            // Headers
            const headers = ['å§“å', 'Email', 'é›»è©±', ...customFields.map(f => f.label), 'ç‹€æ…‹', 'ä»˜æ¬¾ç‹€æ…‹', 'å ±åˆ°ç‹€æ…‹'];
            const csvRows = [headers.join(',')];

            // Rows
            for (const row of selectedData) {
                let customData = {};
                try {
                    customData = row.dynamic_data ? JSON.parse(row.dynamic_data) : {};
                } catch (e) { }

                const dynamicValues = customFields.map(f => {
                    const val = customData[f.label] || '';
                    return `"${val.replace(/"/g, '""')}"`;
                });

                const values = [
                    `"${row.participant_name}"`,
                    `"${row.email}"`,
                    `"${row.phone || ''}"`,
                    ...dynamicValues,
                    `"${row.status}"`,
                    `"${row.payment_status}"`,
                    `"${row.check_in_status || 'NotCheckedIn'}"`
                ];
                csvRows.push(values.join(','));
            }

            const blob = new Blob(["\uFEFF" + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `selected_registrations_${currentEditingEventId}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showPopup('æˆåŠŸ', `å·²åŒ¯å‡º ${selectedData.length} ç­†å ±å`, 'success');
        }

        // --- Advanced Filtering ---
        function applyFilters() {
            const statusFilter = document.getElementById('filter-status').value;
            const checkinFilter = document.getElementById('filter-checkin').value;
            const searchText = document.getElementById('filter-search').value.toLowerCase();

            let filtered = [...currentEventRegistrations];

            // Status filter
            if (statusFilter) {
                filtered = filtered.filter(reg => reg.status === statusFilter);
            }

            // Check-in filter
            if (checkinFilter === 'checked') {
                filtered = filtered.filter(reg => reg.check_in_status === 'CheckedIn');
            } else if (checkinFilter === 'not-checked') {
                filtered = filtered.filter(reg => !reg.check_in_status || reg.check_in_status === 'NotCheckedIn');
            }

            // Search filter
            if (searchText) {
                filtered = filtered.filter(reg => {
                    const name = (reg.participant_name || '').toLowerCase();
                    const email = (reg.email || '').toLowerCase();
                    const phone = (reg.phone || '').toLowerCase();
                    return name.includes(searchText) || email.includes(searchText) || phone.includes(searchText);
                });
            }

            allFilteredRegistrations = filtered;
            renderFilteredRegistrations(filtered);
            updateFilterIndicator();
            playAudio('click');
        }

        function resetFilters() {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-checkin').value = '';
            document.getElementById('filter-search').value = '';

            allFilteredRegistrations = [...currentEventRegistrations];
            renderFilteredRegistrations(currentEventRegistrations);
            updateFilterIndicator();
            playAudio('click');
        }

        function quickFilter(type) {
            resetFilters();

            const today = new Date().toISOString().split('T')[0];

            switch (type) {
                case 'today':
                    allFilteredRegistrations = currentEventRegistrations.filter(reg => {
                        const regDate = new Date(reg.registration_date).toISOString().split('T')[0];
                        return regDate === today;
                    });
                    break;
                case 'pending':
                    document.getElementById('filter-status').value = 'Pending';
                    applyFilters();
                    return;
                case 'approved':
                    document.getElementById('filter-status').value = 'Approved';
                    applyFilters();
                    return;
                case 'checked-in':
                    document.getElementById('filter-checkin').value = 'checked';
                    applyFilters();
                    return;
            }

            renderFilteredRegistrations(allFilteredRegistrations);
            updateFilterIndicator();
            playAudio('click');
        }

        function debounceFilter() {
            clearTimeout(filterDebounceTimer);
            filterDebounceTimer = setTimeout(() => {
                applyFilters();
            }, 300);
        }

        function updateFilterIndicator() {
            const indicator = document.getElementById('filter-active-indicator');
            const count = document.getElementById('filter-result-count');
            const filtered = allFilteredRegistrations.length;
            const total = currentEventRegistrations.length;

            count.textContent = filtered;

            if (filtered < total) {
                indicator.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
            }
        }

        function renderFilteredRegistrations(registrations) {
            // Store the filtered data
            allFilteredRegistrations = registrations;

            // Re-render the registration table with filtered data
            const tbody = document.getElementById('registrations-list-body');
            if (!tbody) return;

            // Clear existing rows
            tbody.innerHTML = '';

            if (registrations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="100" class="px-6 py-8 text-center text-slate-400">
                            <i class="fas fa-inbox text-4xl mb-2"></i>
                            <p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å ±å</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // Get custom fields for this event
            const eventData = allEventsData.find(e => e.event_id === currentEditingEventId);
            let customFields = [];
            if (eventData && eventData.form_config) {
                try {
                    customFields = typeof eventData.form_config === 'string' ? JSON.parse(eventData.form_config) : eventData.form_config;
                } catch (e) { }
            }

            // Render each registration
            registrations.forEach(reg => {
                const row = createRegistrationRow(reg, customFields);
                tbody.appendChild(row);
            });
        }

        function createRegistrationRow(reg, customFields) {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-slate-50 transition-colors';

            // Parse custom data
            let customData = {};
            try {
                customData = reg.dynamic_data ? JSON.parse(reg.dynamic_data) : {};
            } catch (e) { }

            // Checkbox cell
            const checkboxCell = document.createElement('td');
            checkboxCell.className = 'px-4 py-3 text-center';
            checkboxCell.innerHTML = `
                <input type="checkbox" 
                    class="reg-checkbox w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 cursor-pointer" 
                    data-reg-id="${reg.reg_id}"
                    onchange="toggleSelect('${reg.reg_id}')"
                    ${selectedRegistrations.has(reg.reg_id) ? 'checked' : ''}>
            `;
            tr.appendChild(checkboxCell);

            // Name cell
            const nameCell = document.createElement('td');
            nameCell.className = 'px-4 py-3 font-medium text-slate-900 border-b border-slate-50';
            nameCell.textContent = reg.participant_name;
            tr.appendChild(nameCell);

            // Email cell
            const emailCell = document.createElement('td');
            emailCell.className = 'px-4 py-3 text-sm text-slate-600';
            emailCell.textContent = reg.email;
            tr.appendChild(emailCell);

            // Phone cell
            const phoneCell = document.createElement('td');
            phoneCell.className = 'px-4 py-3 text-sm text-slate-600';
            phoneCell.textContent = reg.phone || '-';
            tr.appendChild(phoneCell);

            // Custom fields
            customFields.forEach(field => {
                const cell = document.createElement('td');
                cell.className = 'px-4 py-3 text-sm text-slate-600';
                cell.textContent = customData[field.label] || '-';
                tr.appendChild(cell);
            });

            // Registration Status cell
            const statusCell = document.createElement('td');
            statusCell.className = 'px-4 py-3 border-b border-slate-50';
            statusCell.innerHTML = getStatusBadge(reg.status);
            tr.appendChild(statusCell);

            // Payment Status cell
            const paymentCell = document.createElement('td');
            paymentCell.className = 'px-4 py-3 border-b border-slate-50';
            paymentCell.innerHTML = getPaymentBadge(reg.payment_status);
            tr.appendChild(paymentCell);

            // Check-in status cell
            const checkinCell = document.createElement('td');
            checkinCell.className = 'px-4 py-3 text-sm border-b border-slate-50';
            if (reg.check_in_status === 'CheckedIn') {
                checkinCell.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-green-600 font-medium whitespace-nowrap">âœ“ å·²å ±åˆ°</span>
                        <span class="text-xs text-slate-400 whitespace-nowrap">${reg.check_in_time || ''}</span>
                    </div>
                `;
            } else {
                checkinCell.innerHTML = '<span class="text-slate-400 whitespace-nowrap">â—‹ æœªå ±åˆ°</span>';
            }
            tr.appendChild(checkinCell);

            // Actions cell
            const actionsCell = document.createElement('td');
            actionsCell.className = 'px-4 py-3 border-b border-slate-50';
            actionsCell.innerHTML = `
                <div class="flex gap-2">
                    ${reg.status === 'Pending' ? `
                        <button onclick="quickApprove('${reg.reg_id}')" 
                            class="px-3 py-1 bg-green-100 hover:bg-green-200 text-green-700 rounded text-xs font-medium transition-colors"
                            title="å¿«é€Ÿæ ¸å‡†">
                            <i class="fas fa-check"></i>
                        </button>
                        <button onclick="quickReject('${reg.reg_id}')" 
                            class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded text-xs font-medium transition-colors"
                            title="å¿«é€Ÿæ‹’çµ•">
                            <i class="fas fa-times"></i>
                        </button>
                    ` : ''}
                    ${(reg.payment_status !== 'Paid') ? `
                        <button onclick="updatePaymentStatus('${reg.reg_id}', 'Paid')" 
                            class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs font-medium transition-colors"
                            title="è¨»è¨˜å·²ä»˜æ¬¾">
                            <i class="fas fa-hand-holding-usd"></i>
                        </button>
                    ` : ''}
                </div>
            `;
            tr.appendChild(actionsCell);

            return tr;
        }

        function getStatusBadge(status) {
            const badges = {
                'Pending': '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-medium whitespace-nowrap">â³ å¯©æ ¸ä¸­</span>',
                'Approved': '<span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium whitespace-nowrap">âœ… å·²æ ¸å‡†</span>',
                'Rejected': '<span class="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-medium whitespace-nowrap">âŒ å·²æ‹’çµ•</span>'
            };
            return badges[status] || `<span class="px-2 py-1 bg-slate-100 text-slate-600 rounded-full text-xs font-medium whitespace-nowrap">${status}</span>`;
        }

        function getPaymentBadge(status) {
            const badges = {
                'Unpaid': '<span class="px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-medium whitespace-nowrap">ğŸ’³ æœªç¹³è²»</span>',
                'Paid': '<span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-medium whitespace-nowrap">ğŸ’° å·²ç¹³è²»</span>'
            };
            return badges[status] || `<span class="px-2 py-1 bg-slate-100 text-slate-600 rounded-full text-xs font-medium whitespace-nowrap">${status || 'æœªè¨­å®š'}</span>`;
        }

        // --- Quick Actions ---
        async function quickApprove(regId) {
            playAudio('click');
            showLoadingOverlay();

            try {
                const response = await fetch(getApiUrl(), {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'updateStatus',
                        regId: regId,
                        status: 'Approved',
                        currentUser: currentUser ? currentUser.name : 'admin'
                    })
                });

                const result = await response.json();
                hideLoadingOverlay();

                if (result.status === 'success') {
                    playAudio('success');
                    showPopup('æˆåŠŸ', 'å·²æ ¸å‡†å ±å', 'success');
                    const eventData = allEventsData.find(e => e.event_id === currentEditingEventId);
                    if (eventData) {
                        await loadEventRegistrations(currentEditingEventId, eventData.form_config);
                    }
                } else {
                    playAudio('error');
                    showPopup('å¤±æ•—', 'æ ¸å‡†å¤±æ•—', 'error');
                }
            } catch (error) {
                hideLoadingOverlay();
                playAudio('error');
                showPopup('éŒ¯èª¤', 'æ ¸å‡†æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }

        async function quickReject(regId) {
            if (!confirm('ç¢ºå®šè¦æ‹’çµ•æ­¤å ±åå—ï¼Ÿ')) return;

            playAudio('click');
            showLoadingOverlay();

            try {
                const response = await fetch(getApiUrl(), {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'updateStatus',
                        regId: regId,
                        status: 'Rejected',
                        currentUser: currentUser ? currentUser.name : 'admin'
                    })
                });

                const result = await response.json();
                hideLoadingOverlay();

                if (result.status === 'success') {
                    playAudio('success');
                    showPopup('æˆåŠŸ', 'å·²æ‹’çµ•å ±å', 'success');
                    const eventData = allEventsData.find(e => e.event_id === currentEditingEventId);
                    if (eventData) {
                        await loadEventRegistrations(currentEditingEventId, eventData.form_config);
                    }
                } else {
                    playAudio('error');
                    showPopup('å¤±æ•—', 'æ‹’çµ•å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error("Quick Reject Error:", error);
                hideLoadingOverlay();
                playAudio('error');
                showPopup('éŒ¯èª¤', 'æ‹’çµ•æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }

        async function confirmDeleteEvent() {
            const eventId = document.getElementById('edit-evt-id').value;
            if (!eventId) return;

            if (!confirm('ğŸ›‘ è­¦å‘Šï¼šç¢ºå®šè¦åˆªé™¤æ­¤æ´»å‹•å—ï¼Ÿ\n\né€™å°‡æœƒæ°¸ä¹…åˆªé™¤æ­¤æ´»å‹•åŠå…¶ã€Œæ‰€æœ‰å ±åè³‡æ–™ã€ï¼Œæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;

            playAudio('click');
            showLoadingOverlay();

            try {
                const response = await fetch(getApiUrl(), {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'deleteEvent',
                        eventId: eventId,
                        currentUser: currentUser ? currentUser.name : 'admin'
                    })
                });

                const result = await response.json();
                hideLoadingOverlay();

                if (result.status === 'success') {
                    playAudio('success');
                    showPopup('æˆåŠŸ', 'æ´»å‹•å·²æˆåŠŸåˆªé™¤', 'success');
                    closeEventManager();
                    loadEvents();
                } else {
                    playAudio('error');
                    showPopup('å¤±æ•—', result.message || 'åˆªé™¤å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error("Delete Event Error:", error);
                hideLoadingOverlay();
                playAudio('error');
                showPopup('éŒ¯èª¤', 'åˆªé™¤æ´»å‹•æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }

        // --- Keyboard Shortcuts ---
        document.addEventListener('keydown', (e) => {
            // Ignore if typing in input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            switch (e.key.toLowerCase()) {
                case 'a':
                    if (selectedRegistrations.size > 0) {
                        e.preventDefault();
                        batchApprove();
                    }
                    break;
                case 'r':
                    if (selectedRegistrations.size > 0) {
                        e.preventDefault();
                        batchReject();
                    }
                    break;
                case '/':
                    e.preventDefault();
                    const searchBox = document.getElementById('filter-search');
                    if (searchBox) searchBox.focus();
                    break;
                case 'escape':
                    clearSelection();
                    break;
            }
        });

        // ==================== END PHASE 16 ====================

        // ==================== PHASE 17: DASHBOARD, LOGS, PERMISSIONS, AI ====================

        // --- Global Variables for Phase 17 ---
        let dashboardCharts = {
            trend: null,
            status: null
        };
        let currentLogPage = 1;
        const logsPerPage = 50;
        let allLogs = [];
        let currentUserPermissions = {};
        let dashboardRefreshInterval = null;

        // --- Dashboard Functions (Phase 17.3) ---
        async function loadDashboard() {
            try {
                showLoadingOverlay();

                // Initialize charts if they don't exist
                if (!dashboardCharts.trend || !dashboardCharts.status) {
                    initializeDashboardCharts();
                }

                // Load and refresh dashboard data
                await refreshDashboard();

                // Start auto-refresh (every 30 seconds)
                if (dashboardRefreshInterval) clearInterval(dashboardRefreshInterval);
                dashboardRefreshInterval = setInterval(() => {
                    refreshDashboard();
                }, 30000);

                hideLoadingOverlay();
            } catch (error) {
                console.error('Dashboard load error:', error);
                hideLoadingOverlay();
                showPopup('éŒ¯èª¤', 'è¼‰å…¥å„€è¡¨æ¿å¤±æ•—', 'error');
            }
        }

        async function refreshDashboard() {
            try {
                showLoadingOverlay();
                const targetUrl = getApiUrl();
                const response = await fetch(`${targetUrl}?action=getEventStatistics`);
                const result = await response.json();

                if (result.status === 'success') {
                    const stats = result.stats;

                    // Update Stat Cards
                    document.getElementById('stat-total-events').textContent = stats.global.totalEvents;
                    document.getElementById('stat-total-registrations').textContent = stats.global.totalRegistrations;
                    document.getElementById('stat-pending').textContent = stats.global.pending;
                    document.getElementById('stat-checkin-rate').textContent = stats.global.checkInRate;

                    // Update Last Update Time
                    const lastUpdateSpan = document.getElementById('dashboard-last-update');
                    if (lastUpdateSpan) lastUpdateSpan.textContent = `æœ€å¾Œæ›´æ–°: ${new Date().toLocaleTimeString()}`;

                    // Update Charts
                    updateCharts(stats);

                    // Update Active Events Table
                    renderActiveEvents(stats.activeEvents);

                    playAudio('success');
                } else {
                    showPopup('éŒ¯èª¤', 'ç„¡æ³•ç²å–çµ±è¨ˆæ•¸æ“š', 'error');
                }
            } catch (error) {
                console.error('Refresh dashboard error:', error);
                showPopup('éŒ¯èª¤', 'åˆ·æ–°å„€è¡¨æ¿å¤±æ•—', 'error');
            } finally {
                hideLoadingOverlay();
            }
        }

        function updateCharts(stats) {
            // Trend Chart
            if (dashboardCharts.trend) {
                const labels = Object.keys(stats.trend).reverse().map(dateStr => {
                    const d = new Date(dateStr);
                    return d.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' });
                });
                const data = Object.values(stats.trend).reverse();

                dashboardCharts.trend.data.labels = labels;
                dashboardCharts.trend.data.datasets[0].data = data;
                dashboardCharts.trend.update();
            }

            // Status Chart
            if (dashboardCharts.status) {
                const dist = stats.distribution;
                dashboardCharts.status.data.datasets[0].data = [dist.Pending, dist.Approved, dist.Rejected];
                dashboardCharts.status.update();
            }
        }

        function renderActiveEvents(events) {
            const tbody = document.getElementById('dashboard-events-body');
            if (!tbody) return;

            if (!events || events.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-slate-400">å°šç„¡é€²è¡Œä¸­çš„æ´»å‹•</td></tr>';
                return;
            }

            tbody.innerHTML = events.map(e => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4 text-sm font-bold text-slate-800 break-words min-w-[200px]">${e.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${new Date(e.date).toLocaleDateString('zh-TW')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${e.regCount}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="w-full bg-slate-100 rounded-full h-2 max-w-[100px]">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: ${Math.min(e.capacityRate, 100)}%"></div>
                        </div>
                        <span class="text-[10px] text-slate-400 mt-1">${e.capacityRate}%</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium">é€²è¡Œä¸­</span>
                    </td>
                </tr>
            `).join('');
        }

        // --- AI Assisted Table Logic (Phase 17.4) ---
        function detectDuplicates() {
            playAudio('click');
            const regs = currentEventRegistrations;
            if (!regs || regs.length < 2) {
                showPopup('æç¤º', 'ç›®å‰æ²’æœ‰è¶³å¤ çš„å ±åè³‡æ–™é€²è¡Œæ¯”å°', 'info');
                return;
            }

            const duplicates = [];
            const seen = new Map();

            regs.forEach(r => {
                // Key based on name + phone + email (normalized)
                const phone = String(r.phone || '').replace(/\D/g, '');
                const email = String(r.email || '').toLowerCase().trim();
                const name = String(r.participant_name || '').trim();

                // We check for matching email OR matching phone + name
                const key1 = email && email.length > 5 ? `email:${email}` : null;
                const key2 = (name && phone) ? `namephone:${name}-${phone}` : null;

                const keys = [key1, key2].filter(k => k);
                let foundMatch = false;

                keys.forEach(k => {
                    if (seen.has(k)) {
                        const original = seen.get(k);
                        duplicates.push(r.reg_id);
                        if (!duplicates.includes(original.reg_id)) duplicates.push(original.reg_id);
                        foundMatch = true;
                    } else {
                        seen.set(k, r);
                    }
                });
            });

            if (duplicates.length > 0) {
                playAudio('warning');
                showPopup('åµæ¸¬çµæœ', `ç™¼ç¾ ${duplicates.length} ç­†ç–‘ä¼¼é‡è¤‡çš„å ±åè³‡æ–™ï¼Œå·²ç‚ºæ‚¨æ¨™è¨˜ã€‚`, 'warning');
                highlightDuplicates(duplicates);
            } else {
                showPopup('åµæ¸¬çµæœ', 'æœªç™¼ç¾æ˜é¡¯çš„é‡è¤‡å ±åè³‡æ–™', 'success');
            }
        }

        function highlightDuplicates(ids) {
            // Apply a visual class to rows
            ids.forEach(id => {
                const row = document.querySelector(`tr[data-reg-id="${id}"]`);
                if (row) {
                    row.classList.add('bg-orange-50', 'ring-1', 'ring-orange-200');
                    // Add a warning icon if not present
                    if (!row.querySelector('.duplicate-warning')) {
                        const cell = row.cells[1]; // Name cell
                        const icon = document.createElement('span');
                        icon.className = 'duplicate-warning ml-2 text-orange-500 tooltip';
                        icon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                        icon.title = 'ç–‘ä¼¼é‡è¤‡å ±å';
                        cell.appendChild(icon);
                    }
                }
            });
        }

        function suggestAutoApprovals() {
            playAudio('click');
            const pendingRegs = currentEventRegistrations.filter(r => r.status === 'Pending');
            if (pendingRegs.length === 0) {
                showPopup('æç¤º', 'ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„å ±å', 'info');
                return;
            }

            // Simple "AI" logic: Suggest approval if:
            // 1. Participant name exists in a "trusted" list (mocked here as having a specific internal email domain or keyword)
            // 2. Or they have previously registered (demonstrated by checking for common domains or keywords)
            const suggested = pendingRegs.filter(r => {
                const email = String(r.email || '').toLowerCase();
                const name = String(r.participant_name || '');
                return email.endsWith('.edu.tw') || email.endsWith('.org.tw') || name.includes('VIP') || name.includes('æ¸¬è©¦');
            });

            if (suggested.length > 0) {
                playAudio('success');
                showPopup('AI å»ºè­°', `æ ¹æ“šæ­·å²è³‡æ–™ï¼Œå»ºè­°å¯ä»¥æ ¸å‡† ${suggested.length} ç­†å ±åã€‚`, 'success');

                // Highlight suggested rows
                suggested.forEach(r => {
                    const row = document.querySelector(`tr[data-reg-id="${r.reg_id}"]`);
                    if (row) {
                        row.classList.add('bg-cyan-50', 'ring-1', 'ring-cyan-200');
                        // Add a sparkle icon
                        if (!row.querySelector('.ai-suggestion')) {
                            const cell = row.cells[1];
                            const icon = document.createElement('span');
                            icon.className = 'ai-suggestion ml-2 text-cyan-500';
                            icon.innerHTML = '<i class="fas fa-magic"></i>';
                            cell.appendChild(icon);
                        }
                    }
                });
            } else {
                showPopup('æç¤º', 'AI æœªç™¼ç¾ç¬¦åˆå¿«é€Ÿæ ¸å‡†æ¢ä»¶çš„å ±å', 'info');
            }
        }

        function initializeDashboardCharts() {
            // Destroy existing charts
            if (dashboardCharts.status) dashboardCharts.status.destroy();

            // Create trend chart
            createTrendChart();

            // Create status distribution chart
            createStatusChart();
        }

        function createTrendChart() {
            const ctx = document.getElementById('trend-chart');
            if (!ctx) return;

            const period = parseInt(document.getElementById('trend-period').value) || 7;
            const registrations = window.dashboardData?.registrations || [];

            // Generate last N days
            const labels = [];
            const data = [];
            const today = new Date();

            for (let i = period - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                labels.push(date.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' }));

                // Count registrations on this date
                const count = registrations.filter(r => {
                    const regDate = new Date(r.registration_date).toISOString().split('T')[0];
                    return regDate === dateStr;
                }).length;

                data.push(count);
            }

            dashboardCharts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å ±åæ•¸',
                        data: data,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function createStatusChart() {
            const ctx = document.getElementById('status-chart');
            if (!ctx) return;

            const registrations = window.dashboardData?.registrations || [];

            // Count by status
            const pending = registrations.filter(r => r.status === 'Pending').length;
            const approved = registrations.filter(r => r.status === 'Approved').length;
            const rejected = registrations.filter(r => r.status === 'Rejected').length;

            dashboardCharts.status = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['å¾…å¯©æ ¸', 'å·²æ ¸å‡†', 'å·²æ‹’çµ•'],
                    datasets: [{
                        data: [pending, approved, rejected],
                        backgroundColor: [
                            'rgb(234, 179, 8)',
                            'rgb(34, 197, 94)',
                            'rgb(239, 68, 68)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTrendChart() {
            createTrendChart();
        }

        // --- Operation Logs Functions (Phase 17.2) ---
        async function loadLogs(page = 1) {
            try {
                currentLogPage = page;
                showLoadingOverlay();

                const userFilter = document.getElementById('log-filter-user').value;
                const actionFilter = document.getElementById('log-filter-action').value;
                // Date filter not yet supported by simple GAS backend for now, or we can filter client side.
                // Let's pass what we have.

                let url = `${API_URL}?action=getOperationLogs&page=${page}&limit=${logsPerPage}`;
                if (userFilter) url += `&user=${encodeURIComponent(userFilter)}`;
                if (actionFilter) url += `&actionType=${encodeURIComponent(actionFilter)}`;

                const response = await fetch(url);
                const result = await response.json();

                if (result.status === 'success') {
                    allLogs = result.data; // Current page data
                    renderLogs(result.data);

                    // Update pagination based on total if available, or simple next/prev
                    // Backend returns total? 
                    // If backend doesn't return total count, we might need to adjust logic.
                    // For now, let's assume simple pagination: if less than limit, disable next.

                    const prevBtn = document.getElementById('logs-prev-btn');
                    const nextBtn = document.getElementById('logs-next-btn');

                    document.getElementById('logs-current-page').textContent = page;

                    if (prevBtn) prevBtn.disabled = page <= 1;
                    if (nextBtn) nextBtn.disabled = result.data.length < logsPerPage;

                } else {
                    console.error('Logs error:', result.message);
                    renderLogs([]);
                }

                hideLoadingOverlay();
            } catch (error) {
                console.error('Load logs error:', error);
                hideLoadingOverlay();
                showPopup('éŒ¯èª¤', 'è¼‰å…¥æ“ä½œæ—¥èªŒå¤±æ•—', 'error');
            }
        }

        function renderLogs(logs) {
            const tbody = document.getElementById('logs-table-body');
            if (!tbody) return;

            if (!logs || logs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-slate-400">
                            æ²’æœ‰æ“ä½œè¨˜éŒ„
                        </td>
                    </tr>
                `;
                document.getElementById('logs-showing').textContent = 0;
                return;
            }

            tbody.innerHTML = logs.map(log => {
                const date = new Date(log.timestamp);
                const timeStr = date.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });

                const actionLabels = {
                    'APPROVE_REGISTRATION': 'æ ¸å‡†å ±å',
                    'REJECT_REGISTRATION': 'æ‹’çµ•å ±å',
                    'CREATE_EVENT': 'å»ºç«‹æ´»å‹•',
                    'UPDATE_EVENT': 'æ›´æ–°æ´»å‹•',
                    'DELETE_EVENT': 'åˆªé™¤æ´»å‹•',
                    'BATCH_APPROVE': 'æ‰¹æ¬¡æ ¸å‡†',
                    'BATCH_REJECT': 'æ‰¹æ¬¡æ‹’çµ•',
                    'CREATE_USER': 'å»ºç«‹å¸³è™Ÿ',
                    'DELETE_USER': 'åˆªé™¤å¸³è™Ÿ',
                    'UPDATE_USER_ROLE': 'æ›´æ–°æ¬Šé™'
                };

                const actionLabel = actionLabels[log.action] || log.action;

                // Parse details if string
                let detailsText = log.details;
                if (typeof detailsText === 'string' && (detailsText.startsWith('{') || detailsText.startsWith('['))) {
                    // try to make it readable? or just show as is
                } else if (typeof detailsText === 'object') {
                    detailsText = JSON.stringify(detailsText);
                }

                return `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-6 py-4 text-sm text-slate-600">${timeStr}</td>
                        <td class="px-6 py-4 text-sm font-medium text-slate-900">${log.user}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium">
                                ${actionLabel}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-600">${log.target_id || '-'}</td>
                        <td class="px-6 py-4 text-sm text-slate-600 font-mono truncate max-w-xs" title="${detailsText}">${detailsText}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('logs-showing').textContent = logs.length;
        }

        function updateLogsPagination(totalLogs) {
            // Handled in loadLogs
        }

        function applyLogFilters() {
            loadLogs(1); // Reload from page 1 with new filters
        }

        function resetLogFilters() {
            document.getElementById('log-filter-user').value = '';
            document.getElementById('log-filter-action').value = '';
            document.getElementById('log-filter-date').value = '';
            loadLogs(1);
        }

        // --- Permissions System (Phase 17.1) ---
        async function loadUserPermissions() {
            try {
                // Permissions are loaded from currentUser object set during login
                if (!currentUser) return;

                currentUserPermissions = {
                    role: currentUser.role || 'viewer',
                    canCreateEvent: ['super_admin', 'admin'].includes(currentUser.role),
                    canEditEvent: ['super_admin', 'admin'].includes(currentUser.role),
                    canDeleteEvent: ['super_admin'].includes(currentUser.role),
                    canApproveRegistration: ['super_admin', 'admin'].includes(currentUser.role),
                    canRejectRegistration: ['super_admin', 'admin'].includes(currentUser.role),
                    canManageUsers: ['super_admin'].includes(currentUser.role),
                    canViewLogs: ['super_admin', 'admin'].includes(currentUser.role),
                    canExportData: ['super_admin', 'admin', 'viewer'].includes(currentUser.role)
                };

                // Update UI
                updatePermissionsUI();

            } catch (error) {
                console.error('Load permissions error:', error);
            }
        }

        function updatePermissionsUI() {
            const role = currentUserPermissions.role || 'admin';
            const roleLabels = {
                'super_admin': 'è¶…ç´šç®¡ç†å“¡',
                'admin': 'ç®¡ç†å“¡',
                'viewer': 'æª¢è¦–è€…'
            };

            const roleDisplay = document.getElementById('user-role-display');
            if (roleDisplay) {
                roleDisplay.textContent = roleLabels[role] || role;
            }

            // Hide/show features based on permissions
            if (!currentUserPermissions.canManageUsers) {
                const usersTab = document.getElementById('tab-users');
                if (usersTab) usersTab.style.display = 'none';
            }

            if (!currentUserPermissions.canViewLogs) {
                const logsTab = document.getElementById('tab-logs');
                if (logsTab) logsTab.style.display = 'none';
            }
        }

        function checkPermission(permission) {
            return currentUserPermissions[permission] === true;
        }

        // --- AI Assistance Features (Phase 17.4) ---
        function detectDuplicateRegistrations(registrations) {
            const duplicates = [];
            const seen = new Map();

            registrations.forEach(reg => {
                const key = `${reg.email}_${reg.event_id}`;
                if (seen.has(key)) {
                    duplicates.push({
                        original: seen.get(key),
                        duplicate: reg
                    });
                } else {
                    seen.set(key, reg);
                }
            });

            return duplicates;
        }

        function suggestAutoApproval(registration) {
            // Simple AI logic: auto-approve if email domain is trusted
            const trustedDomains = ['gmail.com', 'yahoo.com', 'hotmail.com'];
            const emailDomain = registration.email.split('@')[1];

            if (trustedDomains.includes(emailDomain)) {
                return {
                    suggested: true,
                    confidence: 0.8,
                    reason: 'ä¾†è‡ªä¿¡ä»»çš„é›»å­éƒµä»¶åŸŸå'
                };
            }

            return {
                suggested: false,
                confidence: 0.5,
                reason: 'éœ€è¦äººå·¥å¯©æ ¸'
            };
        }

        function naturalLanguageSearch(query) {
            // Simple pattern matching for natural language
            const registrations = currentEventRegistrations || [];

            if (query.includes('ä»Šå¤©') || query.includes('today')) {
                const today = new Date().toISOString().split('T')[0];
                return registrations.filter(r => {
                    const regDate = new Date(r.registration_date).toISOString().split('T')[0];
                    return regDate === today;
                });
            }

            if (query.includes('å¾…å¯©æ ¸') || query.includes('pending')) {
                return registrations.filter(r => r.status === 'Pending');
            }

            if (query.includes('å·²å ±åˆ°') || query.includes('checked in')) {
                return registrations.filter(r =>
                    r.check_in_status === 'CheckedIn'
                );
            }

            // Default: search by name
            return registrations.filter(r =>
                r.participant_name.toLowerCase().includes(query.toLowerCase())
            );
        }

        // --- Helper: Log Operation (for future backend integration) ---
        function logOperation(action, targetType, targetId, details) {
            // This would call backend API in production
            console.log('Log Operation:', {
                user: currentUser?.username,
                action,
                targetType,
                targetId,
                details,
                timestamp: new Date().toISOString()
            });
        }

        // --- Initialize Phase 17 on Login ---
        async function initializePhase17() {
            await loadUserPermissions();
        }

        // ==================== END PHASE 17 ====================



        /*
                // --- Original Code Disabled for Debugging ---
                // ... (rest of the file content from line 725 to 1890) ...\n        */

        // --- Account Management Logic ---
        async function loadUsers() {
            const body = document.getElementById('users-list-body');
            body.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center"><i class="fas fa-spinner fa-spin mr-2"></i>è¼‰å…¥ä¸­...</td></tr>';

            try {
                const res = await fetch(`${getApiUrl()}?action=getUsers`);
                const json = await res.json();

                if (json.status === 'success' && json.data.length) {
                    body.innerHTML = json.data.map(u => {
                        const isSuperAdmin = currentUser && currentUser.role === 'super_admin';
                        const isSelf = currentUser && currentUser.username === u.username;
                        const isAdminUser = u.username === 'admin';

                        let roleHtml = `<span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-bold">${u.role}</span>`;

                        if (isSuperAdmin && !isAdminUser && !isSelf) {
                            roleHtml = `
                                <select onchange="changeUserRole('${u.sys_id}', this.value)" class="bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded px-2 py-1 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="super_admin" ${u.role === 'super_admin' ? 'selected' : ''}>Super Admin</option>
                                    <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
                                    <option value="viewer" ${u.role === 'viewer' ? 'selected' : ''}>Viewer</option>
                                </select>
                            `;
                        }

                        return `
                            <tr class="hover:bg-slate-50 transition-colors">
                                <td class="px-6 py-4 font-medium text-slate-800">${u.username}</td>
                                <td class="px-6 py-4 text-slate-600">${u.name}</td>
                                <td class="px-6 py-4">${roleHtml}</td>
                                <td class="px-6 py-4">
                                    ${isAdminUser || isSelf ? '<span class="text-xs text-slate-400">ç„¡æ³•æ“ä½œ</span>' :
                                `<button onclick="deleteUser('${u.sys_id}')" class="text-red-500 hover:text-red-700 text-sm font-medium">åˆªé™¤</button>`}
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    body.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center">ç„¡å¸³è™Ÿè³‡æ–™</td></tr>';
                }
            } catch (e) {
                console.error(e);
                body.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }

        async function changeUserRole(sysId, newRole) {
            try {
                showLoadingOverlay();
                const res = await fetch(getApiUrl(), {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'updateUserRole',
                        sysId: sysId,
                        role: newRole,
                        currentUser: currentUser.username
                    })
                });
                const json = await res.json();
                if (json.status === 'success') {
                    playAudio('success');
                    showPopup('æˆåŠŸ', 'æ¬Šé™å·²æ›´æ–°', 'success');
                    loadUsers();
                } else {
                    playAudio('error');
                    showPopup('éŒ¯èª¤', json.message, 'error');
                }
            } catch (e) {
                showPopup('éŒ¯èª¤', 'æ›´æ–°å¤±æ•—', 'error');
            } finally {
                hideLoadingOverlay();
            }
        }

        function openCreateUserModal() {
            playAudio('popup');
            document.getElementById('create-user-modal').classList.remove('hidden');
        }

        async function deleteUser(sysId) {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å¸³è™Ÿï¼Ÿ")) return;
            try {
                setLoading(true);
                const res = await fetch(getApiUrl(), { method: 'POST', body: JSON.stringify({ action: 'deleteUser', sysId: sysId }) });
                const json = await res.json();
                if (json.status === 'success') {
                    showPopup('æˆåŠŸ', 'å¸³è™Ÿå·²åˆªé™¤', 'success');
                    loadUsers();
                } else {
                    showPopup('éŒ¯èª¤', json.message, 'error');
                }
            } catch (e) {
                showPopup('éŒ¯èª¤', 'åˆªé™¤å¤±æ•—', 'error');
            } finally {
                setLoading(false);
            }
        }

        // Ensure create user form works
        document.getElementById('create-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            setLoading(true, btn);

            try {
                const payload = {
                    action: 'createUser',
                    username: document.getElementById('new-u-username').value,
                    password: document.getElementById('new-u-password').value,
                    name: document.getElementById('new-u-name').value,
                    role: document.getElementById('new-u-role').value
                };

                const res = await fetch(getApiUrl(), { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();

                if (json.status === 'success') {
                    document.getElementById('create-user-modal').classList.add('hidden');
                    e.target.reset();
                    showPopup('æˆåŠŸ', 'å¸³è™Ÿå»ºç«‹æˆåŠŸ', 'success');
                    loadUsers();
                } else {
                    showPopup('éŒ¯èª¤', json.message, 'error');
                }
            } catch (err) {
                showPopup('éŒ¯èª¤', 'é€£ç·šå¤±æ•—', 'error');
            } finally {
                setLoading(false, btn);
            }
        });


        // --- Tab Logic ---
        function switchModalTab(tab) {
            // UI Classes
            const activeClass = "border-b-2 border-blue-600 text-blue-700 bg-blue-50/50 px-4 font-bold";
            const inactiveClass = "text-gray-500 hover:text-gray-700 px-4 font-medium";

            // Reset buttons
            ['info', 'regs', 'checkin', 'landing'].forEach(t => {
                const btn = document.getElementById(`mtab-${t}`);
                if (btn) {
                    if (t === 'checkin') {
                        // Preserve the badge for checkin tab
                        btn.className = `py-3 text-sm font-medium transition-colors flex items-center ${t === tab ? activeClass : inactiveClass}`;
                    } else if (t === 'landing') {
                        // Preserve the icon for landing tab
                        btn.className = `py-3 text-sm font-medium transition-colors flex items-center ${t === tab ? activeClass : inactiveClass}`;
                    } else {
                        btn.className = `py-3 text-sm font-medium transition-colors ${t === tab ? activeClass : inactiveClass}`;
                    }
                }
            });

            // Toggle Content
            document.getElementById('mview-info').classList.toggle('hidden', tab !== 'info');
            document.getElementById('mview-regs').classList.toggle('hidden', tab !== 'regs');
            const checkinView = document.getElementById('mview-checkin');
            if (checkinView) checkinView.classList.toggle('hidden', tab !== 'checkin');
            const landingView = document.getElementById('mview-landing');
            if (landingView) landingView.classList.toggle('hidden', tab !== 'landing');

            // Logic Hooks
            if (tab === 'regs') {
                loadModalRegistrations();
            }

            // Console Scanner Hook
            if (tab === 'checkin') {
                loadOverview(); // Update stats
                updateConsoleStats(); // UPDATE STATS
                // startConsoleScanner(); // Auto-start removed
            }

            // Landing Page Hook
            if (tab === 'landing') {
                initLandingPageTab(); // Initialize URL and QR Code
            }
        }

        // --- Check-in Console Logic ---
        function updateConsoleStats() {
            if (!currentEventRegistrations) return;

            const total = currentEventRegistrations.length;
            const checkedIn = currentEventRegistrations.filter(r => r.check_in_status === 'CheckedIn').length;
            const unchecked = total - checkedIn;
            const rate = total > 0 ? Math.round((checkedIn / total) * 100) : 0;

            // Animate Numbers
            animateValue("console-total", parseInt(document.getElementById("console-total").innerText) || 0, total, 500);
            animateValue("console-checked-in", parseInt(document.getElementById("console-checked-in").innerText) || 0, checkedIn, 500);
            animateValue("console-unchecked", parseInt(document.getElementById("console-unchecked").innerText) || 0, unchecked, 500);
            document.getElementById("console-rate").innerText = `${rate}%`;
        }

        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            const obj = document.getElementById(id);
            if (!obj) return;

            const timer = setInterval(() => {
                current += increment;
                obj.innerText = current;
                if (current == end) { clearInterval(timer); }
            }, Math.max(stepTime, 20)); // Min 20ms per frame
        }

        // --- Scanner Logic (Refactored for Console) ---
        let html5QrcodeScanner;
        let mainHtml5QrcodeScanner; // For the main scanner tab

        function startConsoleScanner() {
            if (html5QrcodeScanner) {
                // Already running?
                return;
            }

            const readerId = "console-reader";
            if (!document.getElementById(readerId)) return;

            if (typeof Html5Qrcode === 'undefined') {
                console.warn("Html5Qrcode library not loaded. Scanner disabled.");
                document.getElementById(readerId).innerHTML = '<div class="text-white text-center p-4">ç„¡æ³•è¼‰å…¥æƒæå…ƒä»¶ (Library Missing)</div>';
                return;
            }

            html5QrcodeScanner = new Html5Qrcode(readerId);

            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            html5QrcodeScanner.start({ facingMode: "environment" }, config, async (decodedText) => {
                // Success
                if (window.isScanning) return; // Debounce
                window.isScanning = true;

                // UI Feedback
                document.getElementById('console-scan-status').classList.remove('hidden');

                try {
                    const res = await fetch(getApiUrl(), {
                        method: 'POST',
                        body: JSON.stringify({ action: 'checkIn', qrCodeData: decodedText })
                    });
                    const json = await res.json();

                    if (json.status === 'success') {
                        playAudio('success');
                        logConsoleActivity(json.participant, 'success');

                        // Update Data
                        await refreshCurrentEventData(); // Reload regs
                        updateConsoleStats(); // Update UI

                        showScannerResult(json.participant, 'å·²å®Œæˆå ±åˆ° (Checked In)', 'success');
                    } else {
                        playAudio('error');
                        logConsoleActivity('æœªçŸ¥ç”¨æˆ¶', 'error', json.message);
                        showScannerResult('éŒ¯èª¤ (Error)', json.message, 'error');
                    }
                } catch (e) {
                    console.error(e);
                    playAudio('error');
                    showScannerResult('ç³»çµ±éŒ¯èª¤', 'ç„¡æ³•é€£æ¥ä¼ºæœå™¨', 'error');
                } finally {
                    document.getElementById('console-scan-status').classList.add('hidden');
                    setTimeout(() => { window.isScanning = false; }, 2000); // Cooldown
                }
            }).then(() => {
                // Started
                document.getElementById('scanner-blocked-overlay').classList.add('hidden');
                document.getElementById('btn-stop-scanner').classList.remove('hidden');
            }).catch(err => {
                console.error("Scanner Error", err);
                document.getElementById(readerId).innerHTML = `<div class="text-white text-center p-4">ç„¡æ³•å•Ÿå‹•é¡é ­<br>${err}</div>`;
            });
        }

        function stopConsoleScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    html5QrcodeScanner = null;
                    document.getElementById('scanner-blocked-overlay').classList.remove('hidden');
                    document.getElementById('btn-stop-scanner').classList.add('hidden');
                }).catch(err => console.error("Failed to stop scanner", err));
            }
        }

        function startScanner() {
            if (mainHtml5QrcodeScanner) {
                return;
            }

            const readerId = "reader";
            if (!document.getElementById(readerId)) return;

            if (typeof Html5Qrcode === 'undefined') {
                console.warn("Html5Qrcode library not loaded. Scanner disabled.");
                document.getElementById(readerId).innerHTML = '<div class="text-white text-center p-4">ç„¡æ³•è¼‰å…¥æƒæå…ƒä»¶ (Library Missing)</div>';
                return;
            }

            mainHtml5QrcodeScanner = new Html5Qrcode(readerId);
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            mainHtml5QrcodeScanner.start({ facingMode: "environment" }, config, async (decodedText) => {
                // Success
                // document.getElementById('scan-result').innerText = `æƒæçµæœ: ${decodedText}`; // Old logic

                // Actual Check-in Logic
                playAudio('popup');
                try {
                    const res = await fetch(getApiUrl(), {
                        method: 'POST',
                        body: JSON.stringify({ action: 'checkIn', qrCodeData: decodedText })
                    });
                    const json = await res.json();

                    if (json.status === 'success') {
                        playAudio('success');
                        showScannerResult(json.participant, 'å·²å®Œæˆå ±åˆ° (Checked In)', 'success');
                    } else {
                        playAudio('error');
                        showScannerResult('éŒ¯èª¤ (Error)', json.message, 'error');
                    }
                } catch (e) {
                    console.error(e);
                    playAudio('error');
                    showScannerResult('ç³»çµ±éŒ¯èª¤', 'ç„¡æ³•é€£æ¥ä¼ºæœå™¨', 'error');
                }

                // Stop after scan? Or keep scanning? 
                // Console scanner has cooldown. Main scanner usually one-off or continuous?
                // Text says "Click to close".
                // Let's pause or cooldown.
                mainHtml5QrcodeScanner.pause(true);
                setTimeout(() => mainHtml5QrcodeScanner.resume(), 3000);

            }).then(() => {
                document.getElementById('main-scanner-overlay').classList.add('hidden');
                document.getElementById('btn-stop-main-scanner').classList.remove('hidden');
            }).catch(err => {
                console.error("Main Scanner Error", err);
                document.getElementById(readerId).innerHTML = `<div class="text-white text-center p-4">ç„¡æ³•å•Ÿå‹•é¡é ­<br>${err}</div>`;
            });
        }

        function stopScanner() {
            if (mainHtml5QrcodeScanner) {
                mainHtml5QrcodeScanner.stop().then(() => {
                    mainHtml5QrcodeScanner.clear();
                    mainHtml5QrcodeScanner = null;
                    document.getElementById('main-scanner-overlay').classList.remove('hidden');
                    document.getElementById('btn-stop-main-scanner').classList.add('hidden');
                    document.getElementById('scan-result').innerText = '';
                }).catch(err => console.error("Failed to stop main scanner", err));
            }
        }

        function logConsoleActivity(name, type, msg = '') {
            const logContainer = document.getElementById('console-activity-log');
            if (logContainer.children[0]?.innerText === 'æš«ç„¡å ±åˆ°ç´€éŒ„') logContainer.innerHTML = '';

            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            if (type === 'success') {
                div.className = "flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-100 animate__animated animate__fadeInLeft";
                div.innerHTML = `
                    <div class="flex items-center">
                        <div class="bg-green-500 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">âœ“</div>
                        <div>
                            <div class="font-bold text-slate-800">${name}</div>
                            <div class="text-xs text-green-600">å·²å ±åˆ°</div>
                        </div>
                    </div>
                    <div class="text-xs text-slate-400 font-mono">${time}</div>
                `;
            } else {
                div.className = "flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-100 animate__animated animate__fadeInLeft";
                div.innerHTML = `
                    <div class="flex items-center">
                        <div class="bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">!</div>
                        <div>
                            <div class="font-bold text-slate-800">${name || 'æƒæéŒ¯èª¤'}</div>
                            <div class="text-xs text-red-600">${msg}</div>
                        </div>
                    </div>
                    <div class="text-xs text-slate-400 font-mono">${time}</div>
                `;
            }

            logContainer.prepend(div);
        }

        async function refreshCurrentEventData() {
            // Helper to silently reload data
            if (currentEditingEventId) {
                const event = allEventsData.find(e => e.event_id === currentEditingEventId);
                await loadEventRegistrations(currentEditingEventId, event.form_config);
            }
        }


        // --- NEW FEATURES ---

        // Audio
        // --- GLOBAL UI HELPERS ---

        // Audio System
        // Audio System - Base64 Encoded
        const audioSuccess = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=');
        const audioError = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=');
        const audioClick = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=');
        const audioPopup = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=');

        function playAudio(type) {
            try {
                // Reset time to allow rapid replay
                if (type === 'success') { audioSuccess.currentTime = 0; audioSuccess.play().catch(() => { }); }
                else if (type === 'error') { audioError.currentTime = 0; audioError.play().catch(() => { }); }
                else if (type === 'click') { audioClick.currentTime = 0; audioClick.play().catch(() => { }); }
                else if (type === 'popup') { audioPopup.currentTime = 0; audioPopup.play().catch(() => { }); }
            } catch (e) {
                console.warn("Audio play failed", e);
            }
        }

        // Global Click Listener
        document.addEventListener('click', (e) => {
            const isClickable = e.target.matches('button, a, input, select, textarea, [onclick]') ||
                e.target.closest('button, a, .clickable, [onclick]');
            if (isClickable) {
                playAudio('click');
            }
        });

        // Consolidated setLoading is in the Helpers section

        // Popup System (Replaces showScannerResult)
        function showPopup(title, message, type = 'info') {
            const overlay = document.createElement('div');
            overlay.className = "fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[70] animate__animated animate__fadeIn";
            overlay.onclick = () => overlay.remove();

            let bgColor = 'bg-white';
            let iconColor = 'text-blue-500';
            let icon = 'â„¹ï¸';

            if (type === 'success') {
                icon = '<i class="fas fa-check-circle text-6xl text-green-500 mb-4 animate__animated animate__bounceIn"></i>';
            } else if (type === 'error') {
                icon = '<i class="fas fa-times-circle text-6xl text-red-500 mb-4 animate__animated animate__shakeX"></i>';
            } else {
                icon = '<i class="fas fa-info-circle text-6xl text-blue-500 mb-4"></i>';
            }

            // Play Sound
            if (type === 'success') playAudio('success');
            else if (type === 'error') playAudio('error');
            else playAudio('popup');

            overlay.innerHTML = `
                <div class="bg-white p-8 rounded-3xl shadow-2xl text-center max-w-sm w-full mx-4 transform transition-all scale-100 hover:scale-105" onclick="event.stopPropagation()">
                    ${icon}
                    <h2 class="text-3xl font-bold mb-2 text-slate-800">${title}</h2>
                    <p class="text-lg text-slate-500 mb-8 leading-relaxed">${message}</p>
                    <button onclick="this.closest('.fixed').remove()" 
                        class="bg-slate-800 text-white px-8 py-3 rounded-full font-bold hover:bg-slate-900 transition-colors shadow-lg hover:shadow-xl w-full">
                        æˆ‘çŸ¥é“äº† (OK)
                    </button>
                </div>
            `;
            document.body.appendChild(overlay);

            // Auto close success after 2s? No, user wants notifications. Let them close or 3s auto.
            if (type === 'success') {
                setTimeout(() => { if (overlay.parentNode) overlay.remove(); }, 2500);
            }
        }

        // Scanner Modal
        function showScannerResult(title, message, type) {
            const overlay = document.createElement('div');
            overlay.className = "fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[60] animate__animated animate__zoomIn";
            overlay.onclick = () => overlay.remove();

            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const icon = type === 'success' ? 'âœ…' : 'âŒ';

            overlay.innerHTML = `
                <div class="${bgColor} text-white p-10 rounded-3xl shadow-2xl text-center max-w-sm w-full mx-4">
                    <div class="text-6xl mb-4">${icon}</div>
                    <h2 class="text-4xl font-bold mb-4">${title}</h2>
                    <p class="text-2xl opacity-90">${message}</p>
                    <div class="mt-8 text-sm opacity-70">é»æ“Šä»»æ„è™•é—œé–‰</div>
                </div>
            `;
            document.body.appendChild(overlay);
            setTimeout(() => { if (overlay.parentNode) overlay.remove(); }, 3000);
        }

        // Repair DB
        async function repairDatabase() {
            if (!confirm("ç¢ºå®šè¦åŸ·è¡Œè³‡æ–™åº«æ¬„ä½ä¿®å¾©ï¼Ÿ(å»ºè­°åœ¨ç™¼ç¾è³‡æ–™ç•°å¸¸æ™‚åŸ·è¡Œ)")) return;
            const btn = document.querySelector('button[onclick="repairDatabase()"]');
            setLoading(true, btn);
            try {
                const res = await fetch(getApiUrl(), { method: 'POST', body: JSON.stringify({ action: 'fixHeaders' }) });
                const json = await res.json();
                showPopup('æˆåŠŸ', json.message, 'success');
            } catch (e) { showPopup('å¤±æ•—', 'ä¿®å¾©å¤±æ•—', 'error'); console.error(e); }
            finally { setLoading(false, btn); }
        }

        // Stats Overview
        function loadOverview() {
            const total = currentEventRegistrations.length;
            const checkedIn = currentEventRegistrations.filter(r => r.check_in_status === 'CheckedIn').length;
            const rate = total > 0 ? Math.round((checkedIn / total) * 100) : 0;

            if (document.getElementById('stat-total')) document.getElementById('stat-total').innerText = total;
            if (document.getElementById('stat-checked-in')) document.getElementById('stat-checked-in').innerText = checkedIn;
            if (document.getElementById('stat-rate')) document.getElementById('stat-rate').innerText = `${rate}%`;
        }

        function loadModalRegistrations() {
            refreshCurrentEventData();
        }

        // --- Manual Check-in ---
        async function manualCheckIn() {
            const phoneInput = document.getElementById('manual-checkin-phone');
            const phone = phoneInput.value.trim();
            if (!phone) {
                alert("è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼");
                return;
            }
            if (!currentEditingEventId) return;

            // UI Feedback
            const btn = document.querySelector('button[onclick="manualCheckIn()"]');
            setLoading(true, btn);

            try {
                const res = await fetch(getApiUrl(), {
                    method: 'POST',
                    body: JSON.stringify({ action: 'checkInByPhone', eventId: currentEditingEventId, phone: phone })
                });
                const json = await res.json();

                if (json.status === 'success') {
                    playAudio('success');
                    phoneInput.value = ''; // Clear input
                    logConsoleActivity(json.participant, 'success', '(Manual)');
                    showScannerResult(json.participant, 'å ±åˆ°æˆåŠŸ (Manual)', 'success');

                    // Update Data
                    await refreshCurrentEventData();
                    updateConsoleStats();
                } else {
                    playAudio('error');
                    logConsoleActivity('Unknown', 'error', json.message);
                    showScannerResult('éŒ¯èª¤', json.message, 'error');
                }
            } catch (e) {
                console.error(e);
                playAudio('error');
                showScannerResult('ç³»çµ±éŒ¯èª¤', 'é€£ç·šå¤±æ•—', 'error');
            } finally {
                setLoading(false, btn);
            }
        }

        // Script Loaded Indicator
        try {
            console.log("SEED EVENT+ Admin Script Loaded");
            const title = document.querySelector('h2');
            if (title) {
                const dot = document.createElement('span');
                dot.innerText = 'â—';
                dot.style.color = '#22c55e'; // Green
                dot.style.fontSize = '12px';
                dot.style.verticalAlign = 'top';
                dot.style.marginLeft = '5px';
                dot.title = "System Script Loaded";
                title.appendChild(dot);
            }
        } catch (e) { console.error("Init Error", e); }
    </script>
    <script>
        // Diagnostic Script (Runs separately)
        (function () {
            console.log("Diagnostic Script Running...");
            const title = document.querySelector('h2');
            if (!title) return;

            const dot = document.createElement('span');
            dot.style.fontSize = '12px';
            dot.style.verticalAlign = 'top';
            dot.style.marginLeft = '5px';
            dot.style.fontWeight = 'bold';

            // Check if Main Script Loaded
            if (typeof handleLogin === 'function') {
                dot.innerText = 'â—';
                dot.style.color = '#22c55e'; // Green
                dot.title = "System Ready";
                console.log("System Ready");
            } else {
                dot.innerText = 'â—';
                dot.style.color = '#ef4444'; // Red
                dot.title = "Main Script CRASHED (Syntax Error)";
                console.error("Main Script Crash Detected: handleLogin is undefined");

                // Show Error Banner
                const banner = document.createElement('div');
                banner.className = "bg-red-500 text-white p-2 text-center text-xs font-bold fixed top-0 left-0 w-full z-50";
                banner.innerText = "CRITICAL ERROR: Main Script Failed to Load. Check Console.";
                document.body.appendChild(banner);
            }
            title.appendChild(dot);
        })();
    </script>

    <!-- Batch Operation Toolbar (Fixed Bottom) -->
    <div id="batch-toolbar"
        class="hidden fixed bottom-0 left-0 right-0 bg-white border-t-2 border-blue-500 shadow-2xl z-[60] animate__animated animate__slideInUp">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check-square text-blue-600 text-xl"></i>
                        <span class="text-sm font-medium text-slate-700">
                            å·²é¸æ“‡ <strong id="selected-count" class="text-2xl text-blue-600">0</strong> ç­†å ±å
                        </span>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="batchApprove()"
                        class="flex items-center gap-2 px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold transition-all shadow-md hover:shadow-lg active:scale-95">
                        <i class="fas fa-check"></i>
                        æ‰¹æ¬¡æ ¸å‡†
                    </button>
                    <button onclick="batchReject()"
                        class="flex items-center gap-2 px-6 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold transition-all shadow-md hover:shadow-lg active:scale-95">
                        <i class="fas fa-times"></i>
                        æ‰¹æ¬¡æ‹’çµ•
                    </button>
                    <button onclick="batchExport()"
                        class="flex items-center gap-2 px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold transition-all shadow-md hover:shadow-lg active:scale-95">
                        <i class="fas fa-download"></i>
                        åŒ¯å‡ºé¸ä¸­
                    </button>
                    <button onclick="clearSelection()"
                        class="flex items-center gap-2 px-6 py-2.5 bg-slate-500 hover:bg-slate-600 text-white rounded-lg font-medium transition-all shadow-md hover:shadow-lg active:scale-95">
                        <i class="fas fa-times-circle"></i>
                        å–æ¶ˆé¸æ“‡
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>