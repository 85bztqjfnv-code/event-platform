<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEED EVENT+ | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js" defer></script>
    <script>
        window.onerror = function (msg, url, line) {
            console.error("ç³»çµ±éŒ¯èª¤ (Error): " + msg + "\n" + url + ":" + line);
            // alert("ç³»çµ±éŒ¯èª¤ (Error): " + msg + "\n" + url + ":" + line); // Suppress alert
            return false;
        };
    </script>
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- Animations -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Outfit', sans-serif;
            background: #f8fafc;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .active-tab {
            border-bottom: 2px solid #0f172a;
            color: #0f172a;
            font-weight: 600;
        }

        .tab-btn {
            transition: all 0.3s ease;
        }

        .card-hover {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body class="bg-gray-100 font-sans h-screen flex flex-col">
    <!-- Global Loading Overlay -->
    <div id="main-loading-overlay"
        class="fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center z-[100] hidden">
        <div class="bg-white p-8 rounded-2xl flex flex-col items-center animate__animated animate__fadeIn">
            <i class="fas fa-circle-notch fa-spin text-4xl text-blue-600 mb-4"></i>
            <h3 class="text-lg font-bold text-slate-700">è¼‰å…¥ä¸­... Please wait</h3>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen"
        class="fixed inset-0 bg-slate-900 flex items-center justify-center z-50 animate__animated animate__fadeIn">
        <div
            class="bg-white p-10 rounded-2xl shadow-2xl w-96 transform transition-all animate__animated animate__zoomIn">
            <h2 class="text-3xl font-bold mb-2 text-center text-slate-800 tracking-tight">SEED EVENT+</h2>
            <p class="text-center text-gray-500 mb-8 text-sm">Admin Access</p>
            <form id="login-form" class="space-y-4">
                <input type="text" id="username" placeholder="å¸³è™Ÿ"
                    class="w-full p-3 border rounded border-gray-300 focus:outline-none focus:border-blue-500" required>
                <input type="password" id="password" placeholder="å¯†ç¢¼"
                    class="w-full p-3 border rounded border-gray-300 focus:outline-none focus:border-blue-500" required>
                <button type="submit"
                    class="w-full bg-blue-600 text-white p-3 rounded font-bold hover:bg-blue-700 transition">ç™»å…¥</button>
            </form>
            <p class="mt-4 text-xs text-center text-gray-400">é è¨­: admin / admin123</p>
            <p class="mt-2 text-xs text-center text-slate-300 font-mono opacity-50">v1.2.0</p>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="dashboard" class="flex-1 flex flex-col hidden">
        <!-- Top Navigation -->
        <header class="bg-white/90 backdrop-blur shadow-sm z-10 sticky top-0 animate__animated animate__slideInDown">
            <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight">SEED EVENT+ <span id="user-role-display"
                        class="text-blue-600 text-sm bg-blue-50 px-2 py-1 rounded-full ml-2 font-normal align-middle"></span>
                </h1>
                <div class="flex items-center space-x-6">
                    <span id="user-name-display" class="text-sm font-medium text-slate-600"></span>
                    <button onclick="logout()"
                        class="text-sm text-red-500 hover:text-red-700 font-medium transition-colors">ç™»å‡º Logout</button>
                </div>
            </div>
            <div class="max-w-7xl mx-auto px-6 flex justify-end pb-4">
                <button onclick="repairDatabase()" class="text-xs text-blue-600 hover:text-blue-800 underline">ä¿®å¾©è³‡æ–™åº«æ¬„ä½
                    (Repair DB)</button>
            </div>
            <!-- Tabs -->
            <div class="max-w-7xl mx-auto px-6 flex space-x-8 border-t border-gray-100">
                <button onclick="switchTab('overview')" id="tab-overview"
                    class="tab-btn py-4 text-sm font-medium text-gray-400 hover:text-slate-800 active-tab">æ¦‚è¦½</button>
                <button onclick="switchTab('events')" id="tab-events"
                    class="tab-btn py-4 text-sm font-medium text-gray-400 hover:text-slate-800">æ´»å‹•åˆ—è¡¨</button>
                <button onclick="switchTab('create-event')" id="tab-create-event"
                    class="tab-btn py-4 text-sm font-medium text-gray-400 hover:text-slate-800">å»ºç«‹æ´»å‹•</button>
                <button onclick="switchTab('users')" id="tab-users"
                    class="tab-btn py-4 text-sm font-medium text-gray-400 hover:text-slate-800">å¸³è™Ÿ Users</button>
                <button onclick="switchTab('scanner')" id="tab-scanner"
                    class="tab-btn py-4 text-sm font-medium text-gray-400 hover:text-slate-800">QR æƒæ</button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-auto bg-gray-100 p-6">

            <!-- Overview View -->
            <div id="view-overview" class="max-w-7xl mx-auto space-y-8 animate__animated animate__fadeIn">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-white p-8 rounded-2xl shadow-sm card-hover border border-slate-100">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">Total Events</h3>
                            <div class="p-2 bg-blue-50 rounded-lg text-blue-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                    </path>
                                </svg>
                            </div>
                        </div>
                        <p class="text-4xl font-extrabold text-slate-800" id="stat-total-events">-</p>
                    </div>
                    <div class="bg-white p-8 rounded-2xl shadow-sm card-hover border border-slate-100">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">Total Registrations
                            </h3>
                            <div class="p-2 bg-green-50 rounded-lg text-green-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                                    </path>
                                </svg>
                            </div>
                        </div>
                        <p class="text-4xl font-extrabold text-slate-800" id="stat-total-regs">-</p>
                    </div>
                    <div class="bg-white p-8 rounded-2xl shadow-sm card-hover border border-slate-100">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">Pending Review</h3>
                            <div class="p-2 bg-yellow-50 rounded-lg text-yellow-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <p class="text-4xl font-extrabold text-slate-800" id="stat-pending-regs">-</p>
                    </div>
                </div>
            </div>

            <!-- Create Event View -->
            <div id="view-create-event" class="max-w-7xl mx-auto space-y-8 hidden animate__animated animate__fadeIn">
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-xl font-bold mb-6 text-slate-800">å»ºç«‹æ–°æ´»å‹•</h3>
                    <form id="create-event-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-400 uppercase">æ´»å‹•åç¨±</label>
                            <input type="text" id="evt-name" required
                                class="w-full p-3 bg-slate-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-400 uppercase">æ—¥æœŸ</label>
                            <input type="date" id="evt-date" required
                                class="w-full p-3 bg-slate-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-400 uppercase">åœ°é»</label>
                            <input type="text" id="evt-loc" required
                                class="w-full p-3 bg-slate-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-400 uppercase">åƒ¹æ ¼</label>
                            <input type="number" id="evt-price" required
                                class="w-full p-3 bg-slate-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>
                        <div class="md:col-span-2 space-y-1">
                            <label class="text-xs font-bold text-slate-400 uppercase">æè¿°</label>
                            <textarea id="evt-desc"
                                class="w-full p-3 bg-slate-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all"
                                rows="3"></textarea>
                        </div>
                        <div class="md:col-span-2 flex space-x-6 pt-2">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="evt-enable-qr" class="sr-only peer" checked>
                                <div
                                    class="relative w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                </div>
                                <span class="ms-3 text-sm font-medium text-slate-700">é¡¯ç¤º QR Code</span>
                            </label>

                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="evt-enable-checkin" class="sr-only peer">
                                <div
                                    class="relative w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600">
                                </div>
                                <span class="ms-3 text-sm font-medium text-slate-700">é–‹æ”¾å ±åˆ° (Check-in)</span>
                            </label>
                        </div>

                        <!-- Custom Fields Builder (Professional) -->
                        <div class="md:col-span-2 p-6 rounded-xl bg-slate-50 border border-slate-200">
                            <h4 class="font-bold mb-4 text-slate-800 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4">
                                    </path>
                                </svg>
                                è‡ªè¨‚å ±åè¡¨å–®æ¬„ä½ (Custom Form Fields)
                            </h4>

                            <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm mb-4">
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 mb-3">
                                    <div class="md:col-span-3">
                                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">æ¬„ä½åç¨±
                                            Label</label>
                                        <input type="text" id="new-field-label" placeholder="ä¾‹å¦‚: ç”¨é¤ç¿’æ…£"
                                            class="w-full p-2 bg-slate-50 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    </div>
                                    <div class="md:col-span-3">
                                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">é¡å‹
                                            Type</label>
                                        <select id="new-field-type" onchange="toggleFieldOptions()"
                                            class="w-full p-2 bg-slate-50 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                            <option value="text">å–®è¡Œæ–‡å­— (Text)</option>
                                            <option value="textarea">å¤šè¡Œæ–‡å­— (Textarea)</option>
                                            <option value="select">ä¸‹æ‹‰é¸å–® (Select)</option>
                                            <option value="date">æ—¥æœŸ (Date)</option>
                                            <option value="email">Email</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-4">
                                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">é¸é … Options
                                            (ä»¥é€—è™Ÿåˆ†éš”)</label>
                                        <input type="text" id="new-field-options" placeholder="è‘·, ç´ , ä¸åƒç‰›" disabled
                                            class="w-full p-2 bg-slate-100 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none disabled:text-slate-300">
                                    </div>
                                    <div class="md:col-span-2 flex items-end">
                                        <div class="flex items-center h-10 pt-4">
                                            <label class="inline-flex items-center cursor-pointer">
                                                <input type="checkbox" id="new-field-required" class="sr-only peer">
                                                <div
                                                    class="relative w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-500">
                                                </div>
                                                <span class="ms-3 text-sm font-medium text-slate-600">å¿…å¡«
                                                    (Required)</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" onclick="addCustomField()"
                                    class="w-full py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition-colors text-sm font-bold flex items-center justify-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    æ–°å¢æ¬„ä½ Add Field
                                </button>
                            </div>

                            <div class="space-y-2">
                                <label class="block text-xs font-bold text-slate-400 uppercase">ç›®å‰æ¬„ä½é è¦½</label>
                                <ul id="custom-fields-list" class="space-y-2">
                                    <!-- Dynamic Fields -->
                                    <li
                                        class="empty-state text-sm text-slate-400 text-center py-4 bg-slate-100 rounded-lg border border-dashed border-slate-300">
                                        å°šæœªæ–°å¢ä»»ä½•è‡ªè¨‚æ¬„ä½
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <button type="submit"
                            class="bg-blue-600 text-white py-4 px-6 rounded-xl md:col-span-2 hover:bg-blue-700 font-bold tracking-wide shadow-lg shadow-blue-200 transition-all transform hover:-translate-y-1">
                            å»ºç«‹æ´»å‹• Create Event
                        </button>
                    </form>
                </div>
            </div>

            <!-- Event List View -->
            <div id="view-events" class="max-w-7xl mx-auto space-y-8 hidden animate__animated animate__fadeIn">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-6 border-b border-slate-100">
                        <h3 class="text-xl font-bold text-slate-800">æ´»å‹•åˆ—è¡¨</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-100">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                        åç¨±</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                        æ—¥æœŸ</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                        ç‹€æ…‹</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                        æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="events-list-body" class="bg-white divide-y divide-gray-200">
                                <!-- Events Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="view-users" class="max-w-7xl mx-auto space-y-6 hidden">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-bold mb-4">æ–°å¢å¸³è™Ÿ</h3>
                    <form id="create-user-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="new-u-username" placeholder="å¸³è™Ÿ (Username)" required
                            class="p-2 border rounded">
                        <input type="text" id="new-u-password" placeholder="å¯†ç¢¼ (Password)" required
                            class="p-2 border rounded">
                        <input type="text" id="new-u-name" placeholder="å§“å (Name)" required class="p-2 border rounded">
                        <select id="new-u-role" class="p-2 border rounded" required>
                            <option value="System Admin">ç³»çµ±ç®¡ç†å“¡ (System Admin)</option>
                            <option value="Finance Officer">è²¡å‹™äººå“¡ (Finance Officer)</option>
                        </select>
                        <button type="submit"
                            class="bg-blue-600 text-white py-2 px-4 rounded md:col-span-2 hover:bg-blue-700">å»ºç«‹å¸³è™Ÿ</button>
                    </form>
                </div>
            </div>

            <!-- Scanner View -->
            <div id="view-scanner" class="max-w-md mx-auto hidden animate__animated animate__fadeIn">
                <div
                    class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 text-center relative overflow-hidden">
                    <h3 class="text-xl font-bold mb-6 text-slate-800">QR Code æƒæå™¨</h3>

                    <div id="main-scanner-overlay"
                        class="absolute inset-0 flex flex-col items-center justify-center bg-white/90 z-20">
                        <i class="fas fa-camera text-slate-400 text-5xl mb-4"></i>
                        <button onclick="startScanner()"
                            class="bg-blue-600 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:bg-blue-700 transition transform hover:scale-105 active:scale-95 flex items-center">
                            <i class="fas fa-power-off mr-2"></i> å•Ÿå‹•ç›¸æ©Ÿ
                        </button>
                    </div>

                    <button onclick="stopScanner()" id="btn-stop-main-scanner"
                        class="absolute top-4 right-4 bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs hidden z-30 hover:bg-red-200">
                        é—œé–‰
                    </button>

                    <div id="reader"
                        class="mx-auto border-2 border-slate-100 rounded-lg overflow-hidden mb-6 min-h-[300px] bg-black">
                    </div>
                    <p id="scan-result" class="text-sm font-medium text-slate-500 min-h-[20px]"></p>
                </div>
            </div>

        </main>
    </div>

    <!-- Create User Modal -->
    <div id="create-user-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl p-8 max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold mb-4 text-slate-800">æ–°å¢å¸³è™Ÿ</h3>
            <form id="create-user-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">ä½¿ç”¨è€…åç¨±</label>
                    <input type="text" id="new-u-username" required
                        class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">å¯†ç¢¼</label>
                    <input type="password" id="new-u-password" required
                        class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">å§“å (é¡¯ç¤ºç”¨)</label>
                    <input type="text" id="new-u-name" required
                        class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">æ¬Šé™è§’è‰²</label>
                    <select id="new-u-role" class="w-full p-2 border border-slate-200 rounded-lg outline-none">
                        <option value="Admin">ç³»çµ±ç®¡ç†å“¡ (Admin)</option>
                        <option value="Staff">å·¥ä½œäººå“¡ (Staff)</option>
                    </select>
                </div>
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('create-user-modal').classList.add('hidden')"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-50 rounded-lg">å–æ¶ˆ</button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm btn-loading">å»ºç«‹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Event Manager Modal -->
    <div id="event-manager-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-7xl h-[95vh] flex flex-col m-4 overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-gray-100 px-6 py-4 flex justify-between items-center border-b">
                <h3 class="text-xl font-bold text-gray-800" id="modal-event-title">æ´»å‹•ç®¡ç†</h3>
                <button onclick="closeEventManager()"
                    class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>

            <!-- Modal Tabs -->
            <div class="bg-white border-b px-6 flex space-x-6">
                <button onclick="switchModalTab('info')" id="mtab-info"
                    class="py-3 text-sm font-medium border-b-2 border-blue-600 text-blue-600 transition-colors">åŸºæœ¬è³‡è¨Š</button>
                <button onclick="switchModalTab('regs')" id="mtab-regs"
                    class="py-3 text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors">å ±ååå–®</button>
                <button onclick="switchModalTab('checkin')" id="mtab-checkin"
                    class="py-3 text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors flex items-center">
                    <span>å ±åˆ°ç®¡ç† (Console)</span>
                    <span class="ml-2 bg-slate-100 text-slate-600 text-xs px-2 py-0.5 rounded-full"
                        id="tab-checkin-badge">Live</span>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="flex-1 overflow-auto p-6 bg-gray-50">

                <!-- Info Tab -->
                <div id="mview-info">
                    <form id="edit-event-form" class="space-y-4 max-w-7xl mx-auto bg-white p-6 rounded shadow">
                        <input type="hidden" id="edit-evt-id">
                        <h4 class="font-bold text-gray-700 text-lg mb-4">ç·¨è¼¯æ´»å‹•è³‡è¨Š</h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">åç¨±</label>
                            <input type="text" id="edit-evt-name" required class="w-full mt-1 p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">æ—¥æœŸ</label>
                            <input type="date" id="edit-evt-date" required class="w-full mt-1 p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">åœ°é»</label>
                            <input type="text" id="edit-evt-loc" required class="w-full mt-1 p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">åƒ¹æ ¼</label>
                            <input type="number" id="edit-evt-price" required class="w-full mt-1 p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">æè¿°</label>
                            <textarea id="edit-evt-desc" class="w-full mt-1 p-2 border rounded" rows="3"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ç‹€æ…‹</label>
                            <select id="edit-evt-status" class="w-full mt-1 p-2 border rounded">
                                <option value="Closed">åœæ­¢å ±å (Closed)</option>
                            </select>
                        </div>
                        <div class="flex space-x-6 pt-2">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="edit-evt-enable-qr" class="sr-only peer">
                                <div
                                    class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                </div>
                                <span class="ms-3 text-sm font-medium text-gray-700">é¡¯ç¤º QR Code</span>
                            </label>

                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="edit-evt-enable-checkin" class="sr-only peer">
                                <div
                                    class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600">
                                </div>
                                <span class="ms-3 text-sm font-medium text-gray-700">é–‹æ”¾å ±åˆ° (Check-in)</span>
                            </label>
                        </div>
                        <div class="pt-4 flex justify-end">
                            <button type="submit"
                                class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">å„²å­˜è®Šæ›´</button>
                        </div>
                    </form>
                </div>

                <!-- Registrations Tab -->
                <div id="mview-regs" class="hidden space-y-4">
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-600">
                            å·²å ±å: <span id="reg-count-total" class="font-bold text-gray-900">-</span> |
                            å·²ä»˜æ¬¾: <span id="reg-count-paid" class="font-bold text-green-600">-</span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="loadModalRegistrations()"
                                class="bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-300">é‡æ–°æ•´ç†</button>
                            <button onclick="downloadCSV()"
                                class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">åŒ¯å‡º CSV
                                (Export)</button>
                        </div>
                    </div>

                    <!-- Registration Management List -->
                    <div id="event-registrations-section">
                        <div class="overflow-x-auto rounded-lg border border-slate-100">
                            <table class="min-w-full divide-y divide-slate-100" id="registrations-table">
                                <thead class="bg-slate-50" id="registrations-table-head">
                                    <!-- Dynamic Header injected here -->
                                </thead>
                                <tbody id="registrations-list-body" class="bg-white divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Check-in Console Tab (New) -->
            <div id="mview-checkin" class="hidden h-full flex flex-col">
                <!-- Stats Dashboard (Live) -->
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <div class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1">ç¸½å ±å</div>
                        <div class="text-3xl font-black text-slate-800" id="console-total">-</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-green-100 bg-green-50 shadow-sm">
                        <div class="text-xs text-green-600 uppercase font-bold tracking-wider mb-1">å·²å ±åˆ°</div>
                        <div class="text-3xl font-black text-green-600" id="console-checked-in">-</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-orange-100 bg-orange-50 shadow-sm">
                        <div class="text-xs text-orange-600 uppercase font-bold tracking-wider mb-1">æœªå ±åˆ°</div>
                        <div class="text-3xl font-black text-orange-600" id="console-unchecked">-</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-blue-100 bg-blue-50 shadow-sm">
                        <div class="text-xs text-blue-600 uppercase font-bold tracking-wider mb-1">å ±åˆ°ç‡</div>
                        <div class="text-3xl font-black text-blue-600" id="console-rate">0%</div>
                    </div>
                </div>

                <!-- Scanner & Manual Check-in Area -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1 min-h-0">
                    <!-- Left: Scanner -->
                    <div
                        class="bg-black rounded-2xl overflow-hidden relative shadow-lg flex flex-col items-center justify-center p-4 min-h-[400px]">

                        <!-- Manual Start Overlay -->
                        <div id="scanner-blocked-overlay"
                            class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 z-20">
                            <i class="fas fa-camera text-slate-700 text-6xl mb-4"></i>
                            <button onclick="startConsoleScanner()"
                                class="bg-blue-600 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:bg-blue-700 transition transform hover:scale-105 active:scale-95 flex items-center">
                                <i class="fas fa-power-off mr-2"></i> å•Ÿå‹•æƒæé¡é ­
                            </button>
                            <p class="text-slate-500 text-xs mt-4">è«‹å…è¨±ç€è¦½å™¨å­˜å–ç›¸æ©Ÿæ¬Šé™</p>
                        </div>

                        <button onclick="stopConsoleScanner()" id="btn-stop-scanner"
                            class="absolute top-4 right-4 bg-red-600/80 text-white px-3 py-1.5 rounded-full text-xs backdrop-blur-md hidden z-30 hover:bg-red-700 transition">
                            <i class="fas fa-stop mr-1"></i> é—œé–‰é¡é ­
                        </button>

                        <div id="console-reader" class="w-full h-full max-h-[500px] bg-black"></div>
                        <div
                            class="absolute top-4 left-4 bg-black/50 text-white px-3 py-1 rounded-full text-xs backdrop-blur-md pointer-events-none">
                            ğŸ“· é¡é ­é‹ä½œä¸­
                        </div>
                        <!-- Scanner Status Overlay -->
                        <div id="console-scan-status"
                            class="absolute inset-0 flex items-center justify-center bg-black/80 hidden z-10">
                            <span class="text-white font-medium animate-pulse">è™•ç†ä¸­...</span>
                        </div>
                    </div>

                    <!-- Right: Recent Activity / Manual -->
                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm flex flex-col overflow-hidden">
                        <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                            <h4 class="font-bold text-slate-700">æœ€è¿‘å‹•æ…‹</h4>
                            <span class="text-xs text-slate-400">å¯¦æ™‚æ›´æ–°</span>
                        </div>
                        <div id="console-activity-log" class="flex-1 overflow-y-auto p-4 space-y-3">
                            <div class="text-center text-slate-400 py-10 text-sm">æš«ç„¡å ±åˆ°ç´€éŒ„</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    </div>
    </div>

    <script>
        let currentUser = null;
        let currentEventId = null; // Store currently viewed event ID for modal
        let customFields = []; // Global custom fields definition



        // Login System
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const btn = e.target.querySelector('button');

            btn.innerText = 'é©—è­‰ä¸­...';
            btn.disabled = true;

            try {
                const response = await fetch(`${API_URL}?action=checkLogin&username=${u}&password=${p}`);
                const result = await response.json();

                if (result.status === 'success') {
                    currentUser = result.user;
                    enterDashboard();
                } else {
                    alert('ç™»å…¥å¤±æ•—: ' + result.message);
                }
            } catch (err) {
                console.error(err);
                alert('ç³»çµ±éŒ¯èª¤');
            } finally {
                btn.innerText = 'ç™»å…¥';
                btn.disabled = false;
            }
        });

        async function enterDashboard() {
            try {
                // Show Loading
                document.getElementById('main-loading-overlay').classList.remove('hidden');

                if (!currentUser) throw new Error("User session invalid");

                document.getElementById('login-screen').classList.add('hidden');
                const dashboard = document.getElementById('dashboard');
                dashboard.classList.remove('hidden');

                document.getElementById('user-name-display').innerText = currentUser.name || 'User';
                document.getElementById('user-role-display').innerText = currentUser.role || 'Staff';

                console.log("Current User Role Raw:", currentUser.role);
                // alert("Debug Role: " + currentUser.role); // Debugging removed

                // explicit role check
                // FORCE SHOW for debugging - logic was flaky
                const userTab = document.getElementById('tab-users');
                userTab.classList.remove('hidden');

                /*
                if (String(currentUser.role).trim() === 'System Admin') {
                    userTab.classList.remove('hidden');
                } else {
                    if (String(currentUser.role).includes('Admin')) {
                         userTab.classList.remove('hidden');
                    } else {
                         // userTab.classList.add('hidden'); // Disabled hiding for now
                    }
                }
                */

                // Load Overview Stats first
                await loadOverview();

                // Auto-repair headers in background
                fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'fixHeaders' }) })
                    .catch(console.error);

                playAudio('popup'); // Welcome sound

            } catch (e) {
                console.error(e);
                alert("è¼‰å…¥ Dashboard å¤±æ•—: " + e.message);
            } finally {
                // Hide Loading
                document.getElementById('main-loading-overlay').classList.add('hidden');
            }
        }

        function logout() {
            location.reload();
        }

        // Tabs
        function switchTab(tab) {
            ['overview', 'events', 'scanner', 'users', 'create-event'].forEach(t => {
                const el = document.getElementById(`view-${t}`);
                const tabEl = document.getElementById(`tab-${t}`);
                if (el) el.classList.add('hidden');
                if (tabEl) tabEl.classList.remove('active-tab');
            });
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('active-tab');

            if (tab === 'overview') loadOverview();
            if (tab === 'events') loadEvents();
            if (tab === 'scanner') {
                // startScanner(); // Auto-start removed
                // Show default state is handled by HTML overlay
            }
            else stopScanner();
        }

        // --- Overview Logic ---
        async function loadOverview() {
            // Simple approach: get all events and get all registrations (could be slow if huge data, but prototype OK)
            try {
                const [resE, resR] = await Promise.all([
                    fetch(`${API_URL}?action=getEvents&includeClosed=true`),
                    fetch(`${API_URL}?action=getRegistrations`)
                ]);
                const jsonE = await resE.json();
                const jsonR = await resR.json();

                const events = jsonE.data || [];
                const regs = jsonR.data || [];

                document.getElementById('stat-total-events').innerText = events.length;
                document.getElementById('stat-total-regs').innerText = regs.length;

                const pending = regs.filter(r => r.status === 'Pending').length;
                document.getElementById('stat-pending-regs').innerText = pending;
            } catch (e) { console.error(e); }
        }

        // --- Helpers ---
        function setLoading(btn, isLoading, loadingText = "è™•ç†ä¸­...") {
            if (isLoading) {
                btn.dataset.originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>${loadingText}`;
                btn.classList.add('opacity-75', 'cursor-not-allowed');
            } else {
                btn.disabled = false;
                btn.innerHTML = btn.dataset.originalText || 'é€å‡º';
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }

        // --- Events Logic ---
        async function loadEvents() {
            const body = document.getElementById('events-list-body');
            body.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center"><i class="fas fa-spinner fa-spin mr-2"></i>è¼‰å…¥ä¸­...</td></tr>';

            try {
                const res = await fetch(`${API_URL}?action=getEvents&includeClosed=true`);
                const json = await res.json();

                if (json.data && json.data.length) {
                    allEventsData = json.data; // Cache for modal
                    body.innerHTML = json.data.map(e => `
                        <tr class="hover:bg-slate-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap font-bold text-gray-900 flex items-center">
                                <span class="w-2 h-2 rounded-full ${e.status === 'Open' ? 'bg-green-500' : 'bg-slate-300'} mr-2"></span>
                                ${e.name}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(e.date).toLocaleDateString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${e.status === 'Open' ? 'bg-green-100 text-green-800' : 'bg-slate-100 text-slate-800'}">
                                    ${e.status === 'Open' ? 'å ±åä¸­' : 'å·²çµæŸ'}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="openEventManager('${e.event_id}')" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg hover:bg-blue-700 shadow-sm transition-all hover:shadow-md active:scale-95 flex items-center">
                                    <i class="fas fa-cog mr-1"></i> ç®¡ç†
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    body.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-slate-400">å°šç„¡æ´»å‹•ï¼Œè«‹é»æ“Šä¸Šæ–¹å»ºç«‹</td></tr>';
                }
            } catch (e) {
                console.error(e);
                body.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }

        document.getElementById('create-event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            setLoading(btn, true);

            const payload = {
                action: 'createEvent',
                name: document.getElementById('evt-name').value,
                date: document.getElementById('evt-date').value,
                location: document.getElementById('evt-loc').value,
                price: document.getElementById('evt-price').value,
                description: document.getElementById('evt-desc').value,
                enableQr: document.getElementById('evt-enable-qr').checked,
                enableCheckIn: document.getElementById('evt-enable-checkin').checked,
                formConfig: customFields // Include custom fields
            };

            await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });

            e.target.reset();
            customFields = []; // Reset custom fields
            renderCustomFieldsList();
            setLoading(btn, false);

            // Refech events and switch back
            await loadEvents();
            switchView('dashboard');

            // Show toast instead of alert? keeping alert for now as requested
            // alert('æ´»å‹•å»ºç«‹æˆåŠŸ');
        });

        // --- Event Manager Modal Logic ---
        let currentEditingEventId = null;
        let currentEventRegistrations = []; // Store for CSV export
        let allEventsData = []; // Populated by loadEvents

        // Expose to window to ensure button onclick works
        window.openEventManager = async function (eventId) {
            playAudio('popup');
            currentEditingEventId = eventId;

            const modal = document.getElementById('event-manager-modal');
            console.log("Opening event manager for ID:", eventId);
            const eventData = allEventsData.find(e => String(e.event_id) === String(eventId)); // Ensure type match

            if (!eventData) {
                console.error("Event data not found for ID:", eventId, "Available:", allEventsData);
                alert("ç„¡æ³•è®€å–æ´»å‹•è³‡æ–™ï¼Œè«‹é‡æ–°æ•´ç†é é¢å†è©¦");
                return;
            }

            // 1. Populate Edit Form
            document.getElementById('edit-evt-id').value = eventData.event_id;
            document.getElementById('edit-evt-name').value = eventData.name;
            document.getElementById('edit-evt-date').value = eventData.date.split('T')[0];
            document.getElementById('edit-evt-loc').value = eventData.location;
            document.getElementById('edit-evt-price').value = eventData.price;
            document.getElementById('edit-evt-desc').value = eventData.description || '';
            document.getElementById('edit-evt-status').value = eventData.status;
            const enableQr = eventData.enable_qr !== undefined ? (eventData.enable_qr === true || String(eventData.enable_qr) === 'true') : true;
            document.getElementById('edit-evt-enable-qr').checked = enableQr;

            // Handle enable_checkin: default false if undefined
            const enableCheckIn = eventData.enable_checkin !== undefined ? (eventData.enable_checkin === true || String(eventData.enable_checkin) === 'true') : false;
            document.getElementById('edit-evt-enable-checkin').checked = enableCheckIn;

            // 2. Load Registrations with Dynamic Columns
            await loadEventRegistrations(eventId, eventData.form_config);

            // 3. Populate Custom Fields for Editing
            try {
                customFields = typeof eventData.form_config === 'string' ? JSON.parse(eventData.form_config) : (eventData.form_config || []);
            } catch (e) {
                console.error("Error parsing form config for edit", e);
                customFields = [];
            }
            renderCustomFieldsList();

            modal.classList.remove('hidden');
            switchModalTab('info'); // Default to info tab
        }

        function closeEventManager() {
            document.getElementById('event-manager-modal').classList.add('hidden');
            currentEditingEventId = null;
            stopConsoleScanner(); // Ensure console scanner is stopped when modal closes
        }

        function switchModalTab(tab) {
            ['info', 'regs', 'settings'].forEach(t => {
                const el = document.getElementById(`mview-${t}`);
                const tabEl = document.getElementById(`mtab-${t}`);
                if (el) el.classList.add('hidden');
                if (tabEl) tabEl.classList.remove('active-tab');
            });
            document.getElementById(`mview-${tab}`).classList.remove('hidden');
            if (document.getElementById(`mtab-${tab}`)) document.getElementById(`mtab-${tab}`).classList.add('active-tab');
        }

        // --- Custom Fields Logic ---


        function toggleFieldOptions() {
            const type = document.getElementById('new-field-type').value;
            const optionsInput = document.getElementById('new-field-options');
            if (type === 'select') {
                optionsInput.disabled = false;
                optionsInput.classList.remove('bg-slate-100');
                optionsInput.classList.add('bg-white');
                optionsInput.placeholder = "é¸é …1, é¸é …2, é¸é …3";
            } else {
                optionsInput.disabled = true;
                optionsInput.value = '';
                optionsInput.classList.add('bg-slate-100');
                optionsInput.classList.remove('bg-white');
                optionsInput.placeholder = "åƒ…é©ç”¨æ–¼ä¸‹æ‹‰é¸å–®";
            }
        }

        function addCustomField() {
            const label = document.getElementById('new-field-label').value.trim();
            const type = document.getElementById('new-field-type').value;
            const options = document.getElementById('new-field-options').value.trim();
            const required = document.getElementById('new-field-required').checked;

            if (!label) return alert("è«‹è¼¸å…¥æ¬„ä½åç¨±");
            if (type === 'select' && !options) return alert("ä¸‹æ‹‰é¸å–®è«‹è¼¸å…¥é¸é … (ä»¥é€—è™Ÿåˆ†éš”)");

            customFields.push({ label, type, options, required });
            renderCustomFieldsList();

            // Reset inputs
            document.getElementById('new-field-label').value = '';
            document.getElementById('new-field-options').value = '';
            document.getElementById('new-field-required').checked = false;
            document.getElementById('new-field-type').value = 'text';
            toggleFieldOptions();
        }

        function removeCustomField(index) {
            customFields.splice(index, 1);
            renderCustomFieldsList();
        }

        function renderCustomFieldsList() {
            const list = document.getElementById('custom-fields-list');
            if (customFields.length === 0) {
                list.innerHTML = `<li class="empty-state text-sm text-slate-400 text-center py-4 bg-slate-100 rounded-lg border border-dashed border-slate-300">å°šæœªæ–°å¢ä»»ä½•è‡ªè¨‚æ¬„ä½</li>`;
                return;
            }

            list.innerHTML = customFields.map((field, index) => `
                <li class="flex justify-between items-center bg-white p-3 rounded-lg border border-slate-200 shadow-sm animate__animated animate__fadeIn">
                    <div class="flex items-center">
                        <span class="text-xs font-bold uppercase text-slate-500 mr-2 bg-slate-100 px-2 py-1 rounded">${field.type}</span>
                        <span class="text-sm font-bold text-slate-700">${field.label}</span>
                        ${field.required ? '<span class="text-xs text-red-500 ml-1">*å¿…å¡«</span>' : ''}
                        ${field.options ? `<span class="text-xs text-slate-400 ml-2">(${field.options})</span>` : ''}
                    </div>
                    <button type="button" onclick="removeCustomField(${index})" class="text-red-400 hover:text-red-600 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </li>
            `).join('');
        }

        // --- Registration Data Logic ---
        async function loadEventRegistrations(eventId, formConfig) {
            const tbody = document.getElementById('registrations-list-body');
            const thead = document.getElementById('registrations-table-head');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-slate-400">Loading...</td></tr>';

            try {
                // Parse Form Config for Dynamic Headers
                let customFields = [];
                try {
                    customFields = typeof formConfig === 'string' ? JSON.parse(formConfig) : (formConfig || []);
                } catch (e) { console.error("Config parse error", e); }

                // Build Table Header
                let headerHTML = `
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase">å§“å Name</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase">Email</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase">é›»è©± Phone</th>
                `;

                // Add Dynamic Headers
                customFields.forEach(field => {
                    headerHTML += `<th class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase">${field.label}</th>`;
                });

                headerHTML += `
                        <th class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase">ç‹€æ…‹ Status</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase">æ“ä½œ Actions</th>
                    </tr>
                `;
                thead.innerHTML = headerHTML;


                const response = await fetch(`${API_URL}?action=getRegistrations&eventId=${eventId}`); // Changed action
                const result = await response.json();

                if (result.data) { // Changed from result.success
                    currentEventRegistrations = result.data; // Save for CSV
                    renderEventParticipants(result.data, customFields);
                    loadOverview(); // Update stats
                } else {
                    tbody.innerHTML = `<tr><td colspan="${5 + customFields.length}" class="text-center py-4 text-red-500">Failed to load</td></tr>`;
                }
            } catch (error) {
                console.error("Load regs error:", error);
                tbody.innerHTML = `<tr><td colspan="100%" class="text-center py-4 text-red-500">Error loading data</td></tr>`;
            }
        }

        function renderEventParticipants(registrations, customFields) {
            const tbody = document.getElementById('registrations-list-body');
            if (registrations.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${5 + customFields.length}" class="text-center py-8 text-slate-400">ç›®å‰æ²’æœ‰å ±åè³‡æ–™ No registrations yet.</td></tr>`;
                return;
            }

            tbody.innerHTML = registrations.map(reg => {
                // Parse Custom Data
                let customData = {};
                try {
                    customData = reg.dynamic_data ? JSON.parse(reg.dynamic_data) : {}; // Changed from custom_data
                } catch (e) { console.error("Parse custom data error", e); }

                // Build Dynamic Cells
                let dynamicCells = '';
                customFields.forEach(field => {
                    const val = customData[field.label] || '-';
                    dynamicCells += `<td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${val}</td>`;
                });

                // Status Badge Colors
                let statusColor = "bg-gray-100 text-gray-800";
                if (reg.status === 'Approved') statusColor = "bg-green-100 text-green-800";
                if (reg.status === 'Rejected') statusColor = "bg-red-100 text-red-800";
                // Check-in Badge
                let checkInBadge = '';
                if (reg.check_in_status === 'CheckedIn') {
                    checkInBadge = `<span class="px-2 py-1 text-xs font-bold rounded-full uppercase tracking-wide bg-purple-100 text-purple-800 ml-1">å·²å ±åˆ° Check-in</span>`;
                }

                return `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-bold text-slate-800">${reg.participant_name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${reg.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${reg.phone || '-'}</td>
                    ${dynamicCells}
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-bold rounded-full uppercase tracking-wide ${statusColor}">
                            ${reg.status}
                        </span>
                        ${checkInBadge}
                        <div class="text-xs text-slate-400 mt-1">Payment: ${reg.payment_status}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        ${reg.status === 'Pending' ? `
                            <button onclick="updateRegStatus('${reg.reg_id}', 'Approved')" class="text-green-600 hover:text-green-900">Approve</button>
                            <button onclick="updateRegStatus('${reg.reg_id}', 'Rejected')" class="text-red-600 hover:text-red-900">Reject</button>
                        ` : ''}
                        ${reg.payment_status === 'Unpaid' ? `
                            <button onclick="updatePaymentStatus('${reg.reg_id}', 'Paid')" class="text-blue-600 hover:text-blue-900">Mark Paid</button>
                        ` : ''}
                        ${reg.qr_code_data ? `
                            <button onclick="showQRCode('${reg.qr_code_data}')" class="text-purple-600 hover:text-purple-900">QR</button>
                        ` : ''}
                    </td>
                </tr>
            `}).join('');
        }

        // --- Edit Event Submit ---
        document.getElementById('edit-event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.innerText = 'å„²å­˜ä¸­...'; btn.disabled = true;

            const payload = {
                action: 'updateEvent',
                eventId: document.getElementById('edit-evt-id').value,
                name: document.getElementById('edit-evt-name').value,
                date: document.getElementById('edit-evt-date').value,
                location: document.getElementById('edit-evt-loc').value,
                price: document.getElementById('edit-evt-price').value,
                description: document.getElementById('edit-evt-desc').value,
                status: document.getElementById('edit-evt-status').value,
                enableQr: document.getElementById('edit-evt-enable-qr').checked,
                enableCheckIn: document.getElementById('edit-evt-enable-checkin').checked,
                formConfig: customFields // Include updated custom fields
            };

            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                alert('æ›´æ–°æˆåŠŸ');
                loadEvents(); // Reload list behind modal
            } catch (e) { alert('æ›´æ–°å¤±æ•—'); }
            finally { btn.innerText = 'å„²å­˜è®Šæ›´'; btn.disabled = false; }
        });

        // --- Modal Registrations Logic ---
        // let currentRegsData = []; // This is replaced by currentEventRegistrations

        // async function loadModalRegistrations() { // This function is replaced by loadEventRegistrations
        //     if (!currentEventId) return;
        //     const body = document.getElementById('modal-reg-body');
        //     body.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center">è¼‰å…¥ä¸­...</td></tr>';

        //     try {
        //         const res = await fetch(`${API_URL}?action=getRegistrations&eventId=${currentEventId}`);
        //         const json = await res.json();

        //         if (json.data) {
        //             currentRegsData = json.data;
        //             document.getElementById('reg-count-total').innerText = json.data.length;
        //             document.getElementById('reg-count-paid').innerText = json.data.filter(r => r.payment_status === 'Paid').length;

        //             if (json.data.length > 0) {
        //                 body.innerHTML = json.data.map(r => renderModalRegRow(r)).join('');
        //             } else {
        //                 body.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">å°šç„¡å ±åè³‡æ–™</td></tr>';
        //             }
        //         }
        //     } catch (e) {
        //         body.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">è¼‰å…¥å¤±æ•—</td></tr>';
        //     }
        // }

        // function renderModalRegRow(r) { // This function is replaced by renderEventParticipants
        //     // Helpers
        //     const getStatusBtn = (curr) => {
        //         if (curr === 'Pending') return `
        //             <button onclick="updateStatus('${r.reg_id}', 'Approved')" class="text-green-600 hover:underline mr-1">æ‰¹å‡†</button>
        //             <button onclick="updateStatus('${r.reg_id}', 'Rejected')" class="text-red-600 hover:underline">æ‹’çµ•</button>
        //         `;
        //         return `<span class="text-xs px-2 py-0.5 rounded ${curr === 'Approved' ? 'bg-green-100 text-green-800' : (curr === 'Rejected' ? 'bg-red-100 text-red-800' : 'bg-yellow-100')}">${curr}</span>`;
        //     };

        //     const getPayBtn = (curr, status) => {
        //         if (status !== 'Approved') return '<span class="text-gray-300">-</span>';
        //         if (curr === 'Unpaid') return `<button onclick="updatePayment('${r.reg_id}', 'Paid')" class="text-blue-600 hover:underline font-bold">æ”¶æ¬¾</button>`;
        //         return '<span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-800 rounded">Paid</span>';
        //     };

        //     let extraInfo = '';
        //     if (r.dynamic_data) {
        //         extraInfo = '<div class="mt-1 text-xs text-gray-500">';
        //         for (const [key, val] of Object.entries(r.dynamic_data)) {
        //             extraInfo += `<span class="mr-2"><strong>${key}:</strong> ${val}</span>`;
        //         }
        //         extraInfo += '</div>';
        //     }

        //     const qrBtn = r.qr_code_data ? `<button onclick="viewQR('${r.qr_code_data}')" class="text-purple-600 text-xs hover:underline">QR</button>` : '';

        //     return `
        //         <tr>
        //             <td class="px-4 py-3 text-sm">
        //                 <div class="font-bold text-gray-900">${r.participant_name}</div>
        //                 ${extraInfo}
        //             </td>
        //             <td class="px-4 py-3 text-sm text-gray-600">
        //                 <div>${r.email}</div>
        //                 <div class="text-xs">${r.phone}</div>
        //             </td>
        //             <td class="px-4 py-3 text-sm">${getStatusBtn(r.status)}</td>
        //             <td class="px-4 py-3 text-sm">${getPayBtn(r.payment_status, r.status)}</td>
        //             <td class="px-4 py-3 text-sm text-gray-600">${r.check_in_status}</td>
        //             <td class="px-4 py-3 text-sm text-right">${qrBtn}</td>
        //         </tr>
        //     `;
        // }

        async function updateRegStatus(id, status) { // Renamed from updateStatus
            if (!confirm(`ç¢ºå®šè¦è®Šæ›´ç‹€æ…‹ç‚º ${status} ?`)) return;
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', regId: id, status: status }) });
            // Reload registrations for the current event
            const eventData = allEventsData.find(e => e.event_id === currentEditingEventId);
            if (eventData) {
                await loadEventRegistrations(currentEditingEventId, eventData.form_config);
            }
            loadOverview(); // Update stats
        }

        async function updatePaymentStatus(id, status) { // Renamed from updatePayment
            if (!confirm(`ç¢ºå®šå·²æ”¶æ¬¾? æ­¤æ“ä½œå°‡ç”¢ç”Ÿ QR Code`)) return;
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updatePayment', regId: id, paymentStatus: status }) });
            // Reload registrations for the current event
            const eventData = allEventsData.find(e => e.event_id === currentEditingEventId);
            if (eventData) {
                await loadEventRegistrations(currentEditingEventId, eventData.form_config);
            }
            loadOverview();
        }

        function showQRCode(data) { // Renamed from viewQR
            const url = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(data)}`;
            const win = window.open("", "QR Code", "width=300,height=300");
            win.document.write(`<div style="text-align:center; padding:20px;"><img src="${url}"/><br>è«‹ä¿å­˜æ­¤åœ–</div>`);
        }

        // --- CSV Export ---
        function downloadCSV() {
            if (!currentEventRegistrations || currentEventRegistrations.length === 0) {
                alert("æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º");
                return;
            }

            // Get Custom Fields Config
            const eventData = allEventsData.find(e => e.event_id === currentEditingEventId);
            let customFields = [];
            if (eventData && eventData.form_config) {
                try {
                    customFields = typeof eventData.form_config === 'string' ? JSON.parse(eventData.form_config) : eventData.form_config;
                } catch (e) { }
            }

            // Headers
            const headers = ['å§“å', 'Email', 'é›»è©±', ...customFields.map(f => f.label), 'ç‹€æ…‹', 'ä»˜æ¬¾ç‹€æ…‹', 'å ±åˆ°ç‹€æ…‹'];
            const csvRows = [headers.join(',')];

            // Rows
            for (const row of currentEventRegistrations) {
                let customData = {};
                try {
                    customData = row.dynamic_data ? JSON.parse(row.dynamic_data) : {};
                } catch (e) { }

                const dynamicValues = customFields.map(f => {
                    const val = customData[f.label] || '';
                    return `"${val.replace(/"/g, '""')}"`; // Escape quotes
                });

                const values = [
                    `"${row.participant_name}"`,
                    `"${row.email}"`,
                    `"${row.phone || ''}"`,
                    ...dynamicValues,
                    `"${row.status}"`,
                    `"${row.payment_status}"`,
                    `"${row.check_in_status || 'Not Checked In'}"`
                ];
                csvRows.push(values.join(','));
            }

            const blob = new Blob(["\uFEFF" + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `registrations_${currentEditingEventId}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }



        // --- View Navigation ---
        function switchView(viewName) {
            // Hide all views
            ['dashboard', 'create-event', 'accounts'].forEach(v => {
                const el = document.getElementById(`view-${v}`);
                if (el) el.classList.add('hidden');
            });

            // Show selected view
            const target = document.getElementById(`view-${viewName}`);
            if (target) {
                target.classList.remove('hidden');
                if (viewName === 'accounts') loadUsers();
            }
        }

        // --- Account Management Logic ---
        async function loadUsers() {
            const body = document.getElementById('users-list-body');
            body.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center"><i class="fas fa-spinner fa-spin mr-2"></i>è¼‰å…¥ä¸­...</td></tr>';

            try {
                const res = await fetch(`${API_URL}?action=getUsers`);
                const json = await res.json();

                if (json.status === 'success' && json.data.length) {
                    body.innerHTML = json.data.map(u => `
                        <tr class="hover:bg-slate-50">
                            <td class="px-6 py-4 font-medium text-slate-800">${u.username}</td>
                            <td class="px-6 py-4 text-slate-600">${u.name}</td>
                            <td class="px-6 py-4"><span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-bold">${u.role}</span></td>
                            <td class="px-6 py-4">
                                ${u.username === 'admin' ? '<span class="text-xs text-slate-400">ç³»çµ±é è¨­</span>' :
                            `<button onclick="deleteUser('${u.sys_id}')" class="text-red-500 hover:text-red-700 text-sm">åˆªé™¤</button>`}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    body.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center">ç„¡å¸³è™Ÿè³‡æ–™</td></tr>';
                }
            } catch (e) {
                console.error(e);
                body.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }

        function openCreateUserModal() {
            playAudio('popup');
            document.getElementById('create-user-modal').classList.remove('hidden');
        }

        async function deleteUser(sysId) {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å¸³è™Ÿï¼Ÿ")) return;
            try {
                await setLoading(true); // Global loading if desired, or simpler btn logic
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteUser', sysId: sysId }) });
                const json = await res.json();
                if (json.status === 'success') {
                    loadUsers();
                } else {
                    alert(json.message);
                }
            } catch (e) {
                alert("åˆªé™¤å¤±æ•—");
            } finally {
                setLoading(false);
            }
        }

        // Ensure create user form works
        document.getElementById('create-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>è™•ç†ä¸­...';

            try {
                const payload = {
                    action: 'createUser',
                    username: document.getElementById('new-u-username').value,
                    password: document.getElementById('new-u-password').value,
                    name: document.getElementById('new-u-name').value,
                    role: document.getElementById('new-u-role').value
                };

                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();

                if (json.status === 'success') {
                    document.getElementById('create-user-modal').classList.add('hidden');
                    e.target.reset();
                    loadUsers();
                } else {
                    alert(json.message);
                }
            } catch (err) {
                alert('éŒ¯èª¤');
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        });


        // --- Tab Logic ---
        function switchModalTab(tab) {
            // UI Classes
            const activeClass = "border-b-2 border-blue-600 text-blue-600";
            const inactiveClass = "text-gray-500 hover:text-gray-700";

            // Reset buttons
            ['info', 'regs', 'checkin'].forEach(t => {
                const btn = document.getElementById(`mtab-${t}`);
                if (btn) btn.className = `py-3 text-sm font-medium transition-colors ${t === tab ? activeClass : inactiveClass}`;
            });

            // Toggle Content
            document.getElementById('mview-info').classList.toggle('hidden', tab !== 'info');
            document.getElementById('mview-regs').classList.toggle('hidden', tab !== 'regs');
            const checkinView = document.getElementById('mview-checkin');
            if (checkinView) checkinView.classList.toggle('hidden', tab !== 'checkin');

            // Logic Hooks
            if (tab === 'regs') {
                // loadModalRegistrations(); // This function is replaced by loadEventRegistrations
            }

            // Console Scanner Hook
            if (tab === 'checkin') {
                loadOverview(); // Update stats
                updateConsoleStats(); // UPDATE STATS
                // startConsoleScanner(); // Auto-start removed
            } else {
                stopConsoleScanner(); // Stop Scanner to save resources
            }
        }

        // --- Check-in Console Logic ---
        function updateConsoleStats() {
            if (!currentEventRegistrations) return;

            const total = currentEventRegistrations.length;
            const checkedIn = currentEventRegistrations.filter(r => r.check_in_status === 'CheckedIn').length;
            const unchecked = total - checkedIn;
            const rate = total > 0 ? Math.round((checkedIn / total) * 100) : 0;

            // Animate Numbers
            animateValue("console-total", parseInt(document.getElementById("console-total").innerText) || 0, total, 500);
            animateValue("console-checked-in", parseInt(document.getElementById("console-checked-in").innerText) || 0, checkedIn, 500);
            animateValue("console-unchecked", parseInt(document.getElementById("console-unchecked").innerText) || 0, unchecked, 500);
            document.getElementById("console-rate").innerText = `${rate}%`;
        }

        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            const obj = document.getElementById(id);
            if (!obj) return;

            const timer = setInterval(() => {
                current += increment;
                obj.innerText = current;
                if (current == end) { clearInterval(timer); }
            }, Math.max(stepTime, 20)); // Min 20ms per frame
        }

        // --- Scanner Logic (Refactored for Console) ---
        let html5QrcodeScanner;
        let mainHtml5QrcodeScanner; // For the main scanner tab

        function startConsoleScanner() {
            if (html5QrcodeScanner) {
                // Already running?
                return;
            }

            const readerId = "console-reader";
            if (!document.getElementById(readerId)) return;

            if (typeof Html5Qrcode === 'undefined') {
                console.warn("Html5Qrcode library not loaded. Scanner disabled.");
                document.getElementById(readerId).innerHTML = '<div class="text-white text-center p-4">ç„¡æ³•è¼‰å…¥æƒæå…ƒä»¶ (Library Missing)</div>';
                return;
            }

            html5QrcodeScanner = new Html5Qrcode(readerId);

            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            html5QrcodeScanner.start({ facingMode: "environment" }, config, async (decodedText) => {
                // Success
                if (window.isScanning) return; // Debounce
                window.isScanning = true;

                // UI Feedback
                document.getElementById('console-scan-status').classList.remove('hidden');

                try {
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'checkIn', qrCodeData: decodedText })
                    });
                    const json = await res.json();

                    if (json.status === 'success') {
                        playAudio('success');
                        logConsoleActivity(json.participant, 'success');

                        // Update Data
                        await refreshCurrentEventData(); // Reload regs
                        updateConsoleStats(); // Update UI

                        showScannerResult(json.participant, 'å·²å®Œæˆå ±åˆ° (Checked In)', 'success');
                    } else {
                        playAudio('error');
                        logConsoleActivity('æœªçŸ¥ç”¨æˆ¶', 'error', json.message);
                        showScannerResult('éŒ¯èª¤ (Error)', json.message, 'error');
                    }
                } catch (e) {
                    console.error(e);
                    playAudio('error');
                    showScannerResult('ç³»çµ±éŒ¯èª¤', 'ç„¡æ³•é€£æ¥ä¼ºæœå™¨', 'error');
                } finally {
                    document.getElementById('console-scan-status').classList.add('hidden');
                    setTimeout(() => { window.isScanning = false; }, 2000); // Cooldown
                }
            }).then(() => {
                // Started
                document.getElementById('scanner-blocked-overlay').classList.add('hidden');
                document.getElementById('btn-stop-scanner').classList.remove('hidden');
            }).catch(err => {
                console.error("Scanner Error", err);
                document.getElementById(readerId).innerHTML = `<div class="text-white text-center p-4">ç„¡æ³•å•Ÿå‹•é¡é ­<br>${err}</div>`;
            });
        }

        function stopConsoleScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    html5QrcodeScanner = null;
                    document.getElementById('scanner-blocked-overlay').classList.remove('hidden');
                    document.getElementById('btn-stop-scanner').classList.add('hidden');
                }).catch(err => console.error("Failed to stop scanner", err));
            }
        }

        function startScanner() {
            if (mainHtml5QrcodeScanner) {
                return;
            }

            const readerId = "reader";
            if (!document.getElementById(readerId)) return;

            if (typeof Html5Qrcode === 'undefined') {
                console.warn("Html5Qrcode library not loaded. Scanner disabled.");
                document.getElementById(readerId).innerHTML = '<div class="text-white text-center p-4">ç„¡æ³•è¼‰å…¥æƒæå…ƒä»¶ (Library Missing)</div>';
                return;
            }

            mainHtml5QrcodeScanner = new Html5Qrcode(readerId);
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            mainHtml5QrcodeScanner.start({ facingMode: "environment" }, config, async (decodedText) => {
                // Success
                document.getElementById('scan-result').innerText = `æƒæçµæœ: ${decodedText}`;
                // You can add further processing here, e.g., API call for check-in
            }).then(() => {
                document.getElementById('main-scanner-overlay').classList.add('hidden');
                document.getElementById('btn-stop-main-scanner').classList.remove('hidden');
            }).catch(err => {
                console.error("Main Scanner Error", err);
                document.getElementById(readerId).innerHTML = `<div class="text-white text-center p-4">ç„¡æ³•å•Ÿå‹•é¡é ­<br>${err}</div>`;
            });
        }

        function stopScanner() {
            if (mainHtml5QrcodeScanner) {
                mainHtml5QrcodeScanner.stop().then(() => {
                    mainHtml5QrcodeScanner.clear();
                    mainHtml5QrcodeScanner = null;
                    document.getElementById('main-scanner-overlay').classList.remove('hidden');
                    document.getElementById('btn-stop-main-scanner').classList.add('hidden');
                    document.getElementById('scan-result').innerText = '';
                }).catch(err => console.error("Failed to stop main scanner", err));
            }
        }

        function logConsoleActivity(name, type, msg = '') {
            const logContainer = document.getElementById('console-activity-log');
            if (logContainer.children[0]?.innerText === 'æš«ç„¡å ±åˆ°ç´€éŒ„') logContainer.innerHTML = '';

            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            if (type === 'success') {
                div.className = "flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-100 animate__animated animate__fadeInLeft";
                div.innerHTML = `
                    <div class="flex items-center">
                        <div class="bg-green-500 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">âœ“</div>
                        <div>
                            <div class="font-bold text-slate-800">${name}</div>
                            <div class="text-xs text-green-600">å·²å ±åˆ°</div>
                        </div>
                    </div>
                    <div class="text-xs text-slate-400 font-mono">${time}</div>
                `;
            } else {
                div.className = "flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-100 animate__animated animate__fadeInLeft";
                div.innerHTML = `
                    <div class="flex items-center">
                        <div class="bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">!</div>
                        <div>
                            <div class="font-bold text-slate-800">${name || 'æƒæéŒ¯èª¤'}</div>
                            <div class="text-xs text-red-600">${msg}</div>
                        </div>
                    </div>
                    <div class="text-xs text-slate-400 font-mono">${time}</div>
                `;
            }

            logContainer.prepend(div);
        }

        async function refreshCurrentEventData() {
            // Helper to silently reload data
            if (currentEditingEventId) {
                const event = allEventsData.find(e => e.event_id === currentEditingEventId);
                await loadEventRegistrations(currentEditingEventId, event.form_config);
            }
        }


        // --- NEW FEATURES ---

        // Audio
        // Audio - Premium Sounds
        const audioSuccess = new Audio('https://actions.google.com/sounds/v1/science_fiction/scifi_input_accept.ogg');
        const audioError = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
        const audioClick = new Audio('https://actions.google.com/sounds/v1/ui/click_on_light.ogg'); // Light click
        const audioPopup = new Audio('https://actions.google.com/sounds/v1/cartoon/pop.ogg'); // Pop sound

        function playAudio(type) {
            try {
                if (type === 'success') audioSuccess.play().catch(console.error);
                else if (type === 'error') audioError.play().catch(console.error);
                else if (type === 'click') {
                    audioClick.currentTime = 0;
                    audioClick.play().catch(console.error);
                }
                else if (type === 'popup') {
                    audioPopup.currentTime = 0;
                    audioPopup.play().catch(console.error);
                }
            } catch (e) {
                console.warn("Audio play failed", e);
            }
        }

        // Global Click Listener for Sound
        document.addEventListener('click', (e) => {
            // Check if clicked element is interactive
            if (e.target.matches('button, a, input[type="checkbox"], input[type="radio"], select') ||
                e.target.closest('button, a, .clickable')) {
                playAudio('click');
            }
        });

        // Scanner Modal
        function showScannerResult(title, message, type) {
            const overlay = document.createElement('div');
            overlay.className = "fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[60] animate__animated animate__zoomIn";
            overlay.onclick = () => overlay.remove();

            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const icon = type === 'success' ? 'âœ…' : 'âŒ';

            overlay.innerHTML = `
                <div class="${bgColor} text-white p-10 rounded-3xl shadow-2xl text-center max-w-sm w-full mx-4">
                    <div class="text-6xl mb-4">${icon}</div>
                    <h2 class="text-4xl font-bold mb-4">${title}</h2>
                    <p class="text-2xl opacity-90">${message}</p>
                    <div class="mt-8 text-sm opacity-70">é»æ“Šä»»æ„è™•é—œé–‰</div>
                </div>
            `;
            document.body.appendChild(overlay);
            setTimeout(() => { if (overlay.parentNode) overlay.remove(); }, 3000);
        }

        // Repair DB
        async function repairDatabase() {
            if (!confirm("ç¢ºå®šè¦åŸ·è¡Œè³‡æ–™åº«æ¬„ä½ä¿®å¾©ï¼Ÿ(å»ºè­°åœ¨ç™¼ç¾è³‡æ–™ç•°å¸¸æ™‚åŸ·è¡Œ)")) return;
            const btn = document.querySelector('button[onclick="repairDatabase()"]');
            const originalText = btn.innerText;
            btn.innerText = "ä¿®å¾©ä¸­..."; btn.disabled = true;
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'fixHeaders' }) });
                const json = await res.json();
                alert(json.message);
            } catch (e) { alert("ä¿®å¾©å¤±æ•—"); console.error(e); }
            finally { btn.innerText = originalText; btn.disabled = false; }
        }

        // Stats Overview
        function loadOverview() {
            const total = currentEventRegistrations.length;
            const checkedIn = currentEventRegistrations.filter(r => r.check_in_status === 'CheckedIn').length;
            const rate = total > 0 ? Math.round((checkedIn / total) * 100) : 0;

            if (document.getElementById('stat-total')) document.getElementById('stat-total').innerText = total;
            if (document.getElementById('stat-checked-in')) document.getElementById('stat-checked-in').innerText = checkedIn;
            if (document.getElementById('stat-rate')) document.getElementById('stat-rate').innerText = `${rate}%`;
        }

        function loadModalRegistrations() {
            refreshCurrentEventData();
        }
    </script>
</body>

</html>